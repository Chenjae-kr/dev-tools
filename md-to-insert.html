<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdown → INSERT SQL | Dev Tools</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<script src="nav.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<script>renderNav();</script>

<div class="container">
  <!-- Tool Header -->
  <div class="tool-header">
    <h1>Markdown Table <span>→</span> INSERT SQL</h1>
    <p>// paste markdown table and generate INSERT queries instantly</p>
  </div>

  <div class="main-grid">
    <!-- LEFT: Input Panel -->
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot"></div>
            MARKDOWN TABLE INPUT
          </div>
        </div>

        <!-- Table Name -->
        <div class="options-bar">
          <span class="options-label">Table</span>
          <input type="text" id="tableName" class="table-name-input" placeholder="table_name">
        </div>

        <textarea class="md-textarea" id="mdInput" placeholder="| user_id | username | age | email               | is_active |
|---------|----------|-----|---------------------|-----------|
| 1       | alice    | 30  | alice@example.com   | true      |
| 2       | bob      | 25  | bob@example.com     | false     |
| 3       | charlie  |     | charlie@example.com | true      |"></textarea>

        <!-- Dialect -->
        <div class="options-bar">
          <span class="options-label">Dialect</span>
          <div class="dialect-group">
            <button class="dialect-btn active" data-dialect="mysql">MySQL</button>
            <button class="dialect-btn" data-dialect="oracle">Oracle</button>
            <button class="dialect-btn" data-dialect="postgresql">PostgreSQL</button>
          </div>
        </div>

        <!-- Mode + NULL -->
        <div class="options-bar" style="border-top:none; padding-top:0;">
          <span class="options-label">Mode</span>
          <div class="toggle-group">
            <button class="toggle-btn active" data-mode="individual">Individual</button>
            <button class="toggle-btn" data-mode="bulk">Bulk</button>
          </div>
          <span class="options-label">Empty값</span>
          <div class="toggle-group">
            <button class="toggle-btn null-btn active" data-null="null">NULL</button>
            <button class="toggle-btn null-btn" data-null="empty">''</button>
          </div>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generate()">
          ⚡ INSERT 생성
        </button>
      </div>
    </div>

    <!-- RIGHT: Output Panel -->
    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="empty-state">
          <div class="icon">⬅</div>
          <p>마크다운 테이블을 입력하고<br>INSERT 생성 버튼을 누르세요</p>
        </div>
      </div>
    </div>
  </div>

  <footer>// MD → INSERT Generator — supports MySQL · Oracle · PostgreSQL</footer>
</div>

<script>
// ─── State ───────────────────────────────────────────────
let selectedDialect = 'mysql';
let insertMode = 'individual';
let nullMode = 'null';

// ─── Dialect toggle ──────────────────────────────────────
document.querySelectorAll('.dialect-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.dialect-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedDialect = btn.dataset.dialect;
  });
});

// ─── Mode toggle ─────────────────────────────────────────
document.querySelectorAll('[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    insertMode = btn.dataset.mode;
  });
});

// ─── NULL mode toggle ────────────────────────────────────
document.querySelectorAll('.null-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.null-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    nullMode = btn.dataset.null;
  });
});

// ─── Markdown Table Parser ───────────────────────────────
function isSeparatorRow(line) {
  // e.g. |---|:---|:---:| 형태
  return /^[\s|:\-]+$/.test(line);
}

function parseRow(line) {
  // 양쪽 | 제거 후 | 로 분리
  return line.replace(/^\s*\||\|\s*$/g, '').split('|').map(c => c.trim());
}

function parseMarkdownTable(md) {
  const lines = md.split('\n')
    .map(l => l.trim())
    .filter(l => l.includes('|'));

  if (lines.length < 2) {
    throw new Error('마크다운 테이블 형식이 올바르지 않습니다.\n헤더 행과 데이터 행이 최소 1개씩 필요합니다.');
  }

  // 첫 번째 비-separator 행 = 헤더
  let headerIdx = -1;
  for (let i = 0; i < lines.length; i++) {
    if (!isSeparatorRow(lines[i])) { headerIdx = i; break; }
  }
  if (headerIdx === -1) throw new Error('헤더 행을 찾을 수 없습니다.');

  const headers = parseRow(lines[headerIdx]).filter(h => h.length > 0);
  if (headers.length === 0) throw new Error('유효한 컬럼 헤더가 없습니다.');

  // 헤더 이후 줄에서 separator 제외 = 데이터 행
  const dataLines = lines.slice(headerIdx + 1).filter(l => !isSeparatorRow(l));
  if (dataLines.length === 0) throw new Error('데이터 행이 없습니다.');

  const rows = dataLines.map(l => {
    const cells = parseRow(l);
    // 컬럼 수에 맞춰 padding / trim
    const result = [];
    for (let i = 0; i < headers.length; i++) {
      result.push(cells[i] !== undefined ? cells[i] : '');
    }
    return result;
  });

  return { headers, rows };
}

// ─── Identifier Quoting ──────────────────────────────────
function quoteIdent(name, dialect) {
  if (dialect === 'mysql') return `\`${name}\``;
  if (dialect === 'oracle') return name.toUpperCase();
  return `"${name}"`;  // postgresql
}

// ─── Value Formatter (with syntax highlight HTML) ────────
function formatValue(val, dialect, useNull) {
  // 명시적 NULL 키워드
  if (/^(null|NULL|Null|\\N)$/.test(val)) {
    return `<span class="kw">NULL</span>`;
  }
  // 빈 값
  if (val === '') {
    return useNull
      ? `<span class="kw">NULL</span>`
      : `<span class="ph">''</span>`;
  }
  // 정수
  if (/^-?\d+$/.test(val)) return `<span class="val">${val}</span>`;
  // 실수
  if (/^-?\d+\.\d+([eE][+-]?\d+)?$/.test(val)) return `<span class="val">${val}</span>`;
  // 불리언
  if (/^true$/i.test(val)) {
    return dialect === 'postgresql'
      ? `<span class="kw">TRUE</span>`
      : `<span class="val">1</span>`;
  }
  if (/^false$/i.test(val)) {
    return dialect === 'postgresql'
      ? `<span class="kw">FALSE</span>`
      : `<span class="val">0</span>`;
  }
  // 문자열 — 홑따옴표 이스케이프
  const escaped = val.replace(/'/g, "''");
  return `<span class="ph">'${escaped}'</span>`;
}

// ─── Main Generate ────────────────────────────────────────
function generate() {
  const md = document.getElementById('mdInput').value.trim();
  const tableName = document.getElementById('tableName').value.trim() || 'my_table';
  const output = document.getElementById('outputPanel');
  const btn = document.getElementById('generateBtn');

  if (!md) {
    output.innerHTML = `<div class="error-msg">⚠ 마크다운 테이블을 입력해주세요.</div>`;
    return;
  }

  btn.textContent = '⏳ 생성 중...';
  btn.classList.add('loading');

  setTimeout(() => {
    try {
      const { headers, rows } = parseMarkdownTable(md);
      const useNull = nullMode === 'null';

      const tbl = quoteIdent(tableName, selectedDialect);
      const colsHtml = headers.map(h =>
        `<span class="col">${quoteIdent(h, selectedDialect)}</span>`
      );

      const dialectLabel = { mysql: 'MySQL', oracle: 'Oracle', postgresql: 'PostgreSQL' };

      let sqlHtml = '';

      if (insertMode === 'bulk') {
        // ── Bulk INSERT ──────────────────────────────────
        sqlHtml += `<span class="cmt">-- Bulk INSERT: ${tableName}에 ${rows.length}행 삽입</span>\n`;
        sqlHtml += `<span class="kw">INSERT INTO</span> <span class="tbl">${tbl}</span> (\n`;
        sqlHtml += `    ${colsHtml.join(',\n    ')}\n`;
        sqlHtml += `)\n<span class="kw">VALUES</span>\n`;

        rows.forEach((row, i) => {
          const vals = row.map(v => formatValue(v, selectedDialect, useNull));
          const isLast = i === rows.length - 1;
          sqlHtml += `    (${vals.join(', ')})${isLast ? ';' : ','}`;
          if (!isLast) sqlHtml += `  <span class="cmt">-- row ${i + 1}</span>`;
          sqlHtml += '\n';
        });

      } else {
        // ── Individual INSERTs ───────────────────────────
        rows.forEach((row, i) => {
          if (i > 0) sqlHtml += '\n\n';
          sqlHtml += `<span class="cmt">-- Row ${i + 1}</span>\n`;
          sqlHtml += `<span class="kw">INSERT INTO</span> <span class="tbl">${tbl}</span> (\n`;
          sqlHtml += `    ${colsHtml.join(',\n    ')}\n`;
          sqlHtml += `)\n<span class="kw">VALUES</span> (\n`;
          const vals = row.map((v, j) =>
            `    ${formatValue(v, selectedDialect, useNull)} <span class="cmt">-- ${headers[j]}</span>`
          );
          sqlHtml += vals.join(',\n') + '\n);';
        });
      }

      const blockId = `block_md_${Date.now()}`;
      const html = `
        <div class="panel sql-block">
          <div class="sql-block-header">
            <span class="sql-type-badge badge-insert">INSERT</span>
            <span class="sql-dialect-tag">${dialectLabel[selectedDialect]} · ${insertMode} · ${rows.length} rows</span>
            <button class="copy-btn" id="copy_${blockId}" onclick="copySQL('${blockId}')">COPY ALL</button>
          </div>
          <div class="table-info">
            <span>TABLE</span> ${tableName}
            <span style="margin-left:8px">COLUMNS</span> ${headers.length}
            <span style="margin-left:8px">ROWS</span> ${rows.length}
          </div>
          <pre class="sql-code" id="${blockId}">${sqlHtml}</pre>
        </div>`;

      output.innerHTML = html;

    } catch (e) {
      output.innerHTML = `<div class="error-msg">❌ 파싱 오류\n${e.message}</div>`;
    }

    btn.textContent = '⚡ INSERT 생성';
    btn.classList.remove('loading');
  }, 200);
}

function copySQL(id) {
  const el = document.getElementById(id);
  const rawText = el.innerText || el.textContent;
  navigator.clipboard.writeText(rawText).then(() => {
    const btn = document.getElementById(`copy_${id}`);
    btn.textContent = '✓ COPIED';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'COPY ALL'; btn.classList.remove('copied'); }, 1500);
  });
}

// Ctrl/Cmd + Enter to generate
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate();
});
</script>
</body>
</html>
