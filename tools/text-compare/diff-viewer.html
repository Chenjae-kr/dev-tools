<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diff Viewer | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../ui-utils.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.diff-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
@media (max-width: 900px) { .diff-grid { grid-template-columns: 1fr; } }

.diff-textarea {
  width: 100%;
  min-height: 280px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.6;
  padding: 12px;
  resize: vertical;
  box-sizing: border-box;
  outline: none;
  transition: border-color .2s;
}
.diff-textarea:focus { border-color: var(--accent); }
.diff-panel-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .08em;
  color: var(--text-muted);
  margin-bottom: 6px;
  font-family: 'JetBrains Mono', monospace;
}

/* Diff output */
.diff-line {
  display: flex;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.6;
  white-space: pre;
}
.diff-line-num {
  min-width: 48px;
  color: var(--text-muted);
  text-align: right;
  padding-right: 12px;
  user-select: none;
  border-right: 1px solid var(--border);
  margin-right: 12px;
  flex-shrink: 0;
}
.diff-line-content { flex: 1; overflow-x: auto; }
.diff-add  { background: color-mix(in srgb, #4fffb0 10%, transparent); color: #4fffb0; }
.diff-add .diff-line-num  { color: #4fffb0; opacity: .6; }
.diff-del  { background: color-mix(in srgb, #ff6a6a 10%, transparent); color: #ff6a6a; }
.diff-del .diff-line-num  { color: #ff6a6a; opacity: .6; }
.diff-ctx  { color: var(--text-dim); }
.diff-hunk {
  background: color-mix(in srgb, var(--accent2) 8%, transparent);
  color: var(--accent2);
  padding: 2px 12px;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  margin: 4px 0;
  border-left: 3px solid var(--accent2);
}
.diff-empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
}
.diff-summary {
  display: flex;
  gap: 16px;
  padding: 8px 12px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  color: var(--text-muted);
  flex-wrap: wrap;
}
.diff-summary .add-count { color: #4fffb0; font-weight: 700; }
.diff-summary .del-count { color: #ff6a6a; font-weight: 700; }
.diff-output-wrap {
  overflow-x: auto;
  overflow-y: auto;
  max-height: 600px;
}
.diff-identical {
  text-align: center;
  padding: 40px 20px;
  color: var(--accent);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
}
.inline-add{background:rgba(79,255,176,.25);border-radius:3px}
.inline-del{background:rgba(255,106,106,.25);border-radius:3px}
.split-row{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:12px}
.split-cell{padding:6px 10px;white-space:pre;overflow:auto}
.split-old{border-right:1px solid var(--border)}
.change-line.active-change{outline:1px solid var(--accent);box-shadow:inset 0 0 0 1px rgba(79,255,176,.25)}
.change-nav{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 10px}
.change-nav .toggle-btn{padding:4px 8px;min-height:28px;font-size:10px}
</style>
</head>
<body>

<script>renderNav();</script>

<div class="container">
  <div class="tool-header">
    <h1>Diff <span>Viewer</span></h1>
    <p>// 텍스트/JSON 변경 사항 비교 + unified patch 복사</p>
  </div>

  <!-- Input area: two side-by-side textareas -->
  <div class="panel mb-16">
    <div class="panel-header">
      <div class="panel-title"><div class="dot"></div>INPUT</div>
      <button class="sample-btn" onclick="loadSample()">예시 불러오기</button>
    </div>
    <div class="diff-grid">
      <div>
        <div class="diff-panel-label">◀ 원본 (ORIGINAL)</div>
        <textarea class="diff-textarea" id="originalInput" placeholder="원본 텍스트를 여기에 붙여넣으세요..."></textarea>
      </div>
      <div>
        <div class="diff-panel-label">▶ 변경 (MODIFIED)</div>
        <textarea class="diff-textarea" id="modifiedInput" placeholder="변경된 텍스트를 여기에 붙여넣으세요..."></textarea>
      </div>
    </div>

    <div class="setting-group" data-level="basic">
      <div class="setting-title">View & Compare</div>
      <div class="options-bar">
        <span class="options-label">Mode</span>
        <div class="toggle-group">
          <button class="toggle-btn active" data-mode="text">Text</button>
          <button class="toggle-btn" data-mode="json">JSON</button>
        </div>
        <span class="options-label">View</span>
        <div class="toggle-group">
          <button class="toggle-btn active" data-view="unified">Unified</button>
          <button class="toggle-btn" data-view="split">Split</button>
        </div>
        <span class="options-label">Context</span>
        <div class="toggle-group">
          <button class="toggle-btn" data-ctx="0">없음</button>
          <button class="toggle-btn active" data-ctx="3">3줄</button>
          <button class="toggle-btn" data-ctx="5">5줄</button>
          <button class="toggle-btn" data-ctx="-1">전체</button>
        </div>
      </div>
      <div class="options-bar">
        <span class="options-label">무시</span>
        <div class="toggle-group">
          <button class="toggle-btn active" data-trim="on">공백 무시</button>
          <button class="toggle-btn" data-trim="off">공백 포함</button>
        </div>
        <span class="options-label">옵션</span>
        <div class="toggle-group">
          <button class="toggle-btn opt-case" data-case="off">대소문자 구분</button>
          <button class="toggle-btn opt-case active" data-case="on">대소문자 무시</button>
          <button class="toggle-btn opt-blank" data-blank="off">빈 줄 포함</button>
          <button class="toggle-btn opt-blank active" data-blank="on">빈 줄 무시</button>
        </div>
        <span class="options-label">변경 이동</span>
        <div class="toggle-group">
          <button class="toggle-btn" onclick="jumpChange(-1)">이전</button>
          <button class="toggle-btn" onclick="jumpChange(1)">다음</button>
        </div>
      </div>
      <div class="options-bar row-tight">
        <span class="options-label">파일</span>
        <input id="origFile" type="file" accept=".txt,.json,.md,.csv,text/plain,application/json">
        <input id="modFile" type="file" accept=".txt,.json,.md,.csv,text/plain,application/json">
      </div>
    </div>

    <button class="generate-btn" id="diffBtn" onclick="runDiff()">
      ⚡ 비교하기
    </button>
    <p class="kb-hint"><kbd>Ctrl</kbd> + <kbd>Enter</kbd></p>
  </div>

  <!-- Output -->
  <div id="outputPanel">
    <div class="panel">
      <div class="diff-empty">
        <div class="icon-xl">↕</div>
        원본과 변경 텍스트를 입력하고 비교하기 버튼을 누르세요
      </div>
    </div>
  </div>

  <footer>// Diff Viewer — line-by-line text comparison</footer>
</div>

<script>
// ─── State ───────────────────────────────────────────────
let contextLines = 3;
let trimWhitespace = true;
let ignoreCase = true;
let ignoreBlank = true;
let diffMode = 'text';
let viewMode = 'unified';
let lastPatchText = '';
let lastOps = [];
let changeCursor = -1;

document.querySelectorAll('[data-ctx]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-ctx]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    contextLines = parseInt(btn.dataset.ctx);
  });
});

document.querySelectorAll('[data-trim]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-trim]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    trimWhitespace = btn.dataset.trim === 'on';
  });
});

document.querySelectorAll('[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    diffMode = btn.dataset.mode;
  });
});

document.querySelectorAll('[data-view]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    viewMode = btn.dataset.view;
  });
});

document.querySelectorAll('.opt-case').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.opt-case').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ignoreCase = btn.dataset.case === 'on';
}));
document.querySelectorAll('.opt-blank').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.opt-blank').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ignoreBlank = btn.dataset.blank === 'on';
}));

function bindFileInput(id, targetId){
  document.getElementById(id).addEventListener('change', e => {
    const f = e.target.files?.[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev => { document.getElementById(targetId).value = ev.target.result || ''; };
    r.readAsText(f, 'utf-8');
  });
}
bindFileInput('origFile','originalInput');
bindFileInput('modFile','modifiedInput');

// ─── LCS-based Line Diff ──────────────────────────────────
function computeLCS(a, b) {
  const m = a.length, n = b.length;
  // Use Myers diff for efficiency — simplified two-array DP
  const dp = Array.from({ length: m + 1 }, () => new Uint32Array(n + 1));
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = a[i - 1] === b[j - 1] ? dp[i - 1][j - 1] + 1 : Math.max(dp[i - 1][j], dp[i][j - 1]);
    }
  }
  // Backtrack
  const ops = []; // 'eq' | 'add' | 'del'
  let i = m, j = n;
  while (i > 0 || j > 0) {
    if (i > 0 && j > 0 && a[i - 1] === b[j - 1]) {
      ops.push({ type: 'eq', val: a[i - 1] }); i--; j--;
    } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
      ops.push({ type: 'add', val: b[j - 1] }); j--;
    } else {
      ops.push({ type: 'del', val: a[i - 1] }); i--;
    }
  }
  return ops.reverse();
}

// ─── Render diff HTML ─────────────────────────────────────
const escHtml = UIUtils.escHtml;

function renderDiff(ops, ctx) {
  // Assign line numbers
  let oldLine = 1, newLine = 1;
  const lines = ops.map(op => {
    const o = { ...op };
    if (op.type === 'eq')  { o.oldN = oldLine++; o.newN = newLine++; }
    if (op.type === 'del') { o.oldN = oldLine++;  o.newN = null; }
    if (op.type === 'add') { o.oldN = null; o.newN = newLine++; }
    return o;
  });

  let html = '';
  let addCount = 0, delCount = 0;
  attachPairs(lines);

  if (ctx === -1) {
    // Show everything
    lines.forEach(l => {
      if (l.type === 'add') addCount++;
      if (l.type === 'del') delCount++;
      html += renderLine(l);
    });
  } else {
    // Only show changed lines ± context
    const changed = new Set();
    lines.forEach((l, i) => { if (l.type !== 'eq') changed.add(i); });

    const visible = new Set();
    changed.forEach(i => {
      for (let k = Math.max(0, i - ctx); k <= Math.min(lines.length - 1, i + ctx); k++) {
        visible.add(k);
      }
    });

    let lastVisible = -1;
    const sorted = [...visible].sort((a, b) => a - b);
    sorted.forEach(i => {
      if (lastVisible !== -1 && i > lastVisible + 1) {
        html += `<div class="diff-hunk">@@ skipped ${i - lastVisible - 1} lines @@</div>`;
      }
      const l = lines[i];
      if (l.type === 'add') addCount++;
      if (l.type === 'del') delCount++;
      html += renderLine(l);
      lastVisible = i;
    });
  }

  return { html, addCount, delCount };
}

function highlightInline(oldStr, newStr, type) {
  if (oldStr == null || newStr == null) return escHtml(type === 'add' ? newStr : oldStr);
  let s = 0;
  const a = oldStr, b = newStr;
  while (s < a.length && s < b.length && a[s] === b[s]) s++;
  let ea = a.length - 1, eb = b.length - 1;
  while (ea >= s && eb >= s && a[ea] === b[eb]) { ea--; eb--; }
  const src = type === 'add' ? b : a;
  const e1 = type === 'add' ? s : s;
  const e2 = type === 'add' ? eb : ea;
  const pre = escHtml(src.slice(0, e1));
  const mid = escHtml(src.slice(e1, e2 + 1));
  const suf = escHtml(src.slice(e2 + 1));
  const cls = type === 'add' ? 'inline-add' : 'inline-del';
  return mid ? `${pre}<span class="${cls}">${mid}</span>${suf}` : escHtml(src);
}

function renderLine(l) {
  const sign    = l.type === 'add' ? '+' : l.type === 'del' ? '−' : ' ';
  const cls     = l.type === 'add' ? 'diff-add' : l.type === 'del' ? 'diff-del' : 'diff-ctx';
  const oldNum  = l.oldN != null ? String(l.oldN) : '';
  const newNum  = l.newN != null ? String(l.newN) : '';
  const numStr  = `${oldNum.padStart(4,' ')} ${newNum.padStart(4,' ')}`;
  const body = (l.type === 'add' || l.type === 'del') && l.pair != null
    ? highlightInline(l.type === 'del' ? l.val : l.pair, l.type === 'add' ? l.val : l.pair, l.type)
    : escHtml(l.val);
  const marker = l.type === 'add' || l.type === 'del' ? 'change-line' : '';
  return `<div class="diff-line ${cls} ${marker}"><span class="diff-line-num">${numStr}</span><span class="diff-line-content">${sign} ${body}</span></div>`;
}

function attachPairs(lines){
  for(let i=0;i<lines.length-1;i++){
    const a=lines[i], b=lines[i+1];
    if(a.type==='del' && b.type==='add'){ a.pair=b.val; b.pair=a.val; }
  }
}

function renderSplit(lines){
  let html='';
  for(let i=0;i<lines.length;i++){
    const l=lines[i];
    if(l.type==='eq'){
      html += `<div class="split-row"><div class="split-cell split-old diff-ctx">${escHtml(l.val)}</div><div class="split-cell diff-ctx">${escHtml(l.val)}</div></div>`;
    } else if(l.type==='del' && i+1<lines.length && lines[i+1].type==='add'){
      const n=lines[i+1];
      html += `<div class="split-row change-line"><div class="split-cell split-old diff-del">${highlightInline(l.val,n.val,'del')}</div><div class="split-cell diff-add">${highlightInline(l.val,n.val,'add')}</div></div>`;
      i++;
    } else if(l.type==='del'){
      html += `<div class="split-row change-line"><div class="split-cell split-old diff-del">${escHtml(l.val)}</div><div class="split-cell"></div></div>`;
    } else if(l.type==='add'){
      html += `<div class="split-row change-line"><div class="split-cell split-old"></div><div class="split-cell diff-add">${escHtml(l.val)}</div></div>`;
    }
  }
  return html;
}

function normalizeForDiff(raw) {
  if (diffMode === 'json') {
    try {
      const parsed = JSON.parse(raw || '');
      raw = JSON.stringify(parsed, null, 2);
    } catch (e) {
      throw new Error(`JSON 파싱 실패: ${e.message}`);
    }
  }
  return raw;
}

function buildUnifiedPatch(ops, oldName = 'a/original', newName = 'b/modified') {
  let patch = `--- ${oldName}\n+++ ${newName}\n`;
  let oldLine = 1, newLine = 1;
  patch += `@@ -${oldLine},${ops.filter(o=>o.type!=='add').length} +${newLine},${ops.filter(o=>o.type!=='del').length} @@\n`;
  ops.forEach(op => {
    if (op.type === 'eq') patch += ` ${op.val}\n`;
    if (op.type === 'del') patch += `-${op.val}\n`;
    if (op.type === 'add') patch += `+${op.val}\n`;
  });
  return patch;
}

// ─── Main ─────────────────────────────────────────────────
function runDiff() {
  const origRaw = document.getElementById('originalInput').value;
  const modRaw  = document.getElementById('modifiedInput').value;
  const output  = document.getElementById('outputPanel');
  const btn     = document.getElementById('diffBtn');

  btn.textContent = '⏳ 비교 중...';
  btn.classList.add('loading');

  setTimeout(() => {
    try {
      const origNormalized = normalizeForDiff(origRaw);
      const modNormalized = normalizeForDiff(modRaw);
      const normalise = s => {
        let v = trimWhitespace ? s.trimEnd() : s;
        if (ignoreCase) v = v.toLowerCase();
        return v;
      };
      let origLines = origNormalized.split('\n').map(normalise);
      let modLines  = modNormalized.split('\n').map(normalise);
      if (ignoreBlank) {
        origLines = origLines.filter(l => l.trim() !== '');
        modLines = modLines.filter(l => l.trim() !== '');
      }

      const ops = computeLCS(origLines, modLines);
      lastOps = ops;
      const hasChanges = ops.some(o => o.type !== 'eq');
      lastPatchText = buildUnifiedPatch(ops);

      if (!hasChanges) {
        changeCursor = -1;
        output.innerHTML = `
          <div class="panel">
            <div class="diff-identical">✓ 두 텍스트가 동일합니다</div>
          </div>`;
      } else {
        let html = '', addCount = ops.filter(o=>o.type==='add').length, delCount = ops.filter(o=>o.type==='del').length;
        if (viewMode === 'split') {
          const lines = ops.map(o => ({...o}));
          attachPairs(lines);
          html = renderSplit(lines);
        } else {
          const rendered = renderDiff(ops, contextLines);
          html = rendered.html; addCount = rendered.addCount; delCount = rendered.delCount;
        }
        const blockId = `diff_${Date.now()}`;
        const bodyHtml = `
          <div class="diff-summary">
            <span><span class="add-count">+${addCount}</span> 추가</span>
            <span><span class="del-count">−${delCount}</span> 삭제</span>
            <span>${origLines.length}줄 → ${modLines.length}줄</span>
            <span>View: ${viewMode.toUpperCase()}</span>
          </div>
          <div class="diff-output-wrap" id="${blockId}">${html}</div>`;

        output.innerHTML = UIUtils.renderSqlBlock({
          badge: 'DIFF',
          tag: `${origLines.length} → ${modLines.length} lines · ${diffMode.toUpperCase()}`,
          copyBtnId: `copy_${blockId}`,
          copyLabel: 'COPY PATCH',
          copyHandler: `copyDiff('${blockId}')`,
          bodyHtml,
        });
        changeCursor = -1;
        const summary = output.querySelector('.diff-summary');
        if (summary) summary.insertAdjacentHTML('afterend', buildChangeNav());
        scrollToOutput(output);
      }
    } catch (e) {
      output.innerHTML = `<div class="error-msg">❌ ${escHtml(e.message)}</div>`;
      lastPatchText = '';
      lastOps = [];
    }

    btn.textContent = '⚡ 비교하기';
    btn.classList.remove('loading');
  }, 50);
}

function copyDiff(id) {
  const btn = document.getElementById(`copy_${id}`);
  UIUtils.copyTextWithFeedback(lastPatchText || '', btn, 'COPY PATCH');
}

function jumpChangeTo(index){
  const lines = [...document.querySelectorAll('#outputPanel .change-line')];
  if (!lines.length) return;
  changeCursor = Math.max(0, Math.min(index, lines.length - 1));
  lines.forEach(l => l.classList.remove('active-change'));
  const target = lines[changeCursor];
  target.classList.add('active-change');
  target.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function jumpChange(dir = 1){
  const lines = [...document.querySelectorAll('#outputPanel .change-line')];
  if (!lines.length) return;
  const next = (changeCursor + dir + lines.length) % lines.length;
  jumpChangeTo(next);
}

function buildChangeNav(max = 24){
  const lines = [...document.querySelectorAll('#outputPanel .change-line')];
  if (!lines.length) return '';
  const btns = lines.slice(0, max).map((_,i)=>`<button class="toggle-btn" onclick="jumpChangeTo(${i})">#${i+1}</button>`).join('');
  const more = lines.length > max ? `<span class="sql-dialect-tag">+${lines.length-max} more</span>` : '';
  return `<div class="change-nav"><span class="sql-dialect-tag">Changes</span>${btns}${more}<button class="toggle-btn" onclick="copyByType('add')">추가만 COPY</button><button class="toggle-btn" onclick="copyByType('del')">삭제만 COPY</button><button class="toggle-btn" onclick="copyByType('chg')">변경만 COPY</button></div>`;
}

function copyByType(kind){
  if (!lastOps.length) return;
  let lines=[];
  if (kind==='add') lines = lastOps.filter(o=>o.type==='add').map(o=>`+ ${o.val}`);
  else if (kind==='del') lines = lastOps.filter(o=>o.type==='del').map(o=>`- ${o.val}`);
  else {
    for (let i=0;i<lastOps.length-1;i++) {
      const a=lastOps[i], b=lastOps[i+1];
      if (a.type==='del' && b.type==='add') lines.push(`- ${a.val}\n+ ${b.val}`);
    }
  }
  navigator.clipboard.writeText(lines.join('\n'));
}

// Ctrl/Cmd + Enter
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') runDiff();
});

function loadSample() {
  document.getElementById('originalInput').value =
`function greet(name) {
  console.log('Hello, ' + name);
  return true;
}`;
  document.getElementById('modifiedInput').value =
`function greet(name, greeting = 'Hello') {
  console.log(\`\${greeting}, \${name}!\`);
  // Updated greeting logic
  return name.length > 0;
}`;
}
</script>
</body>
</html>
