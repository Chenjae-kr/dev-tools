<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/dev-tools/favicon.svg">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Table/JSON → Chart Image | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../image-tools-utils.js"></script>
<script src="../../ui-utils.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.control-grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;width:100%}
.control-grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;width:100%}
.input-area{width:100%;min-height:180px;background:transparent;border:1px solid var(--border);border-radius:10px;padding:12px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;resize:vertical}
.file-input{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);background:var(--surface)}
.canvas-preview{width:100%;height:auto;border-radius:10px;border:1px solid var(--border)}
.preview-wrap{position:sticky;top:74px}
@media(max-width:980px){.preview-wrap{position:static;top:auto}.control-grid-4{grid-template-columns:repeat(2,minmax(0,1fr));}}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header"><h1>Table/JSON <span>→</span> Chart Image</h1><p>// JSON 또는 테이블 데이터로 차트 이미지 생성</p></div>
  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>Input</div></div>

        <div class="setting-group">
          <div class="setting-title">Source</div>
          <div class="options-bar">
            <span class="options-label">Input Type</span>
            <div class="toggle-group">
              <button class="toggle-btn src-btn active" data-src="table">Table Text</button>
              <button class="toggle-btn src-btn" data-src="json">JSON</button>
            </div>
            <button class="toggle-btn" onclick="loadSample()">샘플</button>
          </div>
          <div class="options-bar">
            <span class="options-label">Upload</span>
            <input id="fileInput" class="file-input" type="file" accept=".txt,.csv,.tsv,.md,.json,text/plain,application/json">
          </div>
          <div class="options-bar"><span class="options-label">Data</span></div>
          <textarea id="sourceText" class="input-area" placeholder="label,value\nA,40\nB,28\nC,65"></textarea>
        </div>

        <div class="setting-group">
          <div class="setting-title">Chart</div>
          <div class="options-bar">
            <span class="options-label">Type</span>
            <div class="toggle-group">
              <button class="toggle-btn type-btn active" data-type="bar">Bar</button>
              <button class="toggle-btn type-btn" data-type="line">Line</button>
              <button class="toggle-btn type-btn" data-type="pie">Pie</button>
            </div>
          </div>
          <div class="options-bar">
            <span class="options-label">Title</span>
            <input id="chartTitle" class="table-name-input" value="매출 추이" placeholder="차트 제목">
            <span class="options-label">Series</span>
            <input id="seriesColor" type="color" class="table-name-input input-md color-input" value="#4fffb0">
          </div>
          <div class="options-bar">
            <span class="options-label">Legend</span>
            <div class="toggle-group">
              <button class="toggle-btn legend-btn active" data-legend="on">ON</button>
              <button class="toggle-btn legend-btn" data-legend="off">OFF</button>
            </div>
            <span class="options-label">Value Label</span>
            <div class="toggle-group">
              <button class="toggle-btn value-btn active" data-value="on">ON</button>
              <button class="toggle-btn value-btn" data-value="off">OFF</button>
            </div>
            <span class="options-label">Legend Pos</span>
            <select id="legendPos" class="table-name-input input-sm">
              <option value="right">Right</option>
              <option value="bottom">Bottom</option>
            </select>
          </div>
          <div class="control-grid-4 mt-8">
            <input id="outW" type="number" class="table-name-input" value="1200" min="600" max="2400" placeholder="Width">
            <input id="outH" type="number" class="table-name-input" value="1200" min="600" max="2400" placeholder="Height">
            <input id="fontScale" type="number" class="table-name-input" value="100" min="70" max="150" placeholder="Font %">
            <input id="bgColor" type="color" class="table-name-input color-input" value="#0d0f14">
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Footer Watermark</div>
          <div class="options-bar">
            <span class="options-label">Type</span>
            <div class="toggle-group">
              <button class="toggle-btn wmtype-btn active" data-wmtype="off">OFF</button>
              <button class="toggle-btn wmtype-btn" data-wmtype="text">Text</button>
              <button class="toggle-btn wmtype-btn" data-wmtype="image">Image</button>
            </div>
            <span class="options-label">Pos</span>
            <div class="toggle-group">
              <button class="toggle-btn wmpos-btn" data-wmpos="left">Left</button>
              <button class="toggle-btn wmpos-btn active" data-wmpos="center">Center</button>
              <button class="toggle-btn wmpos-btn" data-wmpos="right">Right</button>
            </div>
          </div>
          <div class="options-bar" id="wmTextBar">
            <span class="options-label">Text</span>
            <input id="wmText" class="table-name-input" value="@chenjae-kr.github.io" placeholder="워터마크 텍스트">
            <span class="options-label">Color</span>
            <input id="wmColor" type="color" class="table-name-input input-sm color-input" value="#a8b2ca">
          </div>
          <div class="options-bar hidden" id="wmImageBar">
            <span class="options-label">Image</span>
            <input id="wmImage" class="file-input" type="file" accept="image/*">
          </div>
          <div class="options-bar">
            <span class="options-label">Opacity%</span>
            <input id="wmOpacity" type="number" class="table-name-input input-xs" value="55" min="5" max="100">
            <span class="options-label">Scale%</span>
            <input id="wmScale" type="number" class="table-name-input input-xs" value="100" min="40" max="220">
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Export</div>
          <div class="options-row options-row-2">
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Format</span>
                <div class="toggle-group">
                  <button class="toggle-btn fmt-btn active" data-fmt="png">PNG</button>
                  <button class="toggle-btn fmt-btn" data-fmt="jpeg">JPG</button>
                  <button class="toggle-btn fmt-btn" data-fmt="webp">WEBP</button>
                </div>
              </div>
            </div>
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Quality</span>
                <input id="quality" type="number" class="table-name-input input-sm" value="92" min="1" max="100">
                <button class="toggle-btn" onclick="resetForm()">RESET</button>
              </div>
            </div>
          </div>
          <div class="download-actions">
            <button class="download-btn all full" onclick="downloadOut()">⬇ 다운로드</button>
          </div>
        </div>
      </div>
    </div>

    <div class="preview-wrap">
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>Preview</div></div>
        <canvas id="chartCanvas" width="1200" height="1200" class="canvas-preview"></canvas>
      </div>
    </div>
  </div>
  <footer>// Table/JSON to Chart Image</footer>
</div>

<script>
let sourceType='table';
let chartType='bar';
let exportFormat='png';
let showLegend=true;
let showValueLabel=true;
let wmType='off';
let wmPos='center';
let wmImageObj=null;
const canvas=document.getElementById('chartCanvas');
const ctx=canvas.getContext('2d');

function parseDelimitedLine(line, sep=','){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; continue; }
    if(ch===sep && !q){ out.push(cur.trim()); cur=''; continue; }
    cur+=ch;
  }
  out.push(cur.trim());
  return out;
}
function parseMarkdownTable(text){
  const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const only=lines.filter(l=>l.includes('|'));
  if(only.length<2) return null;
  const isSep=l=>/^[\s|:\-]+$/.test(l);
  const row=l=>l.replace(/^\s*\||\|\s*$/g,'').split('|').map(c=>c.trim());
  const hi=only.findIndex(l=>!isSep(l));
  if(hi<0) return null;
  const head=row(only[hi]);
  const body=only.slice(hi+1).filter(l=>!isSep(l)).map(row);
  return {head, body};
}
function parseTableText(text){
  const md=parseMarkdownTable(text);
  if(md && md.head.length>=2){
    return md.body.map(r=>({label:r[0]||'', value:Number(String(r[1]||'').replace(/,/g,''))||0})).filter(x=>x.label);
  }
  const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length<2) throw new Error('2줄 이상 데이터가 필요합니다.');
  let sep=',';
  const first=lines[0];
  const cTab=(first.match(/\t/g)||[]).length;
  const cPipe=(first.match(/\|/g)||[]).length;
  const cComma=(first.match(/,/g)||[]).length;
  if(cTab>=cPipe && cTab>=cComma) sep='\t'; else if(cPipe>=cComma) sep='|';
  const rows=lines.map(l=>parseDelimitedLine(l,sep));
  const hasHeader=isNaN(Number(String(rows[0][1]||'').replace(/,/g,'')));
  const body=hasHeader?rows.slice(1):rows;
  return body.map(r=>({label:String(r[0]||'').trim(), value:Number(String(r[1]||'').replace(/,/g,''))||0})).filter(x=>x.label);
}
function parseJson(text){
  const j=JSON.parse(text);
  if(!Array.isArray(j)) throw new Error('JSON은 배열 형태여야 합니다.');
  return j.map(it=>({label:String(it.label ?? it.name ?? ''), value:Number(it.value ?? it.y ?? 0)})).filter(x=>x.label);
}

function drawTitle(title, fs, w){
  ctx.fillStyle='#e8ecf5';
  ctx.font=`700 ${fs}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
  ctx.textAlign='left';
  ctx.fillText(title||'Chart', w*0.08, w*0.1);
}

function drawLegend(data,w,h,fs,legendPos='right',withValues=true,fixedColor=''){ 
  const isBottom = legendPos === 'bottom';
  ctx.font=`600 ${Math.floor(fs*0.52)}px JetBrains Mono, monospace`;
  ctx.textAlign='left';
  data.forEach((d,i)=>{
    const y=isBottom ? (h*0.88 + i*(fs*0.72)) : (h*0.24 + i*(fs*0.85));
    const x0=isBottom ? (w*0.12 + (i%2)*w*0.36) : w*0.78;
    const color = fixedColor || `hsl(${(i*61)%360} 78% 58%)`;
    ctx.fillStyle=color; ctx.fillRect(x0,y-11,14,14);
    ctx.fillStyle='#e8ecf5';
    ctx.fillText(withValues ? `${d.label} (${d.value})` : d.label, x0+20, y);
  });
}

function renderBar(data,w,h,base,color,fs,showValues=true){
  const left=w*0.1, right=w*0.92, top=h*0.18, bottom=h*0.86;
  ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke();
  const max=Math.max(...data.map(d=>d.value),1);
  const bw=(right-left)/data.length*0.62;
  const gap=(right-left)/data.length;
  data.forEach((d,i)=>{
    const x=left + i*gap + (gap-bw)/2;
    const bh=((d.value/base.max)||0)*(bottom-top);
    const y=bottom-bh;
    ctx.fillStyle=color; ctx.fillRect(x,y,bw,bh);
    ctx.fillStyle='#e8ecf5'; ctx.font=`600 ${Math.floor(fs*0.68)}px JetBrains Mono, monospace`; ctx.textAlign='center';
    if (showValues) ctx.fillText(String(d.value), x+bw/2, y-8);
    ctx.fillStyle='#a8b2ca';
    ctx.fillText(d.label, x+bw/2, bottom+28);
  });
}
function renderLine(data,w,h,color,fs,showValues=true){
  const left=w*0.1, right=w*0.92, top=h*0.18, bottom=h*0.86;
  ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke();
  const max=Math.max(...data.map(d=>d.value),1);
  const step=(right-left)/Math.max(1,data.length-1);
  ctx.strokeStyle=color; ctx.lineWidth=4; ctx.beginPath();
  data.forEach((d,i)=>{ const x=left+i*step; const y=bottom-(d.value/max)*(bottom-top); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
  ctx.stroke();
  data.forEach((d,i)=>{
    const x=left+i*step; const y=bottom-(d.value/max)*(bottom-top);
    ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#e8ecf5'; ctx.font=`600 ${Math.floor(fs*0.62)}px JetBrains Mono, monospace`; ctx.textAlign='center';
    if (showValues) ctx.fillText(String(d.value), x, y-12);
    ctx.fillStyle='#a8b2ca'; ctx.fillText(d.label, x, bottom+28);
  });
}
function renderPie(data,w,h,fs,showLegendOn=true,showValues=true,legendPos='right'){
  const total=Math.max(1,data.reduce((s,d)=>s+Math.max(0,d.value),0));
  const cx=w*0.38, cy=h*0.55, r=Math.min(w,h)*0.26;
  let a=-Math.PI/2;
  data.forEach((d,i)=>{
    const val=Math.max(0,d.value); const da=(val/total)*Math.PI*2;
    const color=`hsl(${(i*61)%360} 78% 58%)`;
    ctx.fillStyle=color; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a,a+da); ctx.closePath(); ctx.fill();
    a+=da;
  });
  if (showLegendOn) {
    const isBottom = legendPos === 'bottom';
    ctx.font=`600 ${Math.floor(fs*0.6)}px JetBrains Mono, monospace`;
    ctx.textAlign='left';
    data.forEach((d,i)=>{
      const y=isBottom ? (h*0.86 + i*(fs*0.8)) : (h*0.32 + i*(fs*0.92));
      const x0=isBottom ? (w*0.16 + (i%2)*w*0.34) : w*0.64;
      const color=`hsl(${(i*61)%360} 78% 58%)`;
      ctx.fillStyle=color; ctx.fillRect(x0,y-14,18,18);
      const label = showValues ? `${d.label} (${d.value})` : d.label;
      ctx.fillStyle='#e8ecf5'; ctx.fillText(label, x0+24, y);
    });
  }
}

function drawFooterWatermark(w,h,fs){
  if (wmType === 'off') return;
  const opacity = Math.max(0.05, Math.min(1, (parseInt(document.getElementById('wmOpacity').value||'55',10))/100));
  const scale = Math.max(0.4, Math.min(2.2, (parseInt(document.getElementById('wmScale').value||'100',10))/100));
  const y = h - Math.max(24, Math.floor(fs*0.7));
  const x = wmPos === 'left' ? w*0.08 : wmPos === 'right' ? w*0.92 : w*0.5;

  ctx.save();
  ctx.globalAlpha = opacity;

  if (wmType === 'text') {
    const text = (document.getElementById('wmText').value || '').trim();
    if (!text) { ctx.restore(); return; }
    ctx.font = `600 ${Math.floor(fs*0.56*scale)}px JetBrains Mono, monospace`;
    ctx.fillStyle = document.getElementById('wmColor').value || '#a8b2ca';
    ctx.textAlign = wmPos === 'left' ? 'left' : wmPos === 'right' ? 'right' : 'center';
    ctx.fillText(text, x, y);
  } else if (wmType === 'image' && wmImageObj) {
    const targetW = Math.max(60, Math.min(w*0.28, w*0.16*scale));
    const ratio = wmImageObj.width / Math.max(1, wmImageObj.height);
    const targetH = targetW / ratio;
    const drawX = wmPos === 'left' ? w*0.08 : wmPos === 'right' ? w*0.92 - targetW : (w-targetW)/2;
    const drawY = h - targetH - Math.max(16, Math.floor(fs*0.2));
    ctx.drawImage(wmImageObj, drawX, drawY, targetW, targetH);
  }
  ctx.restore();
}

function renderChart(){
  try{
    const w=Math.max(600,Math.min(2400,parseInt(document.getElementById('outW').value||'1200',10)));
    const h=Math.max(600,Math.min(2400,parseInt(document.getElementById('outH').value||'1200',10)));
    canvas.width=w; canvas.height=h;
    const bg=document.getElementById('bgColor').value;
    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);

    const text=document.getElementById('sourceText').value.trim();
    const data=sourceType==='json'?parseJson(text):parseTableText(text);
    if(!data.length) throw new Error('데이터가 비어 있습니다.');
    const fs=Math.floor((w/24)*(Math.max(70,Math.min(150,parseInt(document.getElementById('fontScale').value||'100',10)))/100));
    const title=document.getElementById('chartTitle').value.trim();
    const color=document.getElementById('seriesColor').value;
    const legendPos=document.getElementById('legendPos').value || 'right';
    drawTitle(title,fs,w);

    const max=Math.max(...data.map(d=>d.value),1);
    if(chartType==='bar') {
      renderBar(data,w,h,{max},color,fs,showValueLabel);
      if (showLegend) drawLegend(data,w,h,fs,legendPos,showValueLabel,color);
    }
    else if(chartType==='line') {
      renderLine(data,w,h,color,fs,showValueLabel);
      if (showLegend) drawLegend(data,w,h,fs,legendPos,showValueLabel,color);
    }
    else renderPie(data,w,h,fs,showLegend,showValueLabel,legendPos);

    drawFooterWatermark(w,h,fs);
  }catch(e){ alert(e.message || String(e)); }
}

function downloadOut(){
  const q=Math.max(1,Math.min(100,parseInt(document.getElementById('quality').value||'92',10)))/100;
  ImageToolUtils.downloadCanvas(canvas,{format:exportFormat,quality:q,filename:`chart_${Date.now()}`});
}

function loadSample(){
  if(sourceType==='json'){
    document.getElementById('sourceText').value = JSON.stringify([
      {"label":"1Q","value":120},{"label":"2Q","value":180},{"label":"3Q","value":145},{"label":"4Q","value":230}
    ], null, 2);
  } else {
    document.getElementById('sourceText').value = 'label,value\n1Q,120\n2Q,180\n3Q,145\n4Q,230';
  }
}

function updateWatermarkUI(){
  document.getElementById('wmTextBar').classList.toggle('hidden', wmType !== 'text');
  document.getElementById('wmImageBar').classList.toggle('hidden', wmType !== 'image');
}

function resetForm(){
  UIUtils.resetFields({
    chartTitle: '매출 추이',
    seriesColor: '#4fffb0',
    outW: 1200,
    outH: 1200,
    fontScale: 100,
    bgColor: '#0d0f14',
    quality: 92,
    legendPos: 'right',
    wmText: '@chenjae-kr.github.io',
    wmColor: '#a8b2ca',
    wmOpacity: 55,
    wmScale: 100,
  }, () => {
    showLegend = true;
    showValueLabel = true;
    wmType = 'off';
    wmPos = 'center';
    wmImageObj = null;
    document.querySelectorAll('.legend-btn').forEach(b=>b.classList.toggle('active', b.dataset.legend==='on'));
    document.querySelectorAll('.value-btn').forEach(b=>b.classList.toggle('active', b.dataset.value==='on'));
    document.querySelectorAll('.wmtype-btn').forEach(b=>b.classList.toggle('active', b.dataset.wmtype==='off'));
    document.querySelectorAll('.wmpos-btn').forEach(b=>b.classList.toggle('active', b.dataset.wmpos==='center'));
    updateWatermarkUI();
    loadSample();
    renderChart();
  });
}

UIUtils.wireTextFileInput('fileInput', (text) => {
  document.getElementById('sourceText').value = text;
  renderChart();
});

document.getElementById('wmImage').addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = new Image();
    img.onload = () => { wmImageObj = img; renderChart(); };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

UIUtils.bindToggleGroup('.src-btn', {
  onChange: (btn) => {
    sourceType = btn.dataset.src;
    document.getElementById('sourceText').placeholder = sourceType==='json'
      ? '[{"label":"A","value":40},{"label":"B","value":30}]'
      : 'label,value\nA,40\nB,30';
  }
});

UIUtils.bindToggleGroup('.type-btn', { onChange: (btn) => { chartType = btn.dataset.type; renderChart(); } });
UIUtils.bindToggleGroup('.fmt-btn', { onChange: (btn) => { exportFormat = btn.dataset.fmt; } });
UIUtils.bindToggleGroup('.legend-btn', { onChange: (btn) => { showLegend = btn.dataset.legend === 'on'; renderChart(); } });
UIUtils.bindToggleGroup('.value-btn', { onChange: (btn) => { showValueLabel = btn.dataset.value === 'on'; renderChart(); } });
UIUtils.bindToggleGroup('.wmtype-btn', { onChange: (btn) => { wmType = btn.dataset.wmtype; updateWatermarkUI(); renderChart(); } });
UIUtils.bindToggleGroup('.wmpos-btn', { onChange: (btn) => { wmPos = btn.dataset.wmpos; renderChart(); } });
['sourceText','chartTitle','seriesColor','outW','outH','fontScale','bgColor','legendPos','wmText','wmColor','wmOpacity','wmScale'].forEach(id=>document.getElementById(id).addEventListener('input', ()=>renderChart()));

updateWatermarkUI();
loadSample();
renderChart();
</script>
</body>
</html>