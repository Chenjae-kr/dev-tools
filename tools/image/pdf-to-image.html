<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF to Image Converter | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../ui-utils.js"></script>
<script src="../../image-tools-utils.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.preview-wrap{position:sticky;top:84px}
.pdf-canvas{width:100%;height:auto;border:1px solid var(--border);border-radius:10px;background:#fff}
@media(max-width:980px){.preview-wrap{position:static;top:auto}}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header"><h1>PDF → Image Converter</h1><p>// PDF 페이지를 이미지(PNG/JPG/WEBP)로 변환</p></div>
  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>SETTINGS</div></div>

        <div class="setting-group">
          <div class="setting-title">Source</div>
          <div class="options-bar row-tight">
            <span class="options-label">PDF</span>
            <input id="pdfFile" type="file" accept="application/pdf,.pdf">
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Render</div>
          <div class="options-bar row-tight">
            <span class="options-label">Page</span>
            <button class="toggle-btn" onclick="prevPage()">◀</button>
            <input id="pageNum" class="table-name-input input-xs" type="number" min="1" value="1">
            <span id="pageTotal" class="options-label">/ 0</span>
            <button class="toggle-btn" onclick="nextPage()">▶</button>
          </div>
          <div class="options-bar row-tight">
            <span class="options-label">Scale%</span>
            <input id="scale" class="table-name-input input-xs" type="number" min="50" max="400" value="150">
            <span class="options-label">Format</span>
            <div class="toggle-group">
              <button class="toggle-btn fmt active" data-fmt="png">PNG</button>
              <button class="toggle-btn fmt" data-fmt="jpeg">JPG</button>
              <button class="toggle-btn fmt" data-fmt="webp">WEBP</button>
            </div>
            <span class="options-label">Quality</span>
            <input id="quality" class="table-name-input input-xs" type="number" min="1" max="100" value="92">
          </div>
          <div class="options-bar row-tight">
            <button class="generate-btn" onclick="renderCurrent()">⚡ 렌더</button>
            <button class="toggle-btn" onclick="downloadCurrent()">⬇ 현재 페이지 다운로드</button>
            <button class="toggle-btn" onclick="downloadAll()">⬇ 전체 페이지 다운로드</button>
          </div>
        </div>
      </div>
    </div>

    <div class="preview-wrap">
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>PREVIEW</div></div>
        <canvas id="pdfCanvas" class="pdf-canvas" width="1080" height="1350"></canvas>
      </div>
    </div>
  </div>
  <footer>// PDF to Image Converter</footer>
</div>

<script type="module">
import * as pdfjsLib from '../../vendor/pdfjs/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = '../../vendor/pdfjs/pdf.worker.min.mjs';

let pdfDoc = null;
let currentPage = 1;
let fmt = 'png';
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');

document.querySelectorAll('.fmt').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.fmt').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  fmt = b.dataset.fmt;
}));

document.getElementById('pdfFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  const arr = await f.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({ data: arr }).promise;
  currentPage = 1;
  document.getElementById('pageNum').value = 1;
  document.getElementById('pageTotal').textContent = `/ ${pdfDoc.numPages}`;
  renderCurrent();
});

async function renderPage(pageNum){
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(pageNum);
  const scale = Math.max(0.5, Math.min(4, Number(document.getElementById('scale').value || 150)/100));
  const viewport = page.getViewport({ scale });
  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
}

window.renderCurrent = async function(){
  if (!pdfDoc) { alert('PDF 파일을 먼저 선택하세요.'); return; }
  const p = Math.max(1, Math.min(pdfDoc.numPages, Number(document.getElementById('pageNum').value || currentPage)));
  currentPage = p;
  document.getElementById('pageNum').value = p;
  await renderPage(p);
};

window.prevPage = function(){
  if (!pdfDoc) return;
  if (currentPage > 1) { currentPage--; document.getElementById('pageNum').value = currentPage; renderCurrent(); }
};
window.nextPage = function(){
  if (!pdfDoc) return;
  if (currentPage < pdfDoc.numPages) { currentPage++; document.getElementById('pageNum').value = currentPage; renderCurrent(); }
};

window.downloadCurrent = function(){
  if (!pdfDoc) return;
  const q = Math.max(1, Math.min(100, Number(document.getElementById('quality').value || 92)))/100;
  ImageToolUtils.downloadCanvas(canvas, { format: fmt, quality: q, filename: `pdf_p${currentPage}` });
};

window.downloadAll = async function(){
  if (!pdfDoc) return;
  const q = Math.max(1, Math.min(100, Number(document.getElementById('quality').value || 92)))/100;
  const keep = currentPage;
  for (let i=1;i<=pdfDoc.numPages;i++) {
    currentPage = i;
    document.getElementById('pageNum').value = i;
    await renderPage(i);
    ImageToolUtils.downloadCanvas(canvas, { format: fmt, quality: q, filename: `pdf_p${i}` });
    await new Promise(r=>setTimeout(r,80));
  }
  currentPage = keep;
  document.getElementById('pageNum').value = keep;
  await renderPage(keep);
};
</script>
</body>
</html>