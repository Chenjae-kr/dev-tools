<!DOCTYPE html>
<html lang="ko" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="/dev-tools/favicon.svg">
    <title>Web Image Editor | Dev Tools</title>
    <script src="../../tools.js"></script>
    <script src="../../nav.js"></script>
    <script src="../../ui-utils.js"></script>
    <script src="../../image-tools-utils.js"></script>
    <link rel="stylesheet" href="../../styles.css">
    <!-- Fabric.js v5.3.1 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Noto+Serif+KR:wght@400;700&family=Do+Hyeon&family=Jua&family=Gowun+Dodum&family=Nanum+Pen+Script&display=swap"
        rel="stylesheet">
    <link
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/variable/pretendardvariable-dynamic-subset.css"
        rel="stylesheet">

    <style>
        /* â”€â”€ Editor App Layout (100vh) â”€â”€ */
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* ë°©ì§€: ëª¨ë°”ì¼ì—ì„œ ìƒí•˜ í’€ë‹¹ê¸°ê¸° ìƒˆë¡œê³ ì¹¨ ë“± */
            height: 100%;
        }

        .topnav {
            z-index: 50;
            position: relative;
        }

        /* nav.js ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ë°” ìœ ì§€ */
        .editor-app {
            display: flex;
            height: calc(100% - 61px);
            /* 100dvh ì§€ì› ë¸Œë¼ìš°ì €ë¥¼ ìœ„í•´ í•„ìš” ì‹œ jsì—ì„œ ë³´ì •, 61=navë†’ì´ì¶”ì • */
            height: calc(100dvh - 61px);
            background: var(--surface);
            color: var(--text);
            font-family: Pretendard, sans-serif;
            overflow: hidden;
        }

        /* â”€â”€ Left Toolbar â”€â”€ */
        .editor-toolbar {
            width: 72px;
            background: var(--surface2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 12px;
            z-index: 10;
            overflow-y: auto;
        }

        .tool-btn {
            width: 52px;
            height: 52px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.1s;
        }

        .tool-btn:hover {
            background: var(--surface);
            border-color: var(--border);
        }

        .tool-btn:active {
            transform: scale(0.96);
        }

        .tool-icon {
            font-size: 20px;
            line-height: 1;
            margin-bottom: 4px;
        }

        .tool-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* â”€â”€ Center Workspace â”€â”€ */
        .editor-workspace {
            flex: 1;
            background: #1e1e1e;
            /* Photoshop-like dark backdrop */
            position: relative;
            overflow: auto;
            /* scrollable canvas area */
            display: flex;
            align-items: center;
            justify-content: center;
            /* ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ì¤Œ íŒ¨ë‹ì„ ìœ„í•´ ì»¨í…Œì´ë„ˆ ì—¬ë°± í™•ë³´ */
            padding: 40px;
        }

        /* ë°”ë‘‘íŒ ë°°ê²½ ë˜í¼ */
        .canvas-zoom-wrapper {
            background-image:
                linear-gradient(45deg, #d1d1d1 25%, transparent 25%),
                linear-gradient(-45deg, #d1d1d1 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #d1d1d1 75%),
                linear-gradient(-45deg, transparent 75%, #d1d1d1 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            /* ë¶€ë“œëŸ¬ìš´ ì¤Œì•„ì›ƒ/ì´ˆê¸°í™” ì‹œ */
        }

        /* Fabric.js ìº”ë²„ìŠ¤ ìì²´ ìŠ¤íƒ€ì¼ (íˆ¬ëª…) */
        .canvas-container {
            margin: 0 auto;
        }

        /* â”€â”€ Right Properties Panel â”€â”€ */
        .editor-props {
            width: 320px;
            background: var(--surface2);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow-y: auto;
        }

        .prop-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .prop-section:last-child {
            border-bottom: none;
        }

        .prop-title {
            font-size: 11px;
            font-weight: 900;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .prop-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 12px;
            background: var(--accent);
            margin-right: 8px;
            border-radius: 2px;
        }

        /* ì˜µì…˜ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .prop-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .prop-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 50px;
        }

        .prop-input-group {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 4px;
        }

        .prop-input {
            width: 100%;
            padding: 6px 8px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            outline: none;
        }

        .prop-input:focus {
            border-color: var(--accent);
        }

        .size-input-box {
            width: 64px;
            text-align: center;
        }

        .size-x {
            color: var(--text-muted);
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            width: 100%;
        }

        .action-btn {
            flex: 1;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: 0.15s;
        }

        .action-btn:hover {
            background: var(--surface-hover);
            border-color: var(--text-muted);
        }

        .action-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .action-btn.icon-btn {
            flex: none;
            width: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
        }

        .color-picker {
            border: none;
            padding: 0;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
        }

        .color-hex {
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
        }

        .primary-btn {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 800;
            background: linear-gradient(135deg, #0f4db8, #2a77ff);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 12px rgba(42, 119, 255, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(42, 119, 255, 0.4);
        }

        .hidden {
            display: none !important;
        }

        /* â”€â”€ Workspace Controls (Bottom Right zoom) â”€â”€ */
        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 4px;
            background: var(--surface2);
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 20;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 900;
        }

        .zoom-btn:hover {
            background: var(--surface-hover);
        }

        .zoom-label {
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            font-family: 'JetBrains Mono';
        }

        /* â”€â”€ Mobile Layout (< 768px) â”€â”€ */
        @media (max-width: 768px) {
            .editor-app {
                flex-direction: column;
            }

            /* Workspaceê°€ ê°€ì¥ ë„“ê²Œ ìƒë‹¨ì— */
            .editor-workspace {
                order: 1;
                padding: 16px;
            }

            /* Props Panelì´ ì¤‘ê°„ì— ìœ„ì¹˜ (ì„ íƒ ì‹œ ì—´ë¦¬ëŠ” ëŠë‚Œ) */
            .editor-props {
                order: 2;
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-left: none;
                border-top: 1px solid var(--border);
                box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
            }

            /* Toolbarê°€ ê°€ì¥ í•˜ë‹¨ì— ê°€ë¡œë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ë°°ì¹˜ */
            .editor-toolbar {
                order: 3;
                width: 100%;
                height: 64px;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--border);
                padding: 0 12px;
                gap: 8px;
                overflow-x: auto;
                overflow-y: hidden;
            }

            .tool-btn {
                width: 56px;
                height: 50px;
                flex-shrink: 0;
            }

            .zoom-controls {
                bottom: auto;
                top: 16px;
                right: 16px;
            }

            /* ì¤Œ ì»¨íŠ¸ë¡¤ì„ ìœ„ë¡œ */
        }

        /* Custom Scrollbar for editor panels */
        .editor-props::-webkit-scrollbar,
        .editor-toolbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .editor-props::-webkit-scrollbar-track,
        .editor-toolbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .editor-props::-webkit-scrollbar-thumb,
        .editor-toolbar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .editor-props::-webkit-scrollbar-thumb:hover,
        .editor-toolbar::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>

<body>
    <nav class="topnav">
        <script>renderNav();</script>
    </nav>

    <div class="editor-app">

        <!-- Left: Toolbar -->
        <div class="editor-toolbar">
            <button class="tool-btn" onclick="addText()">
                <span class="tool-icon">T</span>
                <span class="tool-label">TEXT</span>
            </button>
            <button class="tool-btn" onclick="document.getElementById('imageUpload').click()">
                <span class="tool-icon">ğŸ–¼ï¸</span>
                <span class="tool-label">IMAGE</span>
            </button>
            <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="addImage(event)">
            <button class="tool-btn" onclick="startSelectionMode()" id="btnSelect" title="ì˜ì—­ ì¡ê¸° (ìë¥´ê¸°/ëª¨ìì´í¬)">
                <span class="tool-icon">ğŸ”²</span>
                <span class="tool-label">SELECT</span>
            </button>
            <div style="width:40px;height:1px;background:var(--border);margin:4px 0;"></div>
            <button class="tool-btn" onclick="addShape('rect')">
                <span class="tool-icon">â¬›</span>
                <span class="tool-label">RECT</span>
            </button>
            <button class="tool-btn" onclick="addShape('circle')">
                <span class="tool-icon">âš«</span>
                <span class="tool-label">CIRCLE</span>
            </button>
            <button class="tool-btn" onclick="addShape('triangle')">
                <span class="tool-icon">â–²</span>
                <span class="tool-label">TRIANGLE</span>
            </button>
            <button class="tool-btn" onclick="addShape('line')">
                <span class="tool-icon">â–</span>
                <span class="tool-label">LINE</span>
            </button>
            <div style="width:40px;height:1px;background:var(--border);margin:4px 0;"></div>
            <button class="tool-btn" onclick="addShape('heart')">
                <span class="tool-icon">â¤ï¸</span>
                <span class="tool-label">HEART</span>
            </button>
            <button class="tool-btn" onclick="addShape('star')">
                <span class="tool-icon">â­</span>
                <span class="tool-label">STAR</span>
            </button>
            <button class="tool-btn" onclick="addShape('bolt')">
                <span class="tool-icon">âš¡</span>
                <span class="tool-label">BOLT</span>
            </button>
            <button class="tool-btn" onclick="addShape('smile')">
                <span class="tool-icon">ğŸ™‚</span>
                <span class="tool-label">SMILE</span>
            </button>
        </div>

        <!-- Center: Workspace -->
        <div class="editor-workspace" id="workspace">
            <!-- Region Action Bar (Hidden by default) -->
            <div id="regionActionBar" class="hidden"
                style="position:absolute; top:20px; left:50%; transform:translateX(-50%); z-index:100; background:var(--surface); padding:8px 16px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.5); display:flex; gap:8px; align-items:center;">
                <span style="font-size:12px; font-weight:700; color:var(--text); margin-right:8px;">ğŸ”² ì˜ì—­ ì˜µì…˜</span>
                <button class="action-btn" onclick="cropByRegion()"
                    style="background:#ffbd2e; color:#000; border:none; font-weight:800;">âœ‚ï¸ ìë¥´ê¸°</button>
                <div style="width:1px; height:16px; background:var(--border); margin:0 4px;"></div>
                <button class="action-btn" onclick="filterByRegion('pixelate')">ëª¨ìì´í¬</button>
                <button class="action-btn" onclick="filterByRegion('blur')">ë¸”ëŸ¬</button>
                <div style="width:1px; height:16px; background:var(--border); margin:0 4px;"></div>
                <button class="action-btn" onclick="cancelSelection()">âœ– ë‹«ê¸°</button>
            </div>

            <div class="canvas-zoom-wrapper" id="zoomWrapper">
                <canvas id="c"></canvas>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="changeZoom(-0.1)">-</button>
                <span class="zoom-label" id="zoomLabel">100%</span>
                <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
                <button class="zoom-btn" onclick="resetZoom()" style="font-size:10px">FIT</button>
            </div>
        </div>

        <!-- Right: Properties -->
        <div class="editor-props">

            <!-- Canvas Settings -->
            <div class="prop-section" id="canvasPropsPanel">
                <div class="prop-title">Canvas Settings</div>
                <div class="prop-row">
                    <span class="prop-label">Size (px)</span>
                    <div class="prop-input-group">
                        <input type="number" id="canvasW" class="prop-input size-input-box" value="1200" title="ê°€ë¡œ ë„ˆë¹„">
                        <span class="size-x">Ã—</span>
                        <input type="number" id="canvasH" class="prop-input size-input-box" value="800" title="ì„¸ë¡œ ë†’ì´">
                        <button class="action-btn" onclick="applyCustomSize()"
                            style="flex:unset; padding:6px 10px;">ì ìš©</button>
                    </div>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Background</span>
                    <label class="color-wrap">
                        <input type="color" id="bgColor" class="color-picker" value="#ffffff">
                        <span class="color-hex" id="bgColorHex">#FFFFFF</span>
                    </label>
                </div>
                <div class="prop-row">
                    <input type="file" id="bgImageInput" accept="image/*" class="hidden">
                    <button class="action-btn" style="width:100%"
                        onclick="document.getElementById('bgImageInput').click()"
                        title="í¬í† ìƒµì²˜ëŸ¼ ì´ë¯¸ì§€ í•´ìƒë„ì— ë§ì¶° ìº”ë²„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ì¡°ì ˆë©ë‹ˆë‹¤.">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì›ë³¸ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
                </div>
            </div>

            <!-- Object Settings (Hidden by default) -->
            <div class="prop-section hidden" id="objPropsPanel">
                <div class="prop-title" style="color:var(--accent)">Layer Properties</div>

                <div class="prop-row">
                    <span class="prop-label">Color</span>
                    <label class="color-wrap">
                        <input type="color" id="objColor" class="color-picker">
                        <span class="color-hex" id="objColorHex">#000000</span>
                    </label>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Opacity</span>
                    <input type="range" id="objOpacity" min="0" max="1" step="0.05" value="1" style="flex:1"
                        onchange="updateObj('opacity', parseFloat(this.value))">
                </div>

                <!-- Text Specific Props -->
                <div id="textPropsBar" class="hidden" style="margin-top:16px;">
                    <div class="prop-row">
                        <span class="prop-label">Font</span>
                        <select id="fontFamily" class="prop-input" onchange="updateFont(this.value)">
                            <option value="Pretendard Variable">Pretendard (ê³ ë”•)</option>
                            <option value="Noto Sans KR">Noto Sans KR (ê³ ë”•)</option>
                            <option value="Noto Serif KR">Noto Serif KR (ëª…ì¡°)</option>
                            <option value="Do Hyeon">ë°°ë‹¬ì˜ë¯¼ì¡± ë„í˜„ (íƒ€ì´í‹€)</option>
                            <option value="Jua">ë°°ë‹¬ì˜ë¯¼ì¡± ì£¼ì•„ (ìœ íŠœë¸Œ)</option>
                            <option value="Gowun Dodum">ê³ ìš´ë‹ì›€ (ë³¸ë¬¸)</option>
                            <option value="Nanum Pen Script">ë‚˜ëˆ” ì†ê¸€ì”¨ íœ</option>
                        </select>
                    </div>
                    <div class="prop-row">
                        <span class="prop-label">Size</span>
                        <input type="number" id="fontSize" class="prop-input size-input-box" min="10" max="500"
                            value="40" onchange="updateTextSize(this.value)">
                        <span style="font-size:10px; color:var(--text-muted)">px</span>
                    </div>
                    <div class="prop-row">
                        <span class="prop-label">Outline</span>
                        <div class="prop-input-group" style="gap:8px;">
                            <label class="color-wrap" style="flex:0 0 auto;">
                                <input type="color" id="textStrokeColor" class="color-picker" value="#ffffff"
                                    onchange="updateTextOutline()">
                            </label>
                            <input type="number" id="textStrokeWidth" class="prop-input size-input-box" min="0" max="30"
                                value="0" style="width:48px;" title="ì™¸ê³½ì„  ë‘ê»˜" onchange="updateTextOutline()">
                            <span style="font-size:10px; color:var(--text-muted)">px</span>
                        </div>
                    </div>
                    <div class="prop-row">
                        <span class="prop-label">Bg Color</span>
                        <div class="prop-input-group" style="gap:8px;">
                            <label class="color-wrap" style="flex:1;">
                                <input type="color" id="textBgColor" class="color-picker"
                                    onchange="updateTextBg(this.value)">
                                <span class="color-hex" id="textBgColorHex" style="font-size:10px;">None</span>
                            </label>
                            <button class="action-btn" onclick="updateTextBg('')"
                                style="padding:4px 8px; font-size:10px; flex:unset;">X</button>
                        </div>
                    </div>
                    <div class="prop-row">
                        <span class="prop-label">Style</span>
                        <div class="btn-group">
                            <button class="action-btn" id="btnBold" onclick="toggleStyle('bold')">B</button>
                            <button class="action-btn" id="btnItalic" onclick="toggleStyle('italic')">I</button>
                            <button class="action-btn" id="btnShadow" onclick="toggleShadow()">Shadow</button>
                        </div>
                    </div>
                    <div class="prop-row">
                        <span class="prop-label">Align</span>
                        <div class="btn-group">
                            <button class="action-btn" onclick="updateObj('textAlign', 'left')">Left</button>
                            <button class="action-btn" onclick="updateObj('textAlign', 'center')">Center</button>
                            <button class="action-btn" onclick="updateObj('textAlign', 'right')">Right</button>
                        </div>
                    </div>
                </div>

                <div class="prop-row" style="margin-top:20px;">
                    <span class="prop-label">Order</span>
                    <div class="btn-group">
                        <button class="action-btn" onclick="moveLayer('up')">â–² Bring Forward</button>
                        <button class="action-btn" onclick="moveLayer('down')">â–¼ Send Backward</button>
                    </div>
                </div>

                <div class="prop-row" style="margin-top:10px;">
                    <span class="prop-label">Actions</span>
                    <button class="action-btn" onclick="deleteObj()" style="color:#ff5f57; font-weight:800; flex:1">ğŸ—‘ï¸
                        Delete Layer</button>
                </div>

                <!-- Image Filters Specific Props -->
                <div id="imageFiltersBar" class="hidden"
                    style="margin-top:20px; border-top:1px dashed var(--border); padding-top:16px;">
                    <div class="prop-title" style="color:#ffbd2e">Image Filters</div>

                    <div class="prop-row">
                        <label
                            style="display:flex; align-items:center; gap:8px; font-size:12px; font-weight:600; cursor:pointer;">
                            <input type="checkbox" id="chkGrayscale" onchange="applyFilters()"> í‘ë°± (Grayscale)
                        </label>
                    </div>
                    <div class="prop-row">
                        <label
                            style="display:flex; align-items:center; gap:8px; font-size:12px; font-weight:600; cursor:pointer;">
                            <input type="checkbox" id="chkSepia" onchange="applyFilters()"> ì„¸í”¼ì•„ (Sepia)
                        </label>
                    </div>
                    <div class="prop-row" style="flex-direction:column; align-items:stretch; margin-top:12px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:12px; font-weight:600;">
                            <input type="checkbox" id="chkBlur" onchange="applyFilters()"> ë¸”ëŸ¬ (Blur)
                        </label>
                        <div style="display:flex; align-items:center; gap:8px; padding-left:24px;">
                            <span class="prop-label" style="min-width:40px">ê°•ë„</span>
                            <input type="range" id="blurValue" min="0" max="1" step="0.05" value="0.2" style="flex:1"
                                onchange="if(document.getElementById('chkBlur').checked) applyFilters()">
                        </div>
                    </div>
                    <div class="prop-row" style="flex-direction:column; align-items:stretch; margin-top:12px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:12px; font-weight:600;">
                            <input type="checkbox" id="chkPixelate" onchange="applyFilters()"> ëª¨ìì´í¬ (Pixelate)
                        </label>
                        <div style="display:flex; align-items:center; gap:8px; padding-left:24px;">
                            <span class="prop-label" style="min-width:40px">í¬ê¸°</span>
                            <input type="range" id="pixelateValue" min="2" max="20" step="1" value="8" style="flex:1"
                                onchange="if(document.getElementById('chkPixelate').checked) applyFilters()">
                        </div>
                    </div>
                </div>

            </div>

            <div style="flex:1"></div> <!-- Push export to bottom -->

            <!-- Save & Export -->
            <div class="prop-section" style="background:var(--surface)">
                <div class="prop-title">Export & Save</div>

                <div class="prop-row">
                    <span class="prop-label">Format</span>
                    <div class="btn-group">
                        <button class="action-btn fmt-btn active" data-fmt="png">PNG</button>
                        <button class="action-btn fmt-btn" data-fmt="jpeg">JPG</button>
                        <button class="action-btn fmt-btn" data-fmt="webp">WEBP</button>
                    </div>
                </div>

                <button class="primary-btn" onclick="downloadImage()">â¬‡ EXPORT IMAGE</button>

                <div style="margin-top:16px; display:flex; gap:8px;">
                    <button class="action-btn" style="flex:1" onclick="saveJson()">ğŸ’¾ JSON ì €ì¥</button>
                    <button class="action-btn" style="flex:1" onclick="document.getElementById('jsonUpload').click()">ğŸ“‚
                        ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <input type="file" id="jsonUpload" accept=".json" class="hidden" onchange="loadJson(event)">
                </div>
            </div>

        </div>
    </div>

    <script>
        let canvas;
        let saveFormat = 'png';
        let currentZoom = 1;

        // Selection / Region state variables
        let isSelectionMode = false;
        let isDrawingSelection = false;
        let selectionRect = null;
        let startX, startY;

        function initCanvas() {
            const w = parseInt(document.getElementById('canvasW').value, 10) || 1200;
            const h = parseInt(document.getElementById('canvasH').value, 10) || 800;

            canvas = new fabric.Canvas('c', {
                width: w,
                height: h,
                backgroundColor: '#ffffff',
                preserveObjectStacking: true
            });

            canvas.on('selection:created', onObjSelected);
            canvas.on('selection:updated', onObjSelected);
            canvas.on('selection:cleared', onObjCleared);

            // Selection ë§ˆìš°ìŠ¤ í›…
            canvas.on('mouse:down', onMouseDown);
            canvas.on('mouse:move', onMouseMove);
            canvas.on('mouse:up', onMouseUp);

            setTimeout(resetZoom, 100); // ë Œë”ë§ í›„ ì¤Œ ë¦¬ì…‹
        }

        onload = () => {
            initCanvas();
        };

        function applyCustomSize() {
            const w = parseInt(document.getElementById('canvasW').value, 10) || 1200;
            const h = parseInt(document.getElementById('canvasH').value, 10) || 800;
            canvas.setWidth(w);
            canvas.setHeight(h);
            canvas.renderAll();
            resetZoom();
        }

        // â”€â”€â”€ Region Selection Logic â”€â”€â”€
        function startSelectionMode() {
            if (isSelectionMode) return;
            isSelectionMode = true;
            canvas.discardActiveObject();
            canvas.renderAll();

            // ìº”ë²„ìŠ¤ ì¸í„°ë™ì…˜ ì°¨ë‹¨ (ê°ì²´ ì„ íƒ ì•ˆ ë˜ê²Œ)
            canvas.forEachObject(obj => {
                obj.selectable = false;
                obj.evented = false;
            });
            canvas.defaultCursor = 'crosshair';

            // UI
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btnSelect').classList.add('active');
        }

        function cancelSelection() {
            isSelectionMode = false;
            isDrawingSelection = false;

            if (selectionRect) {
                canvas.remove(selectionRect);
                selectionRect = null;
            }

            // ê°ì²´ ìƒí˜¸ì‘ìš© ì›ë³µ
            canvas.forEachObject(obj => {
                obj.selectable = true;
                obj.evented = true;
            });
            canvas.defaultCursor = 'default';

            document.getElementById('btnSelect').classList.remove('active');
            document.getElementById('regionActionBar').classList.add('hidden');
            document.getElementById('regionActionBar').style.display = '';
            canvas.renderAll();
        }

        function onMouseDown(opt) {
            // ë‹¤ë¥¸ ê°ì²´ ì„ íƒ ì‹œ ë°±ì—… ì§€ìš°ê¸°
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj._savedSelection = null;
            }

            if (!isSelectionMode) return;

            // ê¸°ì¡´ ì„ íƒìƒì ìˆìœ¼ë©´ ì œê±° (ë°”íƒ• í´ë¦­ ì‹œ ì¬ì‘ì„± ë˜ëŠ” ì·¨ì†Œ ìš©ë„)
            if (selectionRect) {
                // í´ë¦­í•œ ê³³ì´ ì„ íƒìƒì ë‚´ë¶€ë©´ (ì‹¤ì€ evented=falseë¼ ì•ˆì¡íˆì§€ë§Œ ë³´ìˆ˜ì ìœ¼ë¡œ)
                canvas.remove(selectionRect);
                selectionRect = null;
                document.getElementById('regionActionBar').classList.add('hidden');
                document.getElementById('regionActionBar').style.display = '';
            }

            isDrawingSelection = true;
            const pointer = canvas.getPointer(opt.e);
            startX = pointer.x;
            startY = pointer.y;

            selectionRect = new fabric.Rect({
                left: startX,
                top: startY,
                originX: 'left',
                originY: 'top',
                width: 0,
                height: 0,
                fill: 'rgba(0,122,255,0.1)',
                stroke: '#007aff',
                strokeWidth: 2,
                strokeDashArray: [5, 5],
                selectable: false, // ë§Œë“¤ì–´ì§„ í›„ì—ë„ ì„ íƒ ì•ˆë˜ê²Œ
                evented: false,
                strokeUniform: true
            });
            canvas.add(selectionRect);
        }

        function onMouseMove(opt) {
            if (!isDrawingSelection) return;
            const pointer = canvas.getPointer(opt.e);

            if (startX > pointer.x) {
                selectionRect.set({ left: Math.abs(pointer.x) });
            }
            if (startY > pointer.y) {
                selectionRect.set({ top: Math.abs(pointer.y) });
            }

            selectionRect.set({ width: Math.abs(startX - pointer.x) });
            selectionRect.set({ height: Math.abs(startY - pointer.y) });
            canvas.renderAll();
        }

        function onMouseUp(opt) {
            if (!isDrawingSelection) return;
            isDrawingSelection = false;

            if (selectionRect && selectionRect.width > 20 && selectionRect.height > 20) {
                // ì˜ì—­ ê·¸ë¦¬ê¸° ì„±ê³µì‹œ ì•¡ì…˜ë°” ë„ì›€
                document.getElementById('regionActionBar').classList.remove('hidden');
                document.getElementById('regionActionBar').style.display = 'flex'; // hidden ë®ì–´ì“°ê¸° ìœ„í•´
            } else {
                // ë„ˆë¬´ ì‘ìœ¼ë©´ ì‹¤ìˆ˜ë¡œ ê°„ì£¼í•˜ê³  ì·¨ì†Œ
                if (selectionRect) canvas.remove(selectionRect);
                selectionRect = null;
            }
            canvas.renderAll();
        }

        // â”€â”€â”€ Region Action Functions â”€â”€â”€

        // 1. ìë¥´ê¸° (Crop Canvas)
        function cropByRegion() {
            if (!selectionRect) return;

            const rWidth = parseInt(selectionRect.width, 10);
            const rHeight = parseInt(selectionRect.height, 10);
            const rLeft = selectionRect.left;
            const rTop = selectionRect.top;

            // ëª¨ë“  ê°ì²´ì˜ ì¢Œí‘œë¥¼ rLeft, rTop ë§Œí¼ ë¹¼ì„œ ì´ë™
            canvas.forEachObject(obj => {
                if (obj === selectionRect) return; // ìì‹  ì œì™¸
                obj.left -= rLeft;
                obj.top -= rTop;
                obj.setCoords();
            });

            // ë°°ê²½ ì´ë¯¸ì§€ê°€ í†µìœ¼ë¡œ ë“¤ì–´ê°€ ìˆìœ¼ë©´ ë°°ê²½ ì‚­ì œ (ì˜ë¼ë‚¼ ìˆ˜ ì—†ê¸° ë•Œë¬¸ - ë³´í†µ Crop ì‹œ ë°°ê²½ìƒ‰ ìœ„ë¡œ ì˜¬ë¦¼)
            if (canvas.backgroundImage) {
                // ì›ë³¸ ë°°ê²½ì„ ê·¸ëƒ¥ ì´ë¯¸ì§€ ê°ì²´ë¡œ ë°”ê¿”ì„œ ì˜ë¼ë‚´ê²Œ ë§Œë“œëŠ” ê¼¼ìˆ˜ë„ ìˆìœ¼ë‚˜ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì¼ë‹¨ backgroundImg ì œê±° (ì›ë˜ ìº”ë²„ìŠ¤ ì˜ë¼ë‚´ëŠ” ìš©ë„)
                const bgImg = canvas.backgroundImage;
                bgImg.left -= rLeft;
                bgImg.top -= rTop;
                canvas.backgroundImage = null;
                canvas.backgroundColor = '#ffffff';
                canvas.add(bgImg);
                canvas.sendToBack(bgImg);
            }

            // ìº”ë²„ìŠ¤ í¬ê¸° ì¤„ì„
            document.getElementById('canvasW').value = rWidth;
            document.getElementById('canvasH').value = rHeight;
            canvas.setWidth(rWidth);
            canvas.setHeight(rHeight);

            cancelSelection();
            resetZoom();
        }

        // 2. ë¶€ë¶„ í•„í„° (ëª¨ìì´í¬ / ë¸”ëŸ¬)
        function filterByRegion(filterType) {
            if (!selectionRect) return;

            // í™”ë©´ ìº¡ì³ í›„ í•´ë‹¹ ì˜ì—­ë§Œ ì˜ë¼ì„œ í•„í„° ë¨¹ì¸ ìƒˆ ì¡°ê°ì„ ì–¹ê¸°
            // ìš°ì„  selectionRect ìˆ¨ê¸°ê¸°
            selectionRect.visible = false;
            canvas.renderAll();

            const rLeft = selectionRect.left;
            const rTop = selectionRect.top;
            const rWidth = selectionRect.width;
            const rHeight = selectionRect.height;

            // ì „ì²´ ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
            const dataURL = canvas.toDataURL({
                format: 'png',
                multiplier: 1 // 1:1 ëŒ€ì‘
            });

            // ê·¸ ë‹¤ìŒ ë³µêµ¬
            selectionRect.visible = true;
            canvas.renderAll();

            fabric.Image.fromURL(dataURL, function (img) {
                // ì˜ë¼ë‚¼ êµ¬ì—­(ì˜ì—­ ë°–ì€ ì•ˆë³´ì´ê²Œ crop)ë§Œ ì„¤ì •
                img.set({
                    cropX: rLeft,
                    cropY: rTop,
                    width: rWidth,
                    height: rHeight,
                    left: rLeft,
                    top: rTop,
                    originX: 'left',
                    originY: 'top',
                    selectable: true
                });

                // ì§€ì •ëœ í•„í„° ì ìš©
                if (filterType === 'pixelate') {
                    img.filters.push(new fabric.Image.filters.Pixelate({ blocksize: 10 }));
                } else if (filterType === 'blur') {
                    img.filters.push(new fabric.Image.filters.Blur({ blur: 0.1 }));
                }

                img.applyFilters();
                canvas.add(img);

                cancelSelection(); // ì„ íƒ ëª¨ë“œ ì¢…ë£Œ (ìƒˆ ê°ì²´ë¡œ ë–¨ì–´ì§)
                canvas.setActiveObject(img);
            });
        }

        function resizeCanvasToImage(img) {
            document.getElementById('canvasW').value = img.width;
            document.getElementById('canvasH').value = img.height;
            canvas.setWidth(img.width);
            canvas.setHeight(img.height);
            resetZoom();
        }

        document.querySelectorAll('.fmt-btn').forEach(b => b.onclick = () => {
            document.querySelectorAll('.fmt-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            saveFormat = b.dataset.fmt;
        });

        function onObjSelected(e) {
            // ìë¥´ê¸° ì¤‘ì´ë©´ ë¬´ì‹œ
            if (isSelectionMode) return;

            const obj = e.selected[0];
            if (!obj) return;
            document.getElementById('objPropsPanel').classList.remove('hidden');

            // ìƒ‰ìƒ ì—°ë™
            if (obj.fill && typeof obj.fill === 'string') {
                document.getElementById('objColor').value = obj.fill;
                document.getElementById('objColorHex').textContent = obj.fill.toUpperCase();
            }

            // í…ìŠ¤íŠ¸ ì†ì„±ì°½ í‘œì‹œ í† ê¸€
            const isText = (obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text');
            document.getElementById('textPropsBar').classList.toggle('hidden', !isText);

            if (isText) {
                document.getElementById('fontFamily').value = obj.fontFamily || 'Pretendard Variable';
                document.getElementById('btnBold').classList.toggle('active', obj.fontWeight === 'bold');
                document.getElementById('btnItalic').classList.toggle('active', obj.fontStyle === 'italic');

                // í…ìŠ¤íŠ¸ ì¶”ê°€ ì†ì„± ë°˜ì˜
                // ì‚¬ìš©ìê°€ ìº”ë²„ìŠ¤ì—ì„œ ì½”ë„ˆë¥¼ ë‹¹ê²¨ scaleì„ ë°”ê¿€ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹œê°ì  ìµœì¢… í°íŠ¸ í¬ê¸°ë¥¼ ë³´ì—¬ì¤Œ
                document.getElementById('fontSize').value = Math.round((obj.fontSize || 40) * (obj.scaleX || 1));

                document.getElementById('textStrokeColor').value = obj.stroke || '#ffffff';
                document.getElementById('textStrokeWidth').value = obj.strokeWidth || 0;

                if (obj.textBackgroundColor) {
                    document.getElementById('textBgColor').value = obj.textBackgroundColor;
                    document.getElementById('textBgColorHex').textContent = obj.textBackgroundColor.toUpperCase();
                } else {
                    document.getElementById('textBgColorHex').textContent = 'None';
                }
            }

            // ì´ë¯¸ì§€ í•„í„° ì†ì„±ì°½ í‘œì‹œ í† ê¸€
            const isImage = (obj.type === 'image');
            // document.getElementById('imageFiltersBar').classList.toggle('hidden', !isImage); // ë¶€ë¶„ í•„í„° íˆ´(Region Selection)ë¡œ ëŒ€ì²´í•˜ë¯€ë¡œ ìš°ì¸¡ í•„í„° ì˜µì…˜ì€ êµ³ì´ ë§‰ì§€ ì•Šìœ¼ë‚˜ ë¡œì§ êµ¬ì¡°ë¥¼ ìœ„í•´ ë‚¨ê¹€
            document.getElementById('imageFiltersBar').classList.toggle('hidden', !isImage);

            if (isImage) {
                // í˜„ì¬ ì ìš©ëœ í•„í„° ìƒíƒœë¥¼ UIì— ë°˜ì˜
                document.getElementById('chkGrayscale').checked = !!obj.filters.find(f => f && f.type === 'Grayscale');
                document.getElementById('chkSepia').checked = !!obj.filters.find(f => f && f.type === 'Sepia');
                const blurF = obj.filters.find(f => f && f.type === 'Blur');
                document.getElementById('chkBlur').checked = !!blurF;
                if (blurF) document.getElementById('blurValue').value = blurF.blur;

                const pixF = obj.filters.find(f => f && f.type === 'Pixelate');
                document.getElementById('chkPixelate').checked = !!pixF;
                if (pixF) document.getElementById('pixelateValue').value = pixF.blocksize;
            }

            // ê³µí†µ ì†ì„±
            document.getElementById('objOpacity').value = obj.opacity !== undefined ? obj.opacity : 1;
            document.getElementById('btnShadow').classList.toggle('active', !!obj.shadow);
        }

        function onObjCleared() {
            if (isSelectionMode) return;
            document.getElementById('objPropsPanel').classList.add('hidden');
        }

        function updateObj(key, val) {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            obj.set(key, val);
            canvas.renderAll();
        }

        // í…ìŠ¤íŠ¸ ì„ íƒ ì˜ì—­ì— ìŠ¤íƒ€ì¼ì„ ì¤„ ë•Œ Fabric.js ë‚´ë¶€ ìºì‹œ ê¼¬ì„ ë°©ì§€ (ê¸€ìê°€ ë’¤ì„ì´ëŠ” í˜„ìƒ í•´ê²°)
        function applySelectionStyle(obj, styleObj) {
            obj.setSelectionStyles(styleObj);
            // ìºì‹œì™€ í¬ê¸° ê³„ì‚° ê°•ì œ ê°±ì‹ 
            obj.initDimensions();
            obj.setCoords();
            canvas.renderAll();
        }

        document.getElementById('objColor').addEventListener('input', e => {
            const obj = canvas.getActiveObject();
            const val = e.target.value;
            document.getElementById('objColorHex').textContent = val.toUpperCase();
            if (!obj) return;

            if (obj.isEditing && obj.selectionStart !== obj.selectionEnd) {
                applySelectionStyle(obj, { fill: val });
            } else if (obj.type === 'path' || obj.type === 'line') {
                obj.set('stroke', val);
            } else {
                obj.set('fill', val);
            }
            canvas.renderAll();
        });

        // ì›¹ í°íŠ¸ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° ì „ì— ëª…ì‹œì ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì— ë¡œë“œ (ìº”ë²„ìŠ¤ ë¯¸ì ìš© ë²„ê·¸ í”½ìŠ¤)
        function updateFont(fontName) {
            const obj = canvas.getActiveObject();
            if (!obj || !(obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text')) return;

            const applyFont = () => {
                if (obj.isEditing && obj.selectionStart !== obj.selectionEnd) {
                    applySelectionStyle(obj, { fontFamily: fontName });
                } else {
                    obj.set('fontFamily', fontName);
                    canvas.renderAll();
                }
            };

            // ì‹œìŠ¤í…œ ê¸°ë³¸ í°íŠ¸ëŠ” ê·¸ëƒ¥ ë°”ë¡œ ì ìš©
            if (fontName === 'sans-serif') {
                applyFont();
                return;
            }

            // ì›¹ í°íŠ¸ëŠ” document.fonts.loadë¥¼ í†µí•´ í™•ì‹¤íˆ ë¡œë“œëœ í›„ ì ìš©í•´ì•¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì§
            document.fonts.load(`16px "${fontName}"`).then(() => {
                applyFont();
            }).catch(err => {
                // ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ ì¼ë‹¨ ì ìš© ì‹œë„
                console.warn('Font load error:', err);
                applyFont();
            });
        }

        // í…ìŠ¤íŠ¸ í¬ê¸° ì§ì ‘ ì…ë ¥ ì‹œ í¬ê¸° ì¡°ì ˆ
        function updateTextSize(val) {
            const obj = canvas.getActiveObject();
            if (!obj || !(obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text')) return;
            const size = parseInt(val, 10);
            if (isNaN(size)) return;

            if (obj.isEditing && obj.selectionStart !== obj.selectionEnd) {
                applySelectionStyle(obj, { fontSize: size });
            } else {
                // scaleX, scaleYë¥¼ ì‹œê°ì ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê³  ì‹¤ì œ fontSizeë¥¼ ë°˜ì˜
                obj.set({ fontSize: size, scaleX: 1, scaleY: 1 });
                canvas.renderAll();
            }
        }

        // í…ìŠ¤íŠ¸ ì™¸ê³½ì„  (Stroke)
        function updateTextOutline() {
            const obj = canvas.getActiveObject();
            if (!obj || !(obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text')) return;
            const color = document.getElementById('textStrokeColor').value;
            const width = parseInt(document.getElementById('textStrokeWidth').value, 10);

            if (obj.isEditing && obj.selectionStart !== obj.selectionEnd) {
                applySelectionStyle(obj, { stroke: color, strokeWidth: width });
            } else {
                obj.set({ stroke: color, strokeWidth: width });
                canvas.renderAll();
            }
        }

        // í…ìŠ¤íŠ¸ ë°°ê²½ (Highlight)
        function updateTextBg(val) {
            const obj = canvas.getActiveObject();
            const hexLbl = document.getElementById('textBgColorHex');

            if (!val) {
                hexLbl.textContent = 'None';
            } else {
                hexLbl.textContent = val.toUpperCase();
            }

            if (!obj || !(obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text')) return;

            if (obj.isEditing && obj.selectionStart !== obj.selectionEnd) {
                applySelectionStyle(obj, { textBackgroundColor: val || null });
            } else {
                obj.set('textBackgroundColor', val || null);
                canvas.renderAll();
            }
        }

        function toggleStyle(type) {
            const obj = canvas.getActiveObject();
            if (!obj || !(obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text')) return;

            const isSelection = obj.isEditing && obj.selectionStart !== obj.selectionEnd;

            if (type === 'bold') {
                const currentBold = obj.fontWeight === 'bold';
                const newVal = currentBold ? 'normal' : 'bold';
                if (isSelection) applySelectionStyle(obj, { fontWeight: newVal });
                else {
                    obj.set('fontWeight', newVal);
                    canvas.renderAll();
                }
                document.getElementById('btnBold').classList.toggle('active', newVal === 'bold');
            } else if (type === 'italic') {
                const currentItalic = obj.fontStyle === 'italic';
                const newVal = currentItalic ? 'normal' : 'italic';
                if (isSelection) applySelectionStyle(obj, { fontStyle: newVal });
                else {
                    obj.set('fontStyle', newVal);
                    canvas.renderAll();
                }
                document.getElementById('btnItalic').classList.toggle('active', newVal === 'italic');
            }
        }

        function toggleShadow() {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            if (obj.shadow) {
                obj.set('shadow', null);
                document.getElementById('btnShadow').classList.remove('active');
            } else {
                obj.set('shadow', new fabric.Shadow({
                    color: 'rgba(0,0,0,0.5)',
                    blur: 20, offsetX: 0, offsetY: 10
                }));
                document.getElementById('btnShadow').classList.add('active');
            }
            canvas.renderAll();
        }

        // ì´ë¯¸ì§€ í•„í„° ëª¨ìŒ ê´€ë¦¬ í•¨ìˆ˜
        function applyFilters() {
            const obj = canvas.getActiveObject();
            if (!obj || obj.type !== 'image') return;

            // ê¸°ì¡´ í•„í„° ì´ˆê¸°í™” ë°°ì—´
            obj.filters = [];

            if (document.getElementById('chkGrayscale').checked) {
                obj.filters.push(new fabric.Image.filters.Grayscale());
            }
            if (document.getElementById('chkSepia').checked) {
                obj.filters.push(new fabric.Image.filters.Sepia());
            }
            if (document.getElementById('chkBlur').checked) {
                // webgl ì§€ì› ì—¬ë¶€ ë¬¸ì œë¡œ ê°€ë” blurê°€ ì•ˆ ë¨¹ì„ ìˆ˜ ìˆìŒ - fabricì˜ canvas backend fallback
                obj.filters.push(new fabric.Image.filters.Blur({
                    blur: parseFloat(document.getElementById('blurValue').value)
                }));
            }
            if (document.getElementById('chkPixelate').checked) {
                obj.filters.push(new fabric.Image.filters.Pixelate({
                    blocksize: parseInt(document.getElementById('pixelateValue').value, 10)
                }));
            }

            // í•„í„° ì ìš© (ë¹„ë™ê¸° ì²˜ë¦¬)
            obj.applyFilters();
            canvas.renderAll();
        }

        function deleteObj() {
            if (isSelectionMode) return; // ì„ íƒëª¨ë“œ ì¤‘ ì‚­ì œ ë°©ì§€
            const objects = canvas.getActiveObjects();
            if (!objects.length) return;
            objects.forEach(o => canvas.remove(o));
            canvas.discardActiveObject();
            canvas.renderAll();
        }

        window.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace') && !document.activeElement.matches('input, textarea, select, [contenteditable]')) {
                deleteObj();
            }
        });

        function moveLayer(dir) {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            if (dir === 'up') canvas.bringForward(obj);
            else canvas.sendBackwards(obj);
        }

        function getCenter() { return { x: canvas.width / 2, y: canvas.height / 2 }; }

        function addText(text = 'ì´ê³³ì„ ë”ë¸”í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”') {
            const center = getCenter();
            const t = new fabric.Textbox(text, {
                left: center.x, top: center.y, originX: 'center', originY: 'center',
                fontSize: Math.max(24, Math.floor(canvas.height * 0.08)), fill: '#1d1d1f',
                fontFamily: 'Pretendard Variable', fontWeight: 'bold',
                textAlign: 'center',
                width: Math.min(600, canvas.width - 100)
            });
            canvas.add(t);
            canvas.setActiveObject(t);
        }

        function addShape(type) {
            const center = getCenter();
            let obj;
            const baseDim = Math.min(canvas.width, canvas.height) * 0.3;

            if (type === 'rect') {
                obj = new fabric.Rect({ left: center.x, top: center.y, originX: 'center', originY: 'center', width: baseDim * 1.5, height: baseDim, fill: '#cfd4de', rx: 8, ry: 8 });
            } else if (type === 'circle') {
                obj = new fabric.Circle({ left: center.x, top: center.y, originX: 'center', originY: 'center', radius: baseDim / 2, fill: '#5f6fdd' });
            } else if (type === 'triangle') {
                obj = new fabric.Triangle({ left: center.x, top: center.y, originX: 'center', originY: 'center', width: baseDim, height: baseDim, fill: '#ffbd2e' });
            } else if (type === 'line') {
                obj = new fabric.Line([center.x - baseDim, center.y, center.x + baseDim, center.y], {
                    stroke: '#1d1d1f',
                    strokeWidth: 8,
                    originX: 'center',
                    originY: 'center'
                });
            } else if (type === 'heart') {
                const path = "M 272.70141,238.71731 C 206.46141,238.71731 152.70146,292.4773 152.70146,358.71731 C 152.70146,493.47282 288.63461,528.80461 381.26391,662.02535 C 468.83815,529.62199 609.82641,489.17075 609.82641,358.71731 C 609.82641,292.4773 556.06651,238.71731 489.82641,238.71731 C 441.77681,238.71731 400.42481,266.90222 381.26391,309.51385 C 362.10311,266.90222 320.75111,238.71731 272.70141,238.71731 z";
                obj = new fabric.Path(path, { left: center.x, top: center.y, originX: 'center', originY: 'center', fill: '#ff5f57' });
                // Scale path to fit baseDim
                const bound = obj.getBoundingRect();
                obj.scale(baseDim / Math.max(bound.width, bound.height));
            } else if (type === 'star') {
                const path = "M 119.349 27.601 L 140.404 90.963 L 206.848 91.56 L 153.305 131.25 L 173.238 194.88 L 119.349 156.4 L 65.461 194.88 L 85.393 131.25 L 31.851 91.56 L 98.295 90.963 Z";
                obj = new fabric.Path(path, { left: center.x, top: center.y, originX: 'center', originY: 'center', fill: '#ffbd2e' });
                const bound = obj.getBoundingRect();
                obj.scale(baseDim / Math.max(bound.width, bound.height));
            } else if (type === 'bolt') {
                const path = "M 152.33 13.92 L 63.85 158.42 L 129.23 158.42 L 102.34 290.79 L 210.89 126.96 L 142.14 126.96 Z";
                obj = new fabric.Path(path, { left: center.x, top: center.y, originX: 'center', originY: 'center', fill: '#ffbd2e' });
                const bound = obj.getBoundingRect();
                obj.scale(baseDim / Math.max(bound.width, bound.height));
            } else if (type === 'smile') {
                // simple face svg path
                const path = "M 100 0 A 100 100 0 1 0 100 200 A 100 100 0 1 0 100 0 Z M 65 65 A 15 15 0 1 1 65 95 A 15 15 0 1 1 65 65 Z M 135 65 A 15 15 0 1 1 135 95 A 15 15 0 1 1 135 65 Z M 100 150 C 70 150 50 120 50 120 L 65 110 C 65 110 80 135 100 135 C 120 135 135 110 135 110 L 150 120 C 150 120 130 150 100 150 Z";
                obj = new fabric.Path(path, { left: center.x, top: center.y, originX: 'center', originY: 'center', fill: '#ffbd2e' });
                const bound = obj.getBoundingRect();
                obj.scale(baseDim / Math.max(bound.width, bound.height));
            }

            if (obj) {
                canvas.add(obj);
                canvas.setActiveObject(obj);
            }
        }

        function addImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                fabric.Image.fromURL(ev.target.result, function (img) {
                    img.set({ left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center' });
                    if (img.width > canvas.width * 0.8) {
                        img.scaleToWidth(canvas.width * 0.8);
                    }
                    canvas.add(img);
                    canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        document.getElementById('bgColor').addEventListener('input', e => {
            const val = e.target.value;
            canvas.backgroundColor = val;
            canvas.backgroundImage = null;
            document.getElementById('bgColorHex').textContent = val.toUpperCase();
            canvas.renderAll();
        });

        document.getElementById('bgImageInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                fabric.Image.fromURL(ev.target.result, function (img) {
                    resizeCanvasToImage(img);
                    img.set({ originX: 'center', originY: 'center', left: canvas.width / 2, top: canvas.height / 2 });
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                });
            };
            reader.readAsDataURL(f);
            e.target.value = '';
        });

        function downloadImage() {
            canvas.discardActiveObject();
            canvas.renderAll();
            const dataUrl = canvas.toDataURL({ format: saveFormat, quality: 0.92, multiplier: 1 });
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `exported_image_${Date.now()}.${saveFormat}`;
            a.click();
        }

        function saveJson() {
            const obj = canvas.toJSON(['id', 'opacity', 'shadow']);
            obj.customW = canvas.width;
            obj.customH = canvas.height;
            const json = JSON.stringify(obj);
            const blob = new Blob([json], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `image_project_${Date.now()}.json`;
            a.click();
        }

        function loadJson(e) {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.customW && data.customH) {
                        document.getElementById('canvasW').value = data.customW;
                        document.getElementById('canvasH').value = data.customH;
                        canvas.setWidth(data.customW);
                        canvas.setHeight(data.customH);
                    }
                    canvas.loadFromJSON(data, function () {
                        if (!canvas.backgroundColor) canvas.backgroundColor = '#ffffff';
                        canvas.renderAll();
                        resetZoom();
                    });
                } catch (err) {
                    alert("ì˜¬ë°”ë¥¸ í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
            };
            reader.readAsText(f);
            e.target.value = '';
        }

        // â”€â”€â”€ Scaled Canvas View (Zoom) â”€â”€â”€
        function getFitScale() {
            const ws = document.getElementById('workspace');
            const availW = ws.clientWidth - 40; // padding
            const availH = ws.clientHeight - 40;
            if (availW <= 0 || availH <= 0) return 1;
            const scaleX = availW / canvas.width;
            const scaleY = availH / canvas.height;
            return Math.min(scaleX, scaleY, 1); // 1ë³´ë‹¤ ì»¤ì§€ì§„ ì•Šê²Œ (ì›ë³¸ ë¹„ìœ¨ìœ ì§€)
        }

        function applyZoom() {
            document.getElementById('zoomWrapper').style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomLabel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function resetZoom() {
            currentZoom = getFitScale();
            applyZoom();
        }

        function changeZoom(delta) {
            currentZoom += delta;
            if (currentZoom < 0.1) currentZoom = 0.1;
            if (currentZoom > 3) currentZoom = 3;
            applyZoom();
        }

        window.addEventListener('resize', () => { setTimeout(resetZoom, 100); });
    </script>
</body>

</html>