<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Optimizer Toolkit | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../ui-utils.js"></script>
<script src="../../vendor/jszip.min.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.drop-zone{border:1px dashed var(--border);border-radius:12px;padding:20px;text-align:center;background:var(--surface2);cursor:pointer}
.drop-zone input{display:none}
.opt-result-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.opt-item{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--surface2)}
.opt-item-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
.opt-name{font-size:12px;font-family:var(--font-mono);word-break:break-all;max-width:100%}
.opt-meta{font-size:11px;color:var(--text-dim);margin-top:4px}
.opt-actions{margin-top:0}
.opt-progress-wrap{margin-top:8px}
.opt-progress-bar{width:100%;height:8px}
@media(max-width:768px){
  .drop-zone{padding:16px}
  .opt-item{padding:10px}
  .opt-item-top{gap:8px}
}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header">
    <h1>Image <span>Optimizer Toolkit</span></h1>
    <p>// ë‹¤ì¤‘ ì´ë¯¸ì§€ ìš©ëŸ‰ ì¶•ì†Œ Â· í•´ìƒë„ ë¦¬ì‚¬ì´ì¦ˆ Â· í¬ë§· ë³€í™˜ Â· ZIP ë‹¤ìš´ë¡œë“œ</p>
  </div>

  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title"><div class="dot"></div>INPUT</div>
        </div>

        <div class="setting-group" data-level="basic">
          <div class="setting-title">Source</div>
          <label class="drop-zone" for="imgFiles">
            <input id="imgFiles" type="file" accept="image/*" multiple>
            ì´ë¯¸ì§€ íŒŒì¼ì„ í´ë¦­/ë“œë¡­í•˜ì—¬ ì¶”ê°€ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)
          </label>
          <div class="text-muted mt-8" id="fileSummary">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>
        </div>

        <div class="setting-group" data-level="basic">
          <div class="setting-title">Optimization</div>
          <div class="options-row options-row-2">
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Format</span>
                <div class="toggle-group">
                  <button class="toggle-btn fmt-btn active" data-fmt="jpeg">JPG</button>
                  <button class="toggle-btn fmt-btn" data-fmt="webp">WEBP</button>
                  <button class="toggle-btn fmt-btn" data-fmt="png">PNG</button>
                </div>
              </div>
            </div>
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Quality</span>
                <input id="quality" class="table-name-input input-xs" type="number" min="10" max="100" value="82">
              </div>
            </div>
          </div>

          <div class="options-row options-row-2">
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Mode</span>
                <div class="toggle-group">
                  <button class="toggle-btn qmode-btn active" data-qmode="manual">Manual</button>
                  <button class="toggle-btn qmode-btn" data-qmode="target">Target Size</button>
                </div>
              </div>
            </div>
            <div class="options-item hidden" id="targetSizeWrap">
              <div class="options-bar row-tight">
                <span class="options-label">Target KB</span>
                <input id="targetKB" class="table-name-input input-xs" type="number" min="30" max="2000" value="300">
              </div>
            </div>
          </div>

          <div class="options-row options-row-2">
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Preset</span>
                <select id="preset" class="table-name-input input-md">
                  <option value="custom">Custom</option>
                  <option value="blog-og">Blog OG (1200)</option>
                  <option value="instagram-feed">Instagram Feed (1080)</option>
                  <option value="instagram-story">Instagram Story (1920)</option>
                  <option value="youtube-thumb">YouTube Thumb (1280)</option>
                  <option value="kakao-share">Kakao Share (800)</option>
                </select>
              </div>
            </div>
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Max Edge</span>
                <input id="maxEdge" class="table-name-input input-sm" type="number" min="320" max="8000" value="1920">
              </div>
            </div>
          </div>

          <div class="options-row options-row-2">
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Filename</span>
                <div class="toggle-group">
                  <button class="toggle-btn name-btn active" data-name="suffix">_opt suffix</button>
                  <button class="toggle-btn name-btn" data-name="replace">replace</button>
                </div>
              </div>
            </div>
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">No Gain</span>
                <div class="toggle-group">
                  <button class="toggle-btn nogain-btn active" data-nogain="keep">Keep Original</button>
                  <button class="toggle-btn nogain-btn" data-nogain="force">Force Output</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button class="generate-btn" data-shortcut="Ctrl + Enter" onclick="optimizeAll()">âš¡ ìµœì í™” ì‹¤í–‰</button>
      </div>
    </div>

    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="empty-state">
          <div class="icon">ğŸ—œï¸</div>
          <p>ì´ë¯¸ì§€ë¥¼ ì„ íƒí•œ ë’¤ ìµœì í™”ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</p>
        </div>
      </div>
    </div>
  </div>

  <footer>// Image Compression & Resize Toolkit</footer>
</div>

<script>
let files = [];
let outFmt = 'jpeg';
let namingMode = 'suffix';
let qualityMode = 'manual';
let noGainMode = 'keep';
const outState = [];

const fmtMime = { jpeg: 'image/jpeg', webp: 'image/webp', png: 'image/png' };
const fmtExt  = { jpeg: 'jpg', webp: 'webp', png: 'png' };

function bytes(n){
  if(n < 1024) return `${n} B`;
  if(n < 1024*1024) return `${(n/1024).toFixed(1)} KB`;
  return `${(n/1024/1024).toFixed(2)} MB`;
}

function setFiles(list){
  files = Array.from(list || []).filter(f => /^image\//.test(f.type));
  const total = files.reduce((s,f)=>s+f.size,0);
  document.getElementById('fileSummary').textContent = files.length
    ? `${files.length}ê°œ íŒŒì¼ Â· ì›ë³¸ í•©ê³„ ${bytes(total)}`
    : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
}

document.getElementById('imgFiles').addEventListener('change', e => setFiles(e.target.files));

document.querySelectorAll('.fmt-btn').forEach(b => b.addEventListener('click', ()=>{
  document.querySelectorAll('.fmt-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); outFmt = b.dataset.fmt;
  document.getElementById('quality').disabled = outFmt === 'png';
}));

document.querySelectorAll('.name-btn').forEach(b => b.addEventListener('click', ()=>{
  document.querySelectorAll('.name-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); namingMode = b.dataset.name;
}));

document.querySelectorAll('.qmode-btn').forEach(b => b.addEventListener('click', ()=>{
  document.querySelectorAll('.qmode-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  qualityMode = b.dataset.qmode;
  document.getElementById('targetSizeWrap').classList.toggle('hidden', qualityMode !== 'target');
}));

document.querySelectorAll('.nogain-btn').forEach(b => b.addEventListener('click', ()=>{
  document.querySelectorAll('.nogain-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  noGainMode = b.dataset.nogain;
}));

document.getElementById('preset').addEventListener('change', e => {
  const p = e.target.value;
  const map = {
    'blog-og': { edge:1200, fmt:'jpeg', q:84 },
    'instagram-feed': { edge:1080, fmt:'jpeg', q:86 },
    'instagram-story': { edge:1920, fmt:'jpeg', q:82 },
    'youtube-thumb': { edge:1280, fmt:'jpeg', q:82 },
    'kakao-share': { edge:800, fmt:'jpeg', q:84 },
  };
  if (!map[p]) return;
  document.getElementById('maxEdge').value = map[p].edge;
  document.getElementById('quality').value = map[p].q;
  outFmt = map[p].fmt;
  document.querySelectorAll('.fmt-btn').forEach(x=>x.classList.toggle('active', x.dataset.fmt===outFmt));
  document.getElementById('quality').disabled = outFmt === 'png';
});

function buildOutputName(name){
  const base = name.replace(/\.[^.]+$/, '');
  const ext = fmtExt[outFmt];
  return namingMode === 'replace' ? `${base}.${ext}` : `${base}_opt.${ext}`;
}

function fileToImage(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function canvasToBlob(canvas, mime, quality){
  return new Promise(resolve => canvas.toBlob(resolve, mime, quality));
}

function renderOutput(){
  const output = document.getElementById('outputPanel');
  if(!outState.length){
    output.innerHTML = `<div class="panel"><div class="empty-state"><div class="icon">ğŸ—œï¸</div><p>ì´ë¯¸ì§€ë¥¼ ì„ íƒí•œ ë’¤ ìµœì í™”ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</p></div></div>`;
    return;
  }
  const done = outState.filter(x=>x.done);
  const inBytes = done.reduce((s,x)=>s+x.inSize,0);
  const outBytes = done.reduce((s,x)=>s+x.outSize,0);
  const ratio = inBytes ? ((1 - outBytes/inBytes)*100) : 0;

  output.innerHTML = `
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title"><div class="dot"></div>RESULT</div>
        <div class="text-muted">${done.length}/${outState.length} Â· ${bytes(inBytes)} â†’ ${bytes(outBytes)} (${ratio.toFixed(1)}%)</div>
      </div>
      <div class="download-actions mt-10">
        <button class="download-btn all full" id="zipBtn" ${done.length ? '' : 'disabled'}>â¬‡ ZIP ë‹¤ìš´ë¡œë“œ</button>
      </div>
      <div class="opt-result-list">
        ${outState.map((r,i)=>`
          <div class="opt-item">
            <div class="opt-item-top">
              <div>
                <div class="opt-name">${UIUtils.escHtml(r.name)}</div>
                <div class="opt-meta">${r.done ? `${bytes(r.inSize)} â†’ ${bytes(r.outSize)} (${((1-r.outSize/r.inSize)*100).toFixed(1)}%)${r.note ? ` Â· ${r.note}` : ''}` : 'ì²˜ë¦¬ì¤‘...'}</div>
              </div>
              <div class="download-actions opt-actions">
                <button class="download-btn single" data-dl="${i}" ${r.done ? '' : 'disabled'}>â¬‡ ë‹¤ìš´ë¡œë“œ</button>
              </div>
            </div>
            <div class="opt-progress-wrap"><progress class="opt-progress-bar" max="100" value="${r.done?100:r.progress||0}"></progress></div>
          </div>`).join('')}
      </div>
    </div>`;

  output.querySelectorAll('[data-dl]').forEach(btn=>btn.addEventListener('click', ()=>{
    const r = outState[Number(btn.dataset.dl)];
    if(!r?.blob) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(r.blob);
    a.download = r.outName;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }));

  output.querySelector('#zipBtn')?.addEventListener('click', downloadZip);
}

async function encodeWithQuality(canvas, mime, q){
  return canvasToBlob(canvas, mime, q);
}

async function findQualityForTarget(canvas, mime, targetBytes){
  let lo = 0.1, hi = 0.95;
  let best = await encodeWithQuality(canvas, mime, hi);
  if (best.size <= targetBytes) return best;

  for(let i=0;i<8;i++){
    const mid = (lo + hi) / 2;
    const blob = await encodeWithQuality(canvas, mime, mid);
    if (blob.size <= targetBytes) {
      best = blob;
      lo = mid;
    } else {
      hi = mid;
    }
  }
  return best;
}

async function optimizeAll(){
  if(!files.length){
    UIUtils.showError('outputPanel', 'ì´ë¯¸ì§€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  const maxEdge = Math.max(320, Math.min(8000, parseInt(document.getElementById('maxEdge').value || '1920',10)));
  const quality = Math.max(0.1, Math.min(1, parseInt(document.getElementById('quality').value || '82',10)/100));
  const targetKB = Math.max(30, Math.min(2000, parseInt(document.getElementById('targetKB').value || '300',10)));
  const mime = fmtMime[outFmt];

  outState.length = 0;
  files.forEach(f=>outState.push({ name:f.name, inSize:f.size, outSize:0, outName:buildOutputName(f.name), blob:null, done:false, progress:10, note:'' }));
  renderOutput();

  for(let i=0;i<files.length;i++){
    const f = files[i];
    try{
      const img = await fileToImage(f);
      const ratio = Math.min(1, maxEdge / Math.max(img.width, img.height));
      const w = Math.max(1, Math.round(img.width * ratio));
      const h = Math.max(1, Math.round(img.height * ratio));
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      outState[i].progress = 70;
      renderOutput();
      let blob;
      if (outFmt === 'png') {
        blob = await canvasToBlob(canvas, mime);
      } else if (qualityMode === 'target') {
        blob = await findQualityForTarget(canvas, mime, targetKB * 1024);
      } else {
        blob = await canvasToBlob(canvas, mime, quality);
      }

      if (noGainMode === 'keep' && blob.size >= f.size) {
        outState[i].blob = f;
        outState[i].outName = f.name;
        outState[i].outSize = f.size;
        outState[i].note = 'ì›ë³¸ ìœ ì§€';
      } else {
        outState[i].blob = blob;
        outState[i].outSize = blob.size;
        outState[i].note = '';
      }

      outState[i].done = true;
      outState[i].progress = 100;
      renderOutput();
    }catch(e){
      outState[i].done = true;
      outState[i].outSize = outState[i].inSize;
      outState[i].progress = 100;
      renderOutput();
    }
  }
}

async function downloadZip(){
  const done = outState.filter(x=>x.done && x.blob);
  if(!done.length) return;
  const zip = new JSZip();
  done.forEach(x=>zip.file(x.outName, x.blob));
  const blob = await zip.generateAsync({ type:'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `optimized_images_${Date.now()}.zip`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}

document.addEventListener('keydown', e => {
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter') optimizeAll();
});
</script>
</body>
</html>