<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blog Thumbnail Maker | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../ui-utils.js"></script>
<script src="../../image-tools-utils.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.canvas-wrap{display:flex;justify-content:center;align-items:center;padding:14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border)}
#thumbCanvas{max-width:100%;height:auto;border-radius:8px;background:#fff}
.input-area{width:100%;background:transparent;border:1px solid var(--border);outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;padding:10px 12px;resize:vertical;min-height:66px;border-radius:8px}
#padHint{font-size:10px;color:var(--text-dim)}
.main-grid > .output-panel{position:sticky;top:84px;align-self:start}
.main-grid > .output-panel .panel{max-height:calc(100vh - 110px);overflow:auto}
@media (max-width: 980px){.main-grid > .output-panel{position:static}.main-grid > .output-panel .panel{max-height:none;overflow:visible}}
/* ── Mode tabs ── */
.mode-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 16px}
.mode-tab{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;letter-spacing:.5px;padding:10px 14px;border:none;background:none;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:color .15s,border-color .15s}
.mode-tab.active{color:var(--accent);border-bottom-color:var(--accent)}.mode-tab:hover:not(.active){color:var(--text)}
/* ── Template cards ── */
.tpl-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 16px}
.tpl-card{border-radius:8px;border:2px solid var(--border);cursor:pointer;overflow:hidden;transition:border-color .15s,transform .1s;position:relative}
.tpl-card.active{border-color:var(--accent)}.tpl-card:hover{transform:translateY(-2px)}
.tpl-card-inner{width:100%;padding:8px;display:flex;flex-direction:column;gap:3px;min-height:76px}
.tpl-h1{font-size:9px;font-weight:900;line-height:1.2}.tpl-h2{font-size:8px;font-weight:700;opacity:.8}
.tpl-name{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;text-align:center;padding:4px 0;color:var(--text-muted);border-top:1px solid var(--border)}
.tpl-check{position:absolute;top:4px;right:4px;width:16px;height:16px;border-radius:50%;background:var(--accent);color:#000;font-size:10px;display:none;align-items:center;justify-content:center;font-weight:900}
.tpl-card.active .tpl-check{display:flex}
/* ── Simple mode fields ── */
.s-label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.5px;color:var(--text-muted);text-transform:uppercase;margin-bottom:5px}
.simple-textarea{width:100%;background:transparent;border:1px solid var(--border);outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;padding:10px 12px;resize:vertical;border-radius:8px}
.s-field-wrap{padding:12px 16px}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header">
    <h1>Blog <span>Thumbnail Maker</span></h1>
    <p>// 비율 선택 + 배경(단색/이미지) + 텍스트로 썸네일 생성</p>
  </div>

  <div class="main-grid">
    <div>
      <div class="panel">
        <!-- MODE TABS -->
        <div class="mode-tabs">
          <button class="mode-tab active" id="thumbTabSimple" onclick="switchThumbMode('simple')">⚡ 간편 모드</button>
          <button class="mode-tab" id="thumbTabAdv" onclick="switchThumbMode('advanced')">⚙ 고급 모드</button>
        </div>

        <!-- SIMPLE PANEL -->
        <div id="thumbSimplePanel">
          <div class="panel-header"><div class="panel-title"><div class="dot"></div>TEMPLATE</div></div>
          <div class="tpl-grid">
            <div class="tpl-card active" data-tpl="quote" onclick="applyPreset('quote');syncAdvToSimple()">
              <div class="tpl-card-inner" style="background:#5f6fdd">
                <div class="tpl-h1" style="color:#ffffff">블로그 썸네일</div>
                <div class="tpl-h2" style="color:#ffffff">Quote · 1:1</div>
              </div>
              <div class="tpl-name">Quote</div>
              <div class="tpl-check">✓</div>
            </div>
            <div class="tpl-card" data-tpl="blog" onclick="applyPreset('blog');syncAdvToSimple()">
              <div class="tpl-card-inner" style="background:#2e3f8f">
                <div class="tpl-h1" style="color:#ffffff">실전 가이드</div>
                <div class="tpl-h2" style="color:#aaccff">Blog · 4:3</div>
              </div>
              <div class="tpl-name">Blog</div>
              <div class="tpl-check">✓</div>
            </div>
            <div class="tpl-card" data-tpl="youtube" onclick="applyPreset('youtube');syncAdvToSimple()">
              <div class="tpl-card-inner" style="background:#1c1f2a">
                <div class="tpl-h1" style="color:#ffffff">유튜브 썸네일</div>
                <div class="tpl-h2" style="color:#aaaaaa">YouTube · 16:9</div>
              </div>
              <div class="tpl-name">YouTube</div>
              <div class="tpl-check">✓</div>
            </div>
            <div class="tpl-card" data-tpl="minimal" onclick="applyPreset('minimal');syncAdvToSimple()">
              <div class="tpl-card-inner" style="background:#222831">
                <div class="tpl-h1" style="color:#ffffff">미니멀 디자인</div>
                <div class="tpl-h2" style="color:#aaaaaa">Minimal · 16:9</div>
              </div>
              <div class="tpl-name">Minimal</div>
              <div class="tpl-check">✓</div>
            </div>
            <div class="tpl-card" data-tpl="terminal" onclick="applyPreset('terminal');syncAdvToSimple()">
              <div class="tpl-card-inner" style="background:#0d1321">
                <div class="tpl-h1" style="color:#4ec9b0;font-family:monospace;font-size:8px">&gt; 제목</div>
                <div class="tpl-h2" style="color:#38bdf8;opacity:1">Terminal · 16:9</div>
              </div>
              <div class="tpl-name">Terminal</div>
              <div class="tpl-check">✓</div>
            </div>
          </div>

          <div class="panel-header"><div class="panel-title"><div class="dot"></div>CONTENT</div></div>
          <div class="s-field-wrap">
            <label class="s-label">메인 텍스트 (줄바꿈 가능)</label>
            <textarea id="s-main" class="simple-textarea" style="min-height:72px" placeholder="블로그 썸네일&#10;3분 제작"></textarea>
            <label class="s-label" style="margin-top:10px">서브 텍스트</label>
            <input id="s-sub" class="table-name-input" style="width:100%" placeholder="3분만에 블로그 썸네일 만들기">
          </div>
          <div class="options-bar row-tight" style="padding:0 16px 10px;justify-content:flex-end">
            <button class="toggle-btn" onclick="loadThumbSample()">예시 불러오기</button>
          </div>

          <div class="panel-header"><div class="panel-title"><div class="dot"></div>SIZE</div></div>
          <div class="options-bar" style="padding:12px 16px;border-top:none">
            <button class="toggle-btn ratio-btn active" data-ratio="1:1">1:1</button>
            <button class="toggle-btn ratio-btn" data-ratio="16:9">16:9</button>
            <button class="toggle-btn ratio-btn" data-ratio="4:3">4:3</button>
            <button class="toggle-btn ratio-btn" data-ratio="3:2">3:2</button>
          </div>

          <div class="panel-header"><div class="panel-title"><div class="dot"></div>EXPORT</div></div>
          <div class="options-bar" style="padding:12px 16px 0;border-top:none">
            <div class="toggle-group">
              <button class="toggle-btn fmt-btn active" data-fmt="png">PNG</button>
              <button class="toggle-btn fmt-btn" data-fmt="jpeg">JPG</button>
              <button class="toggle-btn fmt-btn" data-fmt="webp">WEBP</button>
            </div>
          </div>
          <div style="padding:10px 16px 16px">
            <button class="export-btn single" style="width:100%;background:linear-gradient(135deg,#0f4db8,#2a77ff);color:#fff;border-color:rgba(66,135,255,.45)" onclick="syncSimpleToThumb();downloadThumb()">⬇ DOWNLOAD</button>
          </div>
        </div><!-- end thumbSimplePanel -->

        <!-- ADVANCED PANEL -->
        <div id="thumbAdvPanel" class="hidden">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>SETTINGS</div></div>

        <div class="setting-group">
          <div class="setting-title">Canvas & Background</div>
          <div class="options-bar">
            <span class="options-label">Ratio</span>
            <div class="toggle-group">
              <button class="toggle-btn ratio-btn active" data-ratio="1:1">1:1</button>
              <button class="toggle-btn ratio-btn" data-ratio="16:9">16:9</button>
              <button class="toggle-btn ratio-btn" data-ratio="4:3">4:3</button>
              <button class="toggle-btn ratio-btn" data-ratio="3:2">3:2</button>
            </div>
            <span class="options-label">Preset</span>
            <div class="toggle-group">
              <button class="toggle-btn preset-btn active" data-preset="quote">Quote</button>
              <button class="toggle-btn preset-btn" data-preset="blog">Blog</button>
              <button class="toggle-btn preset-btn" data-preset="youtube">YouTube</button>
              <button class="toggle-btn preset-btn" data-preset="minimal">Minimal</button>
              <button class="toggle-btn preset-btn" data-preset="terminal">Terminal</button>
            </div>
          </div>
          <div class="options-bar">
            <span class="options-label">Background</span>
            <div class="toggle-group">
              <button class="toggle-btn bgmode-btn active" data-bgmode="color">단색</button>
              <button class="toggle-btn bgmode-btn" data-bgmode="image">이미지</button>
            </div>
            <div id="bgColorBar"><input id="bgColor" type="color" value="#5f6fdd" class="table-name-input input-xs color-input"></div>
            <div id="bgImageBar" class="hidden"><input id="bgImageInput" type="file" accept="image/*"></div>
          </div>
          <div class="options-bar">
            <span class="options-label">Overlay</span>
            <div class="toggle-group">
              <button class="toggle-btn ov-btn active" data-ov="none">None</button>
              <button class="toggle-btn ov-btn" data-ov="dim">Dim</button>
              <button class="toggle-btn ov-btn" data-ov="gradient">Gradient</button>
              <button class="toggle-btn ov-btn" data-ov="vignette">Vignette</button>
            </div>
            <span class="options-label">Strength</span>
            <input id="ovStrength" type="number" value="28" min="0" max="100" class="table-name-input input-xs">
          </div>
          <div class="options-bar">
            <span class="options-label">Decor</span>
            <div class="toggle-group">
              <button class="toggle-btn decor-btn active" data-decor="quote-frame">Style 1</button>
              <button class="toggle-btn decor-btn" data-decor="double-frame">Style 2</button>
              <button class="toggle-btn decor-btn" data-decor="corner-lines">Style 3</button>
              <button class="toggle-btn decor-btn" data-decor="clean-box">Style 4</button>
              <button class="toggle-btn decor-btn" data-decor="minimal">Style 5</button>
              <button class="toggle-btn decor-btn" data-decor="terminal">Terminal</button>
              <button class="toggle-btn decor-btn" data-decor="minimal">None</button>
            </div>
            <span class="options-label">Color</span>
            <input id="decorColor" type="color" value="#ffffff" class="table-name-input input-xs color-input">
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Text Content</div>
          <div class="options-bar"><span class="options-label">Main</span></div>
          <textarea id="mainText" class="input-area" placeholder="메인 텍스트">블로그 썸네일
3분 제작</textarea>
          <div class="options-bar"><span class="options-label">Sub</span></div>
          <textarea id="subText" class="input-area" placeholder="서브 텍스트">3분만에 블로그 썸네일 만들기</textarea>

          <div class="options-bar row-tight json-action-bar">
            <span class="options-label">JSON Data</span>
            <button class="toggle-btn" onclick="openThumbJsonPopup()">JSON 입력</button>
            <button class="toggle-btn" onclick="document.getElementById('thumbJsonFile').click()">JSON 파일</button>
            <input id="thumbJsonFile" type="file" accept=".json,application/json" class="hidden">
            <button class="toggle-btn reset-icon-btn" onclick="resetThumbTextInputs()" title="입력값 초기화" aria-label="입력값 초기화">↻</button>
          </div>
          <textarea id="thumbJsonInput" class="input-area hidden" placeholder='{
  "mainText": "블로그 썸네일\n3분 제작",
  "subText": "3분만에 블로그 썸네일 만들기",
  "ratio": "1:1",
  "bgColor": "#5f6fdd",
  "decorColor": "#ffffff"
}'></textarea>
          <div id="thumbJsonHint" class="text-muted mt-8 hidden">JSON으로 텍스트/스타일/배경 옵션을 한번에 반영할 수 있어요.</div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Text Style & Position</div>
          <div class="options-bar">
            <span class="options-label">Text Color</span>
            <input id="textColor" type="color" value="#ffffff" class="table-name-input input-xs color-input">
            <span class="options-label">Stroke</span>
            <input id="strokeColor" type="color" value="#000000" class="table-name-input input-xs color-input">
            <span class="options-label">Stroke Px</span>
            <input id="strokeWidth" type="number" value="6" min="0" max="24" class="table-name-input input-xs">
          </div>
          <div class="options-bar">
            <span class="options-label">Text Area Padding</span>
            <input id="pad" type="number" value="90" min="20" max="220" class="table-name-input input-xs">
            <span class="options-label" id="padHint">값이 클수록 텍스트 폭이 좁아집니다</span>
          </div>
          <div class="options-bar">
            <span class="options-label">Main Size%</span>
            <input id="mainScale" type="number" value="100" min="50" max="180" class="table-name-input input-xs">
            <span class="options-label">Main Y%</span>
            <input id="mainY" type="number" value="43" min="10" max="85" class="table-name-input input-xs">
            <span class="options-label">Sub Size%</span>
            <input id="subScale" type="number" value="100" min="50" max="180" class="table-name-input input-xs">
            <span class="options-label">Sub Y%</span>
            <input id="subY" type="number" value="72" min="10" max="95" class="table-name-input input-xs">
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Export</div>
          <div class="options-row options-row-2">
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Save As</span>
                <div class="toggle-group">
                  <button class="toggle-btn fmt-btn active" data-fmt="png">PNG</button>
                  <button class="toggle-btn fmt-btn" data-fmt="jpeg">JPG</button>
                  <button class="toggle-btn fmt-btn" data-fmt="webp">WEBP</button>
                </div>
              </div>
            </div>
            <div class="options-item">
              <div class="options-bar row-tight">
                <span class="options-label">Quality</span>
                <input id="imgQuality" type="number" value="92" min="1" max="100" class="table-name-input input-sm">
              </div>
            </div>
          </div>
          <div class="download-actions">
            <button class="export-btn all download-btn all full" onclick="downloadThumb()">⬇ 다운로드</button>
          </div>
        </div>
        </div><!-- end thumbAdvPanel -->
      </div>
    </div>

    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="canvas-wrap">
          <canvas id="thumbCanvas" width="1200" height="1200"></canvas>
        </div>
      </div>
    </div>
  </div>
  <footer>// Thumbnail Maker</footer>
</div>

<dialog id="thumbJsonDialog" class="json-dialog">
  <div class="json-dialog-head">썸네일 JSON 입력</div>
  <textarea id="thumbJsonDialogInput" class="input-area json-dialog-input"></textarea>
  <div class="json-dialog-actions">
    <button class="toggle-btn" onclick="closeThumbJsonPopup()">취소</button>
    <button class="download-btn single" onclick="applyThumbJsonFromPopup()">적용</button>
  </div>
</dialog>

<script>
let ratio = '1:1';
let bgMode = 'color';
let bgImage = null;
let overlayMode = 'none';
let decorStyle = 'quote-frame';
let saveFormat = 'png';

const ratios = { '1:1':[1200,1200], '16:9':[1600,900], '4:3':[1200,900], '3:2':[1500,1000] };
const presets = {
  quote: {
    ratio: '1:1', bgColor: '#5f6fdd', textColor: '#ffffff', strokeColor: '#000000', strokeWidth: 6, pad: 90, ov: 'none', ovStrength: 28, decor: 'quote-frame',
    mainScale: 100, subScale: 100, mainY: 43, subY: 72,
    main: '블로그 썸네일\n3분 제작', sub: '3분만에 블로그 썸네일 만들기'
  },
  blog: {
    ratio: '4:3', bgColor: '#2e3f8f', textColor: '#ffffff', strokeColor: '#000000', strokeWidth: 5, pad: 80, ov: 'gradient', ovStrength: 32, decor: 'double-frame',
    mainScale: 100, subScale: 95, mainY: 41, subY: 73,
    main: '실전 가이드\n핵심 요약', sub: '바로 적용 가능한 블로그 포스트 템플릿'
  },
  youtube: {
    ratio: '16:9', bgColor: '#1c1f2a', textColor: '#ffffff', strokeColor: '#000000', strokeWidth: 6, pad: 70, ov: 'vignette', ovStrength: 40, decor: 'corner-lines',
    mainScale: 110, subScale: 95, mainY: 42, subY: 74,
    main: '조회수 올리는\n썸네일', sub: '클릭을 부르는 타이틀 디자인'
  },
  minimal: {
    ratio: '16:9', bgColor: '#222831', textColor: '#ffffff', strokeColor: '#000000', strokeWidth: 4, pad: 120,
    ov: 'none', ovStrength: 0, decor: 'minimal',
    mainScale: 105, subScale: 100, mainY: 43, subY: 72,
    main: '썸네일 제목\n핵심 키워드', sub: '부제목 텍스트'
  },
  terminal: {
    ratio: '16:9', bgColor: '#0d1321', textColor: '#4ec9b0', strokeColor: '#000000', strokeWidth: 0, pad: 80,
    ov: 'none', ovStrength: 0, decor: 'terminal',
    mainScale: 100, subScale: 100, mainY: 43, subY: 72,
    main: 'What is the real\nproblem?', sub: 'BLOG COVER · DEV SENSE'
  }
};

document.querySelectorAll('.ratio-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.ratio-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); ratio=b.dataset.ratio; renderThumb();
});
document.querySelectorAll('.bgmode-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.bgmode-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); bgMode=b.dataset.bgmode;
  document.getElementById('bgColorBar').classList.toggle('hidden', bgMode!=='color');
  document.getElementById('bgImageBar').classList.toggle('hidden', bgMode!=='image');
  renderThumb();
});

document.querySelectorAll('.ov-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.ov-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  overlayMode = b.dataset.ov;
  renderThumb();
});

document.querySelectorAll('.preset-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.preset-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  applyPreset(b.dataset.preset);
});

document.querySelectorAll('.decor-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.decor-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  decorStyle = b.dataset.decor;
  renderThumb();
});

document.querySelectorAll('.fmt-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.fmt-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  saveFormat = b.dataset.fmt;
});

document.getElementById('bgImageInput').addEventListener('change', e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ const img=new Image(); img.onload=()=>{ bgImage=img; renderThumb(); }; img.src=ev.target.result; };
  r.readAsDataURL(f);
});

document.getElementById('thumbJsonFile').addEventListener('change', e=>{
  const f=e.target.files?.[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    try {
      const txt = String(ev.target?.result || '');
      document.getElementById('thumbJsonInput').value = txt;
      applyThumbJsonToInputs();
    } catch (_) {
      document.getElementById('thumbJsonHint').textContent = 'JSON 파일을 읽는 중 오류가 발생했습니다.';
    }
  };
  r.readAsText(f, 'utf-8');
});

['bgColor','textColor','strokeColor','strokeWidth','mainText','subText','pad','ovStrength','mainScale','subScale','mainY','subY','decorColor'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>renderThumb());
});

function applyPreset(name){
  const p = presets[name];
  if(!p) return;

  ratio = p.ratio;
  document.querySelectorAll('.ratio-btn').forEach(x=>x.classList.toggle('active', x.dataset.ratio===ratio));

  overlayMode = p.ov;
  document.querySelectorAll('.ov-btn').forEach(x=>x.classList.toggle('active', x.dataset.ov===overlayMode));

  decorStyle = p.decor || 'quote-frame';
  document.querySelectorAll('.decor-btn').forEach(x=>x.classList.toggle('active', x.dataset.decor===decorStyle));

  document.getElementById('bgColor').value = p.bgColor;
  if (p.decorColor) document.getElementById('decorColor').value = p.decorColor;
  document.getElementById('textColor').value = p.textColor;
  document.getElementById('strokeColor').value = p.strokeColor || '#000000';
  if (p.strokeWidth != null) document.getElementById('strokeWidth').value = p.strokeWidth;
  document.getElementById('pad').value = p.pad;
  document.getElementById('ovStrength').value = p.ovStrength;
  document.getElementById('mainText').value = p.main;
  document.getElementById('subText').value = p.sub;
  if (p.mainScale) document.getElementById('mainScale').value = p.mainScale;
  if (p.subScale) document.getElementById('subScale').value = p.subScale;
  if (p.mainY) document.getElementById('mainY').value = p.mainY;
  if (p.subY) document.getElementById('subY').value = p.subY;
  document.querySelectorAll('.tpl-card').forEach(c => c.classList.toggle('active', c.dataset.tpl === name));
  document.querySelectorAll('.preset-btn').forEach(x => x.classList.toggle('active', x.dataset.preset === name));
  renderThumb();
}

function syncSimpleToThumb() {
  document.getElementById('mainText').value = document.getElementById('s-main').value;
  document.getElementById('subText').value  = document.getElementById('s-sub').value;
}

function syncAdvToSimple() {
  document.getElementById('s-main').value = document.getElementById('mainText').value;
  document.getElementById('s-sub').value  = document.getElementById('subText').value;
}

function switchThumbMode(mode) {
  const isSimple = mode === 'simple';
  if (isSimple) syncAdvToSimple();
  else syncSimpleToThumb();
  document.getElementById('thumbSimplePanel').classList.toggle('hidden', !isSimple);
  document.getElementById('thumbAdvPanel').classList.toggle('hidden', isSimple);
  document.getElementById('thumbTabSimple').classList.toggle('active', isSimple);
  document.getElementById('thumbTabAdv').classList.toggle('active', !isSimple);
  renderThumb();
}

function loadThumbSample() {
  document.getElementById('s-main').value = '블로그 썸네일\n3분 제작';
  document.getElementById('s-sub').value  = '3분만에 블로그 썸네일 만들기';
  syncSimpleToThumb();
  renderThumb();
}

['s-main','s-sub'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => { syncSimpleToThumb(); renderThumb(); });
});

function drawBg(ctx,w,h){
  if(bgMode==='image' && bgImage){
    ImageToolUtils.drawImageCover(ctx, bgImage, 0, 0, w, h);
  } else {
    ctx.fillStyle = document.getElementById('bgColor').value;
    ctx.fillRect(0,0,w,h);
  }
}

function drawOverlay(ctx,w,h){
  const strength = Math.max(0, Math.min(100, parseInt(document.getElementById('ovStrength').value || '28', 10))) / 100;
  if(overlayMode==='none' || strength <= 0) return;

  if(overlayMode==='dim'){
    ctx.fillStyle = `rgba(0,0,0,${(0.65*strength).toFixed(3)})`;
    ctx.fillRect(0,0,w,h);
    return;
  }

  if(overlayMode==='gradient'){
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, `rgba(0,0,0,${(0.2*strength).toFixed(3)})`);
    g.addColorStop(0.55, `rgba(0,0,0,${(0.55*strength).toFixed(3)})`);
    g.addColorStop(1, `rgba(0,0,0,${(0.8*strength).toFixed(3)})`);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
    return;
  }

  if(overlayMode==='vignette'){
    const rg = ctx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.25,w/2,h/2,Math.max(w,h)*0.75);
    rg.addColorStop(0, `rgba(0,0,0,0)`);
    rg.addColorStop(1, `rgba(0,0,0,${(0.8*strength).toFixed(3)})`);
    ctx.fillStyle = rg;
    ctx.fillRect(0,0,w,h);
  }
}

const fitFont = (ctx,text,maxW,start) => ImageToolUtils.fitTextSize(ctx, text, maxW, start, 18, 700);

function drawOutlinedText(ctx, text, x, y, fillColor, strokeColor, outlinePx) {
  const o = Math.max(0, Math.round(outlinePx));
  ctx.shadowColor = 'transparent';
  ctx.shadowBlur = 0;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 0;

  if (o > 0) {
    ctx.fillStyle = strokeColor;
    for (let dy = -o; dy <= o; dy++) {
      for (let dx = -o; dx <= o; dx++) {
        if (dx === 0 && dy === 0) continue;
        if (dx*dx + dy*dy <= o*o) ctx.fillText(text, x + dx, y + dy);
      }
    }
  }

  ctx.fillStyle = fillColor;
  ctx.fillText(text, x, y);
}

function rrect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y);
  ctx.arcTo(x+w, y, x+w, y+r, r); ctx.lineTo(x+w, y+h-r);
  ctx.arcTo(x+w, y+h, x+w-r, y+h, r); ctx.lineTo(x+r, y+h);
  ctx.arcTo(x, y+h, x, y+h-r, r); ctx.lineTo(x, y+r);
  ctx.arcTo(x, y, x+r, y, r); ctx.closePath();
}

function drawTerminalTemplate(ctx, w, h, main, sub) {
  // 1. Background
  ctx.fillStyle = '#0d1321';
  ctx.fillRect(0, 0, w, h);

  // 2. Left blue glow
  const g1 = ctx.createRadialGradient(w*0.07, h*0.45, 0, w*0.07, h*0.45, w*0.52);
  g1.addColorStop(0, 'rgba(56,189,248,0.22)');
  g1.addColorStop(0.6, 'rgba(56,189,248,0.06)');
  g1.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g1; ctx.fillRect(0, 0, w, h);

  // 3. Right teal glow
  const g2 = ctx.createRadialGradient(w*0.93, h*0.58, 0, w*0.93, h*0.58, w*0.38);
  g2.addColorStop(0, 'rgba(20,184,166,0.14)');
  g2.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g2; ctx.fillRect(0, 0, w, h);

  // 4. Outer screen border
  const om = Math.floor(w * 0.027);
  const oy = Math.floor(h * 0.032);
  const or_ = Math.floor(w * 0.027);
  rrect(ctx, om, oy, w - om*2, h - oy*2, or_);
  ctx.fillStyle = 'rgba(12,22,38,0.5)'; ctx.fill();
  ctx.strokeStyle = 'rgba(100,150,200,0.22)';
  ctx.lineWidth = Math.max(2, Math.floor(w * 0.0013)); ctx.stroke();

  // 5. Terminal panel
  const px = Math.floor(w * 0.125);
  const py = Math.floor(h * 0.37);
  const pw = Math.floor(w * 0.75);
  const ph = Math.floor(h * 0.42);
  const pr = Math.floor(pw * 0.016);
  rrect(ctx, px, py, pw, ph, pr);
  ctx.fillStyle = '#111b2a'; ctx.fill();
  ctx.strokeStyle = 'rgba(100,155,210,0.28)';
  ctx.lineWidth = Math.max(1, Math.floor(w * 0.001)); ctx.stroke();

  // 6. Traffic lights
  const tlR = Math.max(8, Math.floor(ph * 0.067));
  const tlCY = py + Math.floor(ph * 0.21);
  const tlX0 = px + Math.floor(pw * 0.038);
  const tlGap = tlR * 2.65;
  [['#ff5f57', 0], ['#ffbd2e', 1], ['#28c840', 2]].forEach(([c, i]) => {
    ctx.beginPath(); ctx.arc(tlX0 + tlGap*i, tlCY, tlR, 0, Math.PI*2);
    ctx.fillStyle = c; ctx.fill();
  });

  // 7. Prompt >
  const ipx = Math.floor(pw * 0.04);
  const promptFs = Math.max(18, Math.floor(ph * 0.172));
  const monoFont = `600 ${promptFs}px 'JetBrains Mono','Courier New',monospace`;
  ctx.font = monoFont;
  ctx.fillStyle = '#4ec9b0';
  ctx.textAlign = 'left'; ctx.textBaseline = 'top';
  ctx.fillText('>', px + ipx, py + Math.floor(ph * 0.43));

  // 8. Main text (monospace, fitted)
  const textMaxW = pw - ipx * 2;
  const mainLines = (main || 'What is the real problem?').split('\n').filter(Boolean);
  let mfs = Math.max(18, Math.floor(ph * 0.172));
  mainLines.forEach(line => {
    ctx.font = `600 ${mfs}px 'JetBrains Mono','Courier New',monospace`;
    while (ctx.measureText(line).width > textMaxW && mfs > 14) {
      mfs--; ctx.font = `600 ${mfs}px 'JetBrains Mono','Courier New',monospace`;
    }
  });
  ctx.fillStyle = '#4ec9b0'; ctx.textAlign = 'left'; ctx.textBaseline = 'top';
  let ty = py + Math.floor(ph * 0.6);
  mainLines.forEach(line => {
    ctx.fillText(line, px + ipx, ty);
    ty += Math.floor(mfs * 1.38);
  });

  // 9. Badge pill
  const badgeText = (sub || 'BLOG COVER').toUpperCase();
  const bfs = Math.max(12, Math.floor(w * 0.018));
  ctx.font = `700 ${bfs}px 'JetBrains Mono','Courier New',monospace`;
  const btw = ctx.measureText(badgeText).width;
  const bph = Math.floor(bfs * 0.65);
  const bpv = Math.floor(bfs * 0.52);
  const bw = btw + bph*2, bh = bfs + bpv*2;
  const bx = px, by = py + ph + Math.floor(h * 0.043);
  rrect(ctx, bx, by, bw, bh, bh/2);
  ctx.fillStyle = '#38bdf8'; ctx.fill();
  ctx.fillStyle = '#0a1929'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(badgeText, bx + bw/2, by + bh/2);
}
  
function toRgba(hex, alpha=1){
  const h = String(hex || '#ffffff').replace('#','').trim();
  const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h.padEnd(6, 'f').slice(0,6);
  const n = parseInt(full, 16);
  const r = (n >> 16) & 255;
  const g = (n >> 8) & 255;
  const b = n & 255;
  return `rgba(${r},${g},${b},${alpha})`;
}

function drawDecor(ctx, w, h) {
  const decorColor = document.getElementById('decorColor')?.value || '#ffffff';
  const m=Math.max(34,Math.floor(w*0.08));
  const lw=Math.max(6,Math.floor(w*0.007));
  ctx.strokeStyle=toRgba(decorColor, 0.92);
  ctx.fillStyle=toRgba(decorColor, 0.95);
  ctx.lineWidth=lw;

  if (decorStyle === 'minimal') return;

  if (decorStyle === 'quote-frame') {
    ctx.strokeRect(m,m,w-m*2,h-m*2);
    ctx.font = `700 ${Math.floor(w*0.12)}px serif`;
    ctx.fillText('“', m-38, m+130);
    ctx.fillText('”', w-m-28, h-m+72);
    return;
  }

  if (decorStyle === 'double-frame') {
    ctx.strokeRect(m,m,w-m*2,h-m*2);
    ctx.globalAlpha=0.7;
    ctx.strokeRect(m+Math.floor(lw*2.2),m+Math.floor(lw*2.2),w-m*2-Math.floor(lw*4.4),h-m*2-Math.floor(lw*4.4));
    ctx.globalAlpha=1;
    return;
  }

  if (decorStyle === 'corner-lines') {
    const l=Math.floor(Math.min(w,h)*0.14);
    const r=w-m, b=h-m;
    ctx.beginPath();
    // TL
    ctx.moveTo(m,m+l); ctx.lineTo(m,m); ctx.lineTo(m+l,m);
    // TR
    ctx.moveTo(r-l,m); ctx.lineTo(r,m); ctx.lineTo(r,m+l);
    // BL
    ctx.moveTo(m,b-l); ctx.lineTo(m,b); ctx.lineTo(m+l,b);
    // BR
    ctx.moveTo(r-l,b); ctx.lineTo(r,b); ctx.lineTo(r,b-l);
    ctx.stroke();
    return;
  }

  if (decorStyle === 'clean-box') {
    ctx.globalAlpha=0.8;
    ctx.fillRect(m,m,w-m*2,h-m*2);
    ctx.globalAlpha=1;
    ctx.strokeStyle=toRgba(decorColor, 0.65);
    ctx.strokeRect(m,m,w-m*2,h-m*2);
    return;
  }
}

function renderThumb(){
  const [w,h]=ratios[ratio];
  const pad=parseInt(document.getElementById('pad').value||'90',10);
  const main=(document.getElementById('mainText').value||'').trim();
  const sub=(document.getElementById('subText').value||'').trim();
  const color=document.getElementById('textColor').value;
  const strokeColor=document.getElementById('strokeColor').value;
  const strokeBase = Math.max(0, Math.min(24, parseInt(document.getElementById('strokeWidth').value || '6', 10)));
  const mainScale = Math.max(50, Math.min(180, parseInt(document.getElementById('mainScale').value || '100', 10))) / 100;
  const subScale = Math.max(50, Math.min(180, parseInt(document.getElementById('subScale').value || '100', 10))) / 100;
  const mainYPct = Math.max(10, Math.min(85, parseInt(document.getElementById('mainY').value || '43', 10))) / 100;
  const subYPct = Math.max(10, Math.min(95, parseInt(document.getElementById('subY').value || '72', 10))) / 100;

  const cv=document.getElementById('thumbCanvas');
  cv.width=w; cv.height=h;
  const ctx=cv.getContext('2d');

  if (decorStyle === 'terminal') {
    drawTerminalTemplate(ctx, w, h, main, sub);
    return;
  }

  drawBg(ctx,w,h);
  drawOverlay(ctx,w,h);

  // decor
  drawDecor(ctx,w,h);

  // text
  ctx.fillStyle=color;
  const maxW=w-pad*2;
  const mainLines=main.split('\n').filter(Boolean);
  let y=h*mainYPct;
  mainLines.forEach((line)=>{
    const fs=fitFont(ctx,line,maxW,Math.floor(w*0.105*mainScale));
    ctx.font = `800 ${fs}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
    ctx.textAlign='center';
    drawOutlinedText(ctx, line, w/2, y, color, strokeColor, strokeBase > 0 ? strokeBase : 0);
    y += fs*1.12;
  });

  const subFs = fitFont(ctx, sub.replace(/\n/g,' '), maxW, Math.floor(w*0.05*subScale));
  ctx.font = `700 ${subFs}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
  ctx.textAlign='center';
  drawOutlinedText(ctx, sub, w/2, h*subYPct, 'rgba(255,255,255,0.96)', strokeColor, strokeBase > 0 ? Math.max(1, Math.round(strokeBase*0.7)) : 0);
}

function downloadThumb(){
  renderThumb();
  const q = Math.max(1, Math.min(100, parseInt(document.getElementById('imgQuality').value || '92', 10))) / 100;
  ImageToolUtils.downloadCanvas(document.getElementById('thumbCanvas'), {
    format: saveFormat,
    quality: q,
    filename: `thumbnail_${ratio.replace(':','x')}_${Date.now()}`
  });
}

applyPreset('quote'); syncAdvToSimple();
</script>
</body>
</html>