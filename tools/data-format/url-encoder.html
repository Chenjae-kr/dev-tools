<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/dev-tools/favicon.svg">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>URL & Query Builder | Dev Tools</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<link rel="stylesheet" href="../../styles.css">
</head>
<body>

<script>renderNav();</script>

<div class="container">
  <div class="tool-header">
    <h1>URL <span>& Query Builder</span></h1>
    <p>// URL 인코딩·디코딩, 쿼리 파라미터 분석/생성을 한 번에 처리합니다</p>
  </div>

  <div class="main-grid">
    <!-- LEFT: Input Panel -->
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot"></div>
            INPUT
          </div>
        </div>

        <div class="setting-group" data-level="basic" id="sourceGroup">
          <div class="setting-title">Source</div>
          <textarea class="ddl-textarea" id="urlInput" placeholder="https://example.com/search?q=hello world&lang=한국어"></textarea>
        </div>

        <div class="setting-group hidden" data-level="basic" id="buildGroup">
          <div class="setting-title">Query Params Builder</div>
          <div class="options-bar">
            <span class="options-label">Base URL</span>
            <input id="baseUrlInput" class="table-name-input" placeholder="https://example.com/search">
          </div>
          <div class="options-bar">
            <span class="options-label">Input</span>
            <div class="toggle-group">
              <button class="toggle-btn buildfmt-btn active" data-buildfmt="table">Table</button>
              <button class="toggle-btn buildfmt-btn" data-buildfmt="json">JSON</button>
              <button class="toggle-btn buildfmt-btn" data-buildfmt="csv">CSV</button>
            </div>
          </div>
          <textarea class="ddl-textarea" id="buildInput" placeholder="key\tvalue\nq\thello world\nlang\tko"></textarea>
        </div>

        <div class="setting-group" data-level="basic">
          <div class="setting-title">Options</div>
          <div class="options-bar">
            <span class="options-label">Mode</span>
            <div class="toggle-group">
              <button class="toggle-btn active" data-mode="encode">Encode</button>
              <button class="toggle-btn" data-mode="decode">Decode</button>
              <button class="toggle-btn" data-mode="parse">Parse</button>
              <button class="toggle-btn" data-mode="build">Build</button>
            </div>
          </div>

          <div class="options-bar" id="scopeBar">
            <span class="options-label">Scope</span>
            <div class="toggle-group">
              <button class="toggle-btn active" data-scope="component">Component</button>
              <button class="toggle-btn" data-scope="full">Full URI</button>
            </div>
          </div>
        </div>

        <button class="generate-btn" id="runBtn" onclick="run()" data-shortcut="Ctrl + Enter">
          ⚡ 변환하기
        </button>
      </div>
    </div>

    <!-- RIGHT: Output Panel -->
    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="empty-state">
          <div class="icon">⬅</div>
          <p>텍스트를 입력하고<br>변환하기 버튼을 누르세요</p>
        </div>
      </div>
    </div>
  </div>

  <footer>// URL & Query Builder — Encode · Decode · Parse · Build Query Params</footer>
</div>

<script>
// ─── State ───────────────────────────────────────────────
let mode  = 'encode';
let scope = 'component';
let buildFormat = 'table';

// ─── Mode toggle ─────────────────────────────────────────
document.querySelectorAll('[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    mode = btn.dataset.mode;
    const isBuild = mode === 'build';
    document.getElementById('scopeBar').classList.toggle('hidden', mode === 'parse' || isBuild);
    document.getElementById('sourceGroup').classList.toggle('hidden', isBuild);
    document.getElementById('buildGroup').classList.toggle('hidden', !isBuild);
  });
});

// ─── Scope toggle ─────────────────────────────────────────
document.querySelectorAll('[data-scope]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-scope]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    scope = btn.dataset.scope;
  });
});

document.querySelectorAll('.buildfmt-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.buildfmt-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    buildFormat = btn.dataset.buildfmt;
    const ph = buildFormat === 'json'
      ? '[{"key":"q","value":"hello world"},{"key":"lang","value":"ko"}]'
      : buildFormat === 'csv'
        ? 'key,value\nq,hello world\nlang,ko'
        : 'key\tvalue\nq\thello world\nlang\tko';
    document.getElementById('buildInput').placeholder = ph;
  });
});

// ─── Escape HTML ─────────────────────────────────────────
function escHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ─── Main ─────────────────────────────────────────────────
function run() {
  const raw = mode === 'build'
    ? document.getElementById('buildInput').value
    : document.getElementById('urlInput').value;
  const output = document.getElementById('outputPanel');
  const btn = document.getElementById('runBtn');

  if (!raw.trim()) {
    output.innerHTML = `<div class="error-msg">⚠ ${mode==='build' ? '쿼리 파라미터 데이터를 입력해주세요.' : '텍스트를 입력해주세요.'}</div>`;
    return;
  }

  btn.textContent = '⏳ 변환 중...';
  btn.classList.add('loading');

  setTimeout(() => {
    try {
      let result = '';
      let modeLabel = '';

      if (mode === 'encode') {
        result = scope === 'component' ? encodeURIComponent(raw) : encodeURI(raw);
        modeLabel = scope === 'component' ? 'encodeURIComponent' : 'encodeURI';
        renderResult(result, modeLabel);

      } else if (mode === 'decode') {
        result = scope === 'component' ? decodeURIComponent(raw) : decodeURI(raw);
        modeLabel = scope === 'component' ? 'decodeURIComponent' : 'decodeURI';
        renderResult(result, modeLabel);

      } else if (mode === 'parse') {
        renderParsed(raw);
      } else {
        renderBuilt(raw);
      }
    } catch (e) {
      output.innerHTML = `
        <div class="panel sql-block">
          <div class="sql-block-header">
            <span class="sql-type-badge badge-delete">ERROR</span>
          </div>
          <div class="error-msg no-radius">❌ ${escHtml(e.message)}</div>
        </div>`;
    }

    btn.textContent = '⚡ 변환하기';
    btn.classList.remove('loading');
  }, 20);
}

function renderResult(result, label) {
  const output  = document.getElementById('outputPanel');
  const blockId = `url_${Date.now()}`;
  output.innerHTML = `
    <div class="panel sql-block">
      <div class="sql-block-header">
        <span class="sql-type-badge badge-select">URL</span>
        <span class="sql-dialect-tag">${label}</span>
        <button class="copy-btn" id="copy_${blockId}" onclick="copyBlock('${blockId}')">COPY</button>
      </div>
      <pre class="sql-code" id="${blockId}">${escHtml(result)}</pre>
    </div>`;
}

function getSearchParams(raw) {
  const qs = raw.startsWith('?') ? raw.slice(1) : raw;
  return new URLSearchParams(qs);
}

function renderParsed(raw) {
  const output = document.getElementById('outputPanel');

  let url;
  try {
    // Try parsing as full URL
    url = new URL(raw.includes('://') ? raw : 'https://placeholder.invalid/?' + raw.replace(/^\?/, ''));
  } catch (_) {
    url = null;
  }

  const params = url ? url.searchParams : getSearchParams(raw);
  const entries = [...params.entries()];

  let baseHtml = '';
  if (url && raw.includes('://')) {
    baseHtml = `
      <div class="url-parse-row"><span class="url-parse-key">Protocol</span><span class="url-parse-val">${escHtml(url.protocol)}</span></div>
      <div class="url-parse-row"><span class="url-parse-key">Host</span><span class="url-parse-val">${escHtml(url.host)}</span></div>
      ${url.pathname && url.pathname !== '/' ? `<div class="url-parse-row"><span class="url-parse-key">Path</span><span class="url-parse-val">${escHtml(url.pathname)}</span></div>` : ''}
      ${url.hash ? `<div class="url-parse-row"><span class="url-parse-key">Hash</span><span class="url-parse-val">${escHtml(url.hash)}</span></div>` : ''}`;
  }

  const paramRows = entries.length
    ? entries.map(([k, v]) => `
        <div class="url-parse-row">
          <span class="url-parse-key">${escHtml(k)}</span>
          <span class="url-parse-val">${escHtml(v)}</span>
        </div>`).join('')
    : `<div class="url-parse-empty">쿼리 파라미터가 없습니다</div>`;

  const blockId = `url_${Date.now()}`;
  output.innerHTML = `
    <div class="panel sql-block">
      <div class="sql-block-header">
        <span class="sql-type-badge badge-select">PARSE</span>
        <span class="sql-dialect-tag">${entries.length} params</span>
        <button class="copy-btn" id="copy_${blockId}" onclick="copyParsed('${blockId}')">COPY JSON</button>
      </div>
      <div class="url-parse-block" id="${blockId}">
        ${baseHtml}
        ${baseHtml ? '<div class="url-parse-divider">Query Params</div>' : ''}
        <div class="url-parse-params">${paramRows}</div>
      </div>
    </div>`;
}

function parseBuildEntries(text) {
  const raw = (text || '').trim();
  if (!raw) return [];

  if (buildFormat === 'json') {
    const j = JSON.parse(raw);
    if (Array.isArray(j)) {
      return j.map(x => {
        if (Array.isArray(x)) return [String(x[0] ?? ''), String(x[1] ?? '')];
        if (x && typeof x === 'object') return [String(x.key ?? x.name ?? ''), String(x.value ?? '')];
        return ['', ''];
      }).filter(([k]) => k.trim());
    }
    if (j && typeof j === 'object') {
      return Object.entries(j).map(([k, v]) => [String(k), String(v ?? '')]);
    }
    throw new Error('JSON은 객체 또는 배열 형태여야 합니다.');
  }

  const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  if (!lines.length) return [];
  let sep = buildFormat === 'csv' ? ',' : '\t';
  if (buildFormat === 'table') {
    const first = lines[0] || '';
    const cTab = (first.match(/\t/g)||[]).length;
    const cPipe = (first.match(/\|/g)||[]).length;
    const cComma = (first.match(/,/g)||[]).length;
    if (cTab >= cPipe && cTab >= cComma) sep = '\t';
    else if (cPipe >= cComma) sep = '|';
    else sep = ',';
  }
  const rows = lines.map(l => parseDelimitedLine(l, sep));
  const header = (rows[0][0] || '').toLowerCase();
  const hasHeader = ['key', 'name', 'param'].includes(header);
  const body = hasHeader ? rows.slice(1) : rows;
  return body.map(r => [String(r[0] || '').trim(), String(r[1] || '').trim()]).filter(([k]) => k);
}

function renderBuilt(raw) {
  const output = document.getElementById('outputPanel');
  const base = (document.getElementById('baseUrlInput').value || '').trim();
  const entries = parseBuildEntries(raw);
  if (!entries.length) throw new Error('생성할 파라미터가 없습니다. key/value 데이터를 확인해주세요.');

  const sp = new URLSearchParams();
  entries.forEach(([k, v]) => sp.append(k, v));
  const qs = sp.toString();
  const full = base ? `${base}${base.includes('?') ? '&' : '?'}${qs}` : `?${qs}`;

  const queryId = `query_${Date.now()}`;
  const fullId = `${queryId}_full`;
  output.innerHTML = `
    <div class="panel sql-block">
      <div class="sql-block-header">
        <span class="sql-type-badge badge-select">BUILD</span>
        <span class="sql-dialect-tag">${entries.length} params · ${buildFormat.toUpperCase()}</span>
      </div>
      <div class="url-parse-block">
        <div class="url-parse-divider">Query String</div>
        <div class="sql-code" id="${queryId}">${escHtml(qs)}</div>
        <div class="download-actions mt-8"><button class="download-btn single" id="copy_${queryId}" onclick="copyBlock('${queryId}')">COPY QUERY</button></div>
        <div class="url-parse-divider">Full URL</div>
        <div class="sql-code" id="${fullId}">${escHtml(full)}</div>
        <div class="download-actions mt-8"><button class="download-btn all full" id="copy_${fullId}" onclick="copyBlock('${fullId}')">COPY FULL URL</button></div>
      </div>
    </div>`;
}

function copyBlock(id) {
  const el = document.getElementById(id);
  navigator.clipboard.writeText(el.innerText || el.textContent).then(() => {
    const btn = document.getElementById(`copy_${id}`);
    btn.textContent = '✓ COPIED';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'COPY'; btn.classList.remove('copied'); }, 1500);
  });
}

function copyParsed(id) {
  const el = document.getElementById(id);
  // Only copy query param rows (inside the params section, not base URL fields)
  const paramSection = el.querySelector('.url-parse-params');
  const source = paramSection || el;
  const rows = source.querySelectorAll('.url-parse-row');
  const obj = {};
  rows.forEach(row => {
    const k = row.querySelector('.url-parse-key').textContent;
    const v = row.querySelector('.url-parse-val').textContent;
    obj[k] = v;
  });
  navigator.clipboard.writeText(JSON.stringify(obj, null, 2)).then(() => {
    const btn = document.getElementById(`copy_${id}`);
    btn.textContent = '✓ COPIED';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'COPY JSON'; btn.classList.remove('copied'); }, 1500);
  });
}

// Ctrl/Cmd + Enter
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') run();
});
</script>

<style>
.url-parse-block {
  padding: 12px 0;
}
.url-parse-row {
  display: flex;
  gap: 12px;
  align-items: baseline;
  padding: 6px 20px;
  border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
}
.url-parse-row:last-child { border-bottom: none; }
.url-parse-key {
  min-width: 140px;
  color: var(--accent2);
  font-weight: 600;
  flex-shrink: 0;
}
.url-parse-val {
  color: var(--text);
  word-break: break-all;
}
.url-parse-divider {
  padding: 6px 20px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  background: var(--surface2);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  margin-top: 4px;
}
.url-parse-empty {
  padding: 40px 20px;
  text-align: center;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
}
</style>
</body>
</html>
