<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON ↔ Excel ↔ Markdown | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../ui-utils.js"></script>
<script src="../../vendor/xlsx.full.min.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.txt{width:100%;min-height:220px;background:transparent;border:none;outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;padding:14px 20px;resize:vertical}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header">
    <h1>JSON <span>↔</span> Excel <span>↔</span> Markdown</h1>
    <p>// 데이터 포맷 상호 변환 (JSON / .xlsx / Markdown Table)</p>
  </div>

  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>INPUT</div><button class="sample-btn" onclick="loadSample()">예시 불러오기</button></div>

        <div class="options-bar">
          <span class="options-label">Input Type</span>
          <div class="toggle-group">
            <button class="toggle-btn in-btn active" data-in="json">JSON</button>
            <button class="toggle-btn in-btn" data-in="md">Markdown</button>
            <button class="toggle-btn in-btn" data-in="excel">Excel</button>
          </div>
        </div>

        <textarea id="textInput" class="txt" placeholder='[{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]'></textarea>
        <div class="options-bar hidden" id="fileBar">
          <span class="options-label">Excel File</span>
          <input id="excelFile" type="file" accept=".xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        </div>

        <div class="options-bar">
          <span class="options-label">Output Type</span>
          <div class="toggle-group">
            <button class="toggle-btn out-btn active" data-out="json">JSON</button>
            <button class="toggle-btn out-btn" data-out="md">Markdown</button>
            <button class="toggle-btn out-btn" data-out="excel">Excel</button>
          </div>
        </div>

        <button class="generate-btn" onclick="convertNow()">⚡ CONVERT</button>
        <p class="kb-hint"><kbd>Ctrl</kbd> + <kbd>Enter</kbd></p>
      </div>
    </div>

    <div class="output-panel" id="out">
      <div class="panel"><div class="empty-state"><div class="icon">⇄</div><p>입력/출력 타입 선택 후 CONVERT</p></div></div>
    </div>
  </div>

  <footer>// Data Converter: JSON ↔ Excel ↔ Markdown</footer>
</div>

<script>
const esc = UIUtils.escHtml;
let inputType='json', outputType='json';

function setInputUI(){
  document.getElementById('textInput').classList.toggle('hidden', inputType==='excel');
  document.getElementById('fileBar').classList.toggle('hidden', inputType!=='excel');
}

document.querySelectorAll('.in-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.in-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); inputType=b.dataset.in; setInputUI();
});
document.querySelectorAll('.out-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.out-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); outputType=b.dataset.out;
});

function parseMarkdownTable(md){
  const lines=md.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.includes('|'));
  if(lines.length<2) throw new Error('마크다운 테이블 형식이 올바르지 않습니다.');
  const isSep=l=>/^[\s|:\-]+$/.test(l);
  const row=l=>l.replace(/^\s*\||\|\s*$/g,'').split('|').map(c=>c.trim());
  let hi=lines.findIndex(l=>!isSep(l));
  if(hi<0) throw new Error('헤더를 찾을 수 없습니다.');
  const headers=row(lines[hi]).filter(Boolean);
  const data=lines.slice(hi+1).filter(l=>!isSep(l)).map(l=>{
    const c=row(l); const o={}; headers.forEach((h,i)=>o[h]=c[i]??''); return o;
  });
  return data;
}

function toMarkdownTable(arr){
  if(!arr.length) return '| empty |\n|---|\n| |';
  const headers=[...new Set(arr.flatMap(o=>Object.keys(o)))];
  const head='| '+headers.join(' | ')+' |';
  const sep='| '+headers.map(()=> '---').join(' | ')+' |';
  const rows=arr.map(o=>'| '+headers.map(h=>String(o[h]??'')).join(' | ')+' |');
  return [head,sep,...rows].join('\n');
}

function normalizeJson(v){
  if(Array.isArray(v)) return v;
  if(v && typeof v==='object') return [v];
  throw new Error('JSON은 객체 또는 객체 배열이어야 합니다.');
}

function readExcelFile(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onerror=()=>reject(new Error('엑셀 파일 읽기 실패'));
    r.onload=e=>{
      try{
        const wb=XLSX.read(e.target.result,{type:'array'});
        const sn=wb.SheetNames[0];
        if(!sn) return reject(new Error('시트가 비어 있습니다.'));
        const rows=XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:''});
        resolve(rows);
      }catch(err){reject(err);}
    };
    r.readAsArrayBuffer(file);
  });
}

function downloadExcel(rows){
  const ws=XLSX.utils.json_to_sheet(rows.length?rows:[{}]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Sheet1');
  XLSX.writeFile(wb,`converted_${Date.now()}.xlsx`);
}

async function convertNow(){
  const out=document.getElementById('out');
  try{
    let rows=[];
    if(inputType==='json'){
      const txt=document.getElementById('textInput').value.trim();
      if(!txt) throw new Error('JSON 입력이 비어 있습니다.');
      rows=normalizeJson(JSON.parse(txt));
    } else if(inputType==='md'){
      const txt=document.getElementById('textInput').value.trim();
      if(!txt) throw new Error('Markdown 입력이 비어 있습니다.');
      rows=parseMarkdownTable(txt);
    } else {
      const f=document.getElementById('excelFile').files[0];
      if(!f) throw new Error('엑셀 파일을 선택해주세요.');
      rows=await readExcelFile(f);
    }

    if(outputType==='excel'){
      downloadExcel(rows);
      out.innerHTML=UIUtils.renderSqlBlock({badge:'DONE',tag:`${rows.length} rows`,bodyHtml:`<div class="table-info"><span>엑셀 파일 다운로드가 시작되었습니다.</span></div>`});
      return;
    }

    const result = outputType==='json' ? JSON.stringify(rows,null,2) : toMarkdownTable(rows);
    const id='conv_'+Date.now();
    out.innerHTML=UIUtils.renderSqlBlock({
      badge:'CONVERT',
      tag:`${inputType.toUpperCase()} → ${outputType.toUpperCase()} · ${rows.length} rows`,
      copyBtnId:`copy_${id}`,
      copyLabel:'COPY',
      copyHandler:`copyOut('${id}')`,
      wrapBtnId:id,
      bodyHtml:`<pre class="sql-code" id="${id}">${esc(result)}</pre>`
    });
    scrollToOutput(out);
  }catch(e){UIUtils.showError('out',e.message||String(e));}
}
function copyOut(id){UIUtils.copyElementText(id,`copy_${id}`,'COPY');}
function loadSample(){document.getElementById('textInput').value=JSON.stringify([{id:1,name:'Alice',age:30,email:'alice@example.com'},{id:2,name:'Bob',age:25,email:'bob@example.com'}],null,2);}
setInputUI();
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter')convertNow();});
</script>
</body>
</html>