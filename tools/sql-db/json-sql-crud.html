<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON ↔ SQL CRUD | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<script src="../../ui-utils.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
.json-textarea {
  width: 100%;
  min-height: 220px;
  background: transparent;
  border: none;
  outline: none;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.7;
  padding: 14px 20px;
  resize: vertical;
}
</style>
</head>
<body>
<script>renderNav();</script>

<div class="container">
  <div class="tool-header">
    <h1>JSON <span>↔ SQL CRUD</span></h1>
    <p>// JSON 샘플에서 CRUD SQL 템플릿 생성</p>
  </div>

  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title"><div class="dot"></div>INPUT</div>
          <button class="sample-btn" onclick="loadSample()">예시 불러오기</button>
        </div>

        <textarea id="jsonInput" class="json-textarea" placeholder='{"id": 1, "name": "Alice", "email": "alice@example.com", "age": 30}'>{
  "id": 1,
  "name": "Alice",
  "email": "alice@example.com",
  "age": 30,
  "is_active": true
}</textarea>

        <div class="options-bar">
          <span class="options-label">Table</span>
          <input id="tableName" class="table-name-input" value="users" placeholder="users">
          <span class="options-label">PK</span>
          <input id="pkCols" class="table-name-input" value="id" placeholder="id 또는 id,tenant_id">
        </div>

        <div class="options-bar row-tight">
          <span class="options-label">Dialect</span>
          <div class="dialect-group">
            <button class="dialect-btn active" data-dialect="mysql">MySQL</button>
            <button class="dialect-btn" data-dialect="oracle">Oracle</button>
            <button class="dialect-btn" data-dialect="postgresql">PostgreSQL</button>
          </div>
        </div>

        <div class="options-bar row-tight">
          <span class="options-label">Queries</span>
          <div class="crud-group">
            <button class="crud-toggle active" data-crud="CREATE">CREATE</button>
            <button class="crud-toggle active" data-crud="INSERT">INSERT</button>
            <button class="crud-toggle active" data-crud="SELECT">SELECT</button>
            <button class="crud-toggle active" data-crud="UPDATE">UPDATE</button>
            <button class="crud-toggle active" data-crud="DELETE">DELETE</button>
          </div>
          <button class="all-toggle" id="allToggle">전체해제</button>
        </div>

        <button class="generate-btn" onclick="generateCRUD()">⚡ SQL 생성</button>
        <p class="kb-hint"><kbd>Ctrl</kbd> + <kbd>Enter</kbd></p>
      </div>
    </div>

    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="empty-state">
          <div class="icon">SQL</div>
          <p>JSON과 테이블/PK를 입력 후 GENERATE</p>
        </div>
      </div>
    </div>
  </div>

  <footer>// JSON → CRUD SQL template generator</footer>
</div>

<script>
let selectedDialect = 'mysql';
let selectedCrud = new Set(['CREATE','INSERT','SELECT','UPDATE','DELETE']);

document.querySelectorAll('.dialect-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.dialect-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedDialect = btn.dataset.dialect;
  });
});

document.querySelectorAll('.crud-toggle').forEach(btn => {
  btn.addEventListener('click', () => {
    const t = btn.dataset.crud;
    if (selectedCrud.has(t)) { selectedCrud.delete(t); btn.classList.remove('active'); }
    else { selectedCrud.add(t); btn.classList.add('active'); }
    document.getElementById('allToggle').textContent = selectedCrud.size === 5 ? '전체해제' : '전체선택';
  });
});

document.getElementById('allToggle').addEventListener('click', () => {
  const allOn = selectedCrud.size === 5;
  if (allOn) selectedCrud.clear();
  else ['CREATE','INSERT','SELECT','UPDATE','DELETE'].forEach(t => selectedCrud.add(t));
  document.querySelectorAll('.crud-toggle').forEach(b => b.classList.toggle('active', selectedCrud.has(b.dataset.crud)));
  document.getElementById('allToggle').textContent = selectedCrud.size === 5 ? '전체해제' : '전체선택';
});

const escHtml = UIUtils.escHtml;
const renderSqlBlock = UIUtils.renderSqlBlock || function ({
  badge = 'SQL', tag = '', copyBtnId = '', copyLabel = 'COPY', copyHandler = '', bodyHtml = ''
} = {}) {
  const copyBtn = copyBtnId && copyHandler
    ? `<button class="copy-btn" id="${escHtml(copyBtnId)}" onclick="${copyHandler}">${escHtml(copyLabel)}</button>`
    : '';
  return `<div class="panel sql-block"><div class="sql-block-header"><span class="sql-type-badge badge-insert">${escHtml(badge)}</span><span class="sql-dialect-tag">${escHtml(tag)}</span>${copyBtn}</div>${bodyHtml}</div>`;
};

function quoteIdent(name) {
  if (selectedDialect === 'mysql') return `\`${name}\``;
  if (selectedDialect === 'oracle') return name.toUpperCase();
  return `"${name}"`;
}

function toSqlValue(v) {
  if (v === null || v === undefined) return 'NULL';
  if (typeof v === 'number') return String(v);
  if (typeof v === 'boolean') {
    if (selectedDialect === 'postgresql') return v ? 'TRUE' : 'FALSE';
    return v ? '1' : '0';
  }
  return `'${String(v).replace(/'/g, "''")}'`;
}

function inferColumnType(v) {
  if (typeof v === 'number') {
    if (Number.isInteger(v)) return selectedDialect === 'oracle' ? 'NUMBER(10)' : 'INT';
    return selectedDialect === 'oracle' ? 'NUMBER(18,4)' : 'DECIMAL(18,4)';
  }
  if (typeof v === 'boolean') {
    if (selectedDialect === 'postgresql') return 'BOOLEAN';
    if (selectedDialect === 'oracle') return 'NUMBER(1)';
    return 'TINYINT(1)';
  }
  if (v instanceof Date) return selectedDialect === 'postgresql' ? 'TIMESTAMP' : 'DATETIME';
  if (v === null || v === undefined) return 'VARCHAR(255)';
  const s = String(v);
  if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}:\d{2})?$/.test(s)) {
    if (selectedDialect === 'oracle') return 'DATE';
    if (selectedDialect === 'postgresql') return 'TIMESTAMP';
    return 'DATETIME';
  }
  return s.length > 255 ? (selectedDialect === 'oracle' ? 'CLOB' : 'TEXT') : 'VARCHAR(255)';
}

function buildCreateSql(tableName, keys, parsed, pkCols) {
  const tbl = quoteIdent(tableName);
  const defs = keys.map(k => {
    const col = quoteIdent(k);
    const type = inferColumnType(parsed[k]);
    const notNull = pkCols.includes(k) ? ' NOT NULL' : '';
    return `  ${col} ${type}${notNull}`;
  });
  if (pkCols.length) {
    defs.push(`  PRIMARY KEY (${pkCols.map(quoteIdent).join(', ')})`);
  }
  return `CREATE TABLE ${tbl} (\n${defs.join(',\n')}\n);`;
}

function generateCRUD() {
  const out = document.getElementById('outputPanel');
  const tableNameRaw = document.getElementById('tableName').value.trim() || 'my_table';
  const pkRaw = document.getElementById('pkCols').value.trim();

  try {
    const parsed = JSON.parse(document.getElementById('jsonInput').value.trim() || '{}');
    if (Array.isArray(parsed)) throw new Error('현재는 단일 객체 JSON만 지원합니다.');

    const keys = Object.keys(parsed);
    if (!keys.length) throw new Error('JSON 객체에 컬럼이 없습니다.');

    const pkCols = pkRaw.split(',').map(s => s.trim()).filter(Boolean);
    if (!pkCols.length) throw new Error('PK 컬럼을 1개 이상 입력해주세요.');

    pkCols.forEach(pk => {
      if (!keys.includes(pk)) throw new Error(`PK 컬럼 '${pk}'가 JSON 키에 없습니다.`);
    });

    const tbl = quoteIdent(tableNameRaw);
    const cols = keys.map(quoteIdent);
    const vals = keys.map(k => toSqlValue(parsed[k]));

    const whereClause = pkCols.map(k => `${quoteIdent(k)} = ${toSqlValue(parsed[k])}`).join(' AND ');

    const setCols = keys.filter(k => !pkCols.includes(k));
    const updateSet = (setCols.length ? setCols : keys)
      .map(k => `${quoteIdent(k)} = ${toSqlValue(parsed[k])}`).join(', ');

    if (!selectedCrud.size) throw new Error('생성할 쿼리를 1개 이상 선택해주세요.');

    const createSql = buildCreateSql(tableNameRaw, keys, parsed, pkCols);
    const selectSql = `SELECT ${cols.join(', ')}\nFROM ${tbl}\nWHERE ${whereClause};`;
    const insertSql = `INSERT INTO ${tbl} (${cols.join(', ')})\nVALUES (${vals.join(', ')});`;
    const updateSql = `UPDATE ${tbl}\nSET ${updateSet}\nWHERE ${whereClause};`;
    const deleteSql = `DELETE FROM ${tbl}\nWHERE ${whereClause};`;

    const parts = [];
    if (selectedCrud.has('CREATE')) parts.push('-- CREATE TABLE', createSql);
    if (selectedCrud.has('SELECT')) parts.push('-- SELECT', selectSql);
    if (selectedCrud.has('INSERT')) parts.push('-- INSERT', insertSql);
    if (selectedCrud.has('UPDATE')) parts.push('-- UPDATE', updateSql);
    if (selectedCrud.has('DELETE')) parts.push('-- DELETE', deleteSql);
    const sql = parts.join('\n\n');

    const blockId = 'crud_' + Date.now();
    out.innerHTML = renderSqlBlock({
      badge: 'CRUD',
      tag: `${selectedDialect.toUpperCase()} · ${keys.length} columns`,
      copyBtnId: `copy_${blockId}`,
      copyLabel: 'COPY',
      copyHandler: `copyCRUD('${blockId}')`,
      wrapBtnId: blockId,
      bodyHtml: `<pre class="sql-code" id="${blockId}">${escHtml(sql)}</pre>`,
    });
    scrollToOutput(out);
  } catch (e) {
    UIUtils.showError(out, e.message || String(e));
  }
}

function copyCRUD(id) {
  UIUtils.copyElementText(id, `copy_${id}`, 'COPY');
}

document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generateCRUD();
});

function loadSample() {
  document.getElementById('tableName').value = 'orders';
  document.getElementById('jsonInput').value = JSON.stringify({
    order_id: 1001,
    user_id: 42,
    product: 'Keyboard',
    amount: 89000,
    status: 'paid',
    created_at: '2026-02-25'
  }, null, 2);
}
</script>
</body>
</html>
