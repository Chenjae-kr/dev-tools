<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SQL ‚Üí ERD | Dev Tools</title>
<script src="../../tools.js"></script>
<script src="../../nav.js"></script>
<link rel="stylesheet" href="../../styles.css">
<style>
#sqlInput {
  width: 100%;
  min-height: 200px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.6;
  padding: 12px;
  resize: vertical;
  box-sizing: border-box;
  outline: none;
  transition: border-color .2s;
}
#sqlInput:focus         { border-color: var(--accent); }
#sqlInput.drag-over     { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 6%, transparent); }

/* ERD toolbar */
.erd-toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.erd-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 4px;
  padding: 4px 11px;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .04em;
  transition: border-color .15s, color .15s;
}
.erd-btn:hover    { border-color: var(--accent); color: var(--accent); }
.erd-zoom-display {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  min-width: 46px;
  text-align: center;
}
.erd-sep { flex: 1; }

/* ERD canvas */
.erd-canvas-wrap {
  width: 100%;
  height: 620px;
  overflow: hidden;
  position: relative;
  background: var(--surface);
  background-image:
    radial-gradient(circle, color-mix(in srgb, var(--border) 70%, transparent) 1px, transparent 1px);
  background-size: 28px 28px;
  cursor: grab;
  user-select: none;
}
.erd-canvas-wrap.panning { cursor: grabbing; }
#erdSvg { display: block; width: 100%; height: 100%; }

/* SVG element styles (used as CSS classes on SVG elements) */
.tbl-shadow  { fill: rgba(0,0,0,0.22); }
.tbl-body    { fill: var(--surface); stroke: var(--border); stroke-width: 1.5; }
.tbl-hdr-bg  { fill: var(--accent2); }
.tbl-name    { fill: #fff; font-family: 'JetBrains Mono',monospace; font-size: 13px; font-weight: 700; }
.tbl-divider { stroke: var(--border); stroke-width: 1; }
.tbl-border  { fill: none; stroke: color-mix(in srgb, var(--accent2) 55%, var(--border)); stroke-width: 1.5; }
.col-stripe  { fill: color-mix(in srgb, var(--accent2) 4%, transparent); }
.col-label   { fill: var(--text); font-family: 'JetBrains Mono',monospace; font-size: 11.5px; }
.col-label-pk{ fill: #f0c050; font-family: 'JetBrains Mono',monospace; font-size: 11.5px; font-weight: 600; }
.col-label-fk{ fill: #9c8cff; font-family: 'JetBrains Mono',monospace; font-size: 11.5px; }
.col-type    { fill: var(--text-muted); font-family: 'JetBrains Mono',monospace; font-size: 10.5px; }
.col-divider { stroke: var(--border); stroke-width: 0.5; opacity: 0.45; }
.fk-edge     { fill: none; stroke: var(--accent2); stroke-width: 1.6; opacity: 0.72; }

/* Stats bar */
.erd-stats-bar {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 8px 14px;
  background: var(--surface2);
  border-top: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  flex-wrap: wrap;
}
.erd-stats-bar b { color: var(--text-dim); }
.erd-legend { display: flex; gap: 14px; align-items: center; margin-left: auto; }
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-dot  { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.legend-dot-pk { background:#f0c050; }
.legend-dot-fk { background:#9c8cff; }
.legend-relation-svg { overflow:visible; }
.erd-table { cursor: grab; }

/* Error area */
#erdError { display: none; }
</style>
</head>
<body>

<script>renderNav();</script>

<div class="container">
  <div class="tool-header">
    <h1>SQL <span>‚Üí</span> ERD</h1>
    <p>// SQL DDLÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÌÖåÏù¥Î∏î Í¥ÄÍ≥ÑÎèÑ(ERD)Î•º ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±Ìï©ÎãàÎã§</p>
  </div>

  <!-- ‚îÄ‚îÄ Input Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="panel mb-16">
    <div class="panel-header">
      <div class="panel-title"><div class="dot"></div>SQL INPUT</div>
    </div>

    <textarea id="sqlInput" placeholder="CREATE TABLE users (
  user_id   INT          NOT NULL AUTO_INCREMENT,
  username  VARCHAR(50)  NOT NULL,
  email     VARCHAR(100) NOT NULL,
  PRIMARY KEY (user_id)
);

CREATE TABLE orders (
  order_id    INT          NOT NULL AUTO_INCREMENT,
  user_id     INT          NOT NULL,
  total       DECIMAL(10,2),
  PRIMARY KEY (order_id),
  FOREIGN KEY (user_id) REFERENCES users (user_id)
);

-- .sql ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò üìÇ Î≤ÑÌäºÏúºÎ°ú ÏóÖÎ°úÎìúÌï¥ÎèÑ Îê©ÎãàÎã§"></textarea>

    <div class="options-bar">
      <span class="options-label">ÌååÏùº</span>
      <button class="toggle-btn" id="openFileBtn">üìÇ .sql ÌååÏùº Ïó¥Í∏∞</button>
      <input type="file" id="fileInput" class="hidden" accept=".sql,.txt,.ddl">
      <span class="options-label">ÏòàÏ†ú</span>
      <button class="toggle-btn" onclick="loadSample()">ÏÉòÌîå DDL Î°úÎìú</button>
      <button class="toggle-btn" onclick="clearInput()">ÏßÄÏö∞Í∏∞</button>
    </div>

    <div id="erdError" class="hidden"></div>

    <button class="generate-btn" id="erdBtn" onclick="generateERD()">
      ‚ö° ÏÉùÏÑ±
    </button>
    <p class="kb-hint"><kbd>Ctrl</kbd> + <kbd>Enter</kbd></p>
  </div>

  <!-- ‚îÄ‚îÄ ERD Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="erdSection" class="hidden">
    <div class="panel panel-plain">

      <!-- Toolbar -->
      <div class="erd-toolbar">
        <button class="erd-btn" onclick="doAutoLayout()">‚Ü∫ ÏûêÎèô Î∞∞Ïπò</button>
        <button class="erd-btn" onclick="fitView()">‚ä° Ï†ÑÏ≤¥ Î≥¥Í∏∞</button>
        <button class="erd-btn" onclick="zoomStep(1.2)">Ôºã</button>
        <span class="erd-zoom-display" id="zoomDisplay">100%</span>
        <button class="erd-btn" onclick="zoomStep(1/1.2)">Ôºç</button>
        <div class="erd-sep"></div>
        <button class="erd-btn" onclick="exportSVG()">‚Üì SVG ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
      </div>

      <!-- Canvas -->
      <div class="erd-canvas-wrap" id="erdCanvas">
        <svg id="erdSvg">
          <defs>
            <marker id="arr-end" viewBox="0 0 10 10" refX="9" refY="5"
                    markerWidth="7" markerHeight="7" orient="auto">
              <path d="M 1 1 L 9 5 L 1 9 z" fill="#7c6aff"/>
            </marker>
            <marker id="arr-start" viewBox="0 0 10 10" refX="5" refY="5"
                    markerWidth="6" markerHeight="6">
              <circle cx="5" cy="5" r="3.5" fill="#7c6aff"/>
            </marker>
          </defs>
          <g id="mainGroup">
            <g id="edgeLayer"></g>
            <g id="nodeLayer"></g>
          </g>
        </svg>
      </div>

      <!-- Stats bar -->
      <div class="erd-stats-bar">
        <span>tables <b id="statTables">0</b></span>
        <span>columns <b id="statCols">0</b></span>
        <span>FK relations <b id="statFKs">0</b></span>
        <div class="erd-legend">
          <div class="legend-item">
            <div class="legend-dot legend-dot-pk"></div>
            <span class="text-muted">PK</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot legend-dot-fk"></div>
            <span class="text-muted">FK</span>
          </div>
          <div class="legend-item">
            <svg width="28" height="10" class="legend-relation-svg">
              <line x1="0" y1="5" x2="20" y2="5" stroke="#7c6aff" stroke-width="1.5" marker-end="url(#arr-end)" marker-start="url(#arr-start)"/>
            </svg>
            <span class="text-muted">Í¥ÄÍ≥Ñ</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer>// SQL ‚Üí ERD ‚Äî DDLÏùÑ ÏãúÍ∞ÅÏ†Å Í¥ÄÍ≥ÑÎèÑÎ°ú Î≥ÄÌôò ¬∑ ÎìúÎûòÍ∑∏ Î∞∞Ïπò ¬∑ SVG ÎÇ¥Î≥¥ÎÇ¥Í∏∞</footer>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HEADER_H = 36;
const ROW_H    = 24;
const MIN_W    = 200;
const MAX_W    = 360;
const H_PAD    = 10;
const ICON_W   = 18;
const CW_12    = 7.2;   // JetBrains Mono 12px approx char width
const CW_13    = 8.5;   // 13px bold
const XGAP     = 60;
const YGAP     = 72;

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tables      = [];
let foreignKeys = [];
let zoom        = 1;
let pan         = { x: 0, y: 0 };
let dragState   = null;  // { tableName, startX, startY, origX, origY }
let panState    = null;  // { startX, startY, origX, origY }

// ‚îÄ‚îÄ‚îÄ File Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('openFileBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});
document.getElementById('fileInput').addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  readFile(f);
  e.target.value = '';
});

const sqlInput = document.getElementById('sqlInput');
sqlInput.addEventListener('dragover',  e => { e.preventDefault(); sqlInput.classList.add('drag-over'); });
sqlInput.addEventListener('dragleave', ()  => sqlInput.classList.remove('drag-over'));
sqlInput.addEventListener('drop', e => {
  e.preventDefault();
  sqlInput.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f) readFile(f);
});

function readFile(file) {
  const r = new FileReader();
  r.onload = ev => { sqlInput.value = ev.target.result; };
  r.readAsText(file);
}

function clearInput() {
  sqlInput.value = '';
  document.getElementById('erdSection').classList.add('hidden');
  document.getElementById('erdError').classList.add('hidden');
}

function loadSample() {
  sqlInput.value = `-- E-commerce sample schema

CREATE TABLE customers (
  customer_id  INT          NOT NULL AUTO_INCREMENT,
  name         VARCHAR(100) NOT NULL,
  email        VARCHAR(150) NOT NULL UNIQUE,
  phone        VARCHAR(20),
  created_at   DATETIME     DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (customer_id)
);

CREATE TABLE categories (
  category_id  INT         NOT NULL AUTO_INCREMENT,
  name         VARCHAR(80) NOT NULL,
  parent_id    INT,
  PRIMARY KEY (category_id),
  FOREIGN KEY (parent_id) REFERENCES categories (category_id)
);

CREATE TABLE products (
  product_id   INT            NOT NULL AUTO_INCREMENT,
  category_id  INT            NOT NULL,
  name         VARCHAR(200)   NOT NULL,
  price        DECIMAL(10,2)  NOT NULL,
  stock        INT            DEFAULT 0,
  PRIMARY KEY (product_id),
  FOREIGN KEY (category_id) REFERENCES categories (category_id)
);

CREATE TABLE orders (
  order_id     INT          NOT NULL AUTO_INCREMENT,
  customer_id  INT          NOT NULL,
  status       VARCHAR(20)  DEFAULT 'pending',
  total        DECIMAL(12,2),
  ordered_at   DATETIME     DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (order_id),
  FOREIGN KEY (customer_id) REFERENCES customers (customer_id)
);

CREATE TABLE order_items (
  item_id      INT            NOT NULL AUTO_INCREMENT,
  order_id     INT            NOT NULL,
  product_id   INT            NOT NULL,
  quantity     INT            NOT NULL DEFAULT 1,
  unit_price   DECIMAL(10,2)  NOT NULL,
  PRIMARY KEY (item_id),
  FOREIGN KEY (order_id)   REFERENCES orders   (order_id),
  FOREIGN KEY (product_id) REFERENCES products (product_id)
);`;
}

// ‚îÄ‚îÄ‚îÄ DDL Parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseDDL(sql) {
  const cleaned = sql
    .replace(/\/\*[\s\S]*?\*\//g, ' ')
    .replace(/--[^\n]*/g, '');

  const result = { tables: [], foreignKeys: [] };
  const re = /CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?(?:`?\w+`?\.)?[`"[]?(\w+)[`"\]]?\s*\(/gi;
  let m;

  while ((m = re.exec(cleaned)) !== null) {
    const name  = m[1];
    let depth = 1, i = m.index + m[0].length;
    const start = i;
    while (i < cleaned.length && depth > 0) {
      if      (cleaned[i] === '(') depth++;
      else if (cleaned[i] === ')') depth--;
      i++;
    }
    const body = cleaned.slice(start, i - 1);
    const { columns, fks } = parseBody(body, name);
    result.tables.push({ name, columns });
    result.foreignKeys.push(...fks);
  }

  // Mark FK columns
  for (const fk of result.foreignKeys) {
    const tbl = result.tables.find(t => t.name === fk.fromTable);
    if (tbl) {
      const col = tbl.columns.find(c => c.name === fk.fromCol);
      if (col) col.fkRef = { toTable: fk.toTable, toCol: fk.toCol };
    }
  }

  return result;
}

function parseBody(body, tableName) {
  const parts   = splitComma(body);
  const columns = [];
  const fks     = [];

  // Table-level PK
  const pkMatch = body.match(/(?:CONSTRAINT\s+\w+\s+)?PRIMARY\s+KEY\s*\(([^)]+)\)/i);
  const pkCols  = pkMatch
    ? pkMatch[1].split(',').map(c => c.trim().replace(/[`"'[\]]/g, ''))
    : [];

  for (const part of parts) {
    const s = part.trim();
    if (!s) continue;

    // FK constraint
    if (/(?:CONSTRAINT\s+\w+\s+)?FOREIGN\s+KEY/i.test(s)) {
      const r = s.match(/FOREIGN\s+KEY\s*\(([^)]+)\)\s*REFERENCES\s+[`"']?(\w+)[`"']?\s*(?:\(([^)]+)\))?/i);
      if (r) {
        const froms = r[1].split(',').map(c => c.trim().replace(/[`"'[\]]/g, ''));
        const toTbl = r[2];
        const tos   = r[3] ? r[3].split(',').map(c => c.trim().replace(/[`"'[\]]/g, '')) : froms;
        froms.forEach((fc, idx) =>
          fks.push({ fromTable: tableName, fromCol: fc, toTable: toTbl, toCol: tos[idx] || tos[0] })
        );
      }
      continue;
    }

    // Skip other constraints
    if (/^(?:CONSTRAINT|PRIMARY\s+KEY|UNIQUE\s+(?:KEY|INDEX)|INDEX|KEY\s|CHECK|FULLTEXT)/i.test(s)) continue;

    // Column definition
    const cm = s.match(/^[`"[]?(\w+)[`"'\]]?\s+([A-Za-z_]\w*(?:\s*\([^)]*\))?(?:\s*UNSIGNED)?(?:\s*ZEROFILL)?)([\s\S]*)$/i);
    if (!cm) continue;

    const colName = cm[1];
    const colType = cm[2].trim().toUpperCase();
    const rest    = cm[3] || '';
    const isPK    = /PRIMARY\s+KEY/i.test(rest) || pkCols.includes(colName);

    // Inline REFERENCES
    const refM = rest.match(/REFERENCES\s+[`"']?(\w+)[`"']?\s*(?:\(([^)]+)\))?/i);
    if (refM) {
      const toCol = (refM[2] || colName).replace(/[`"'[\]]/g, '').trim();
      fks.push({ fromTable: tableName, fromCol: colName, toTable: refM[1], toCol });
    }

    columns.push({
      name:       colName,
      type:       colType,
      isPK,
      isNotNull:  isPK || /NOT\s+NULL/i.test(rest),
      fkRef:      null,
    });
  }

  return { columns, fks };
}

function splitComma(body) {
  const parts = [];
  let depth = 0, cur = '';
  for (const ch of body) {
    if      (ch === '(' || ch === '[') depth++;
    else if (ch === ')' || ch === ']') depth--;
    else if (ch === ',' && depth === 0) { parts.push(cur); cur = ''; continue; }
    cur += ch;
  }
  if (cur.trim()) parts.push(cur);
  return parts;
}

// ‚îÄ‚îÄ‚îÄ Dimensions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeDims(table) {
  const nameW = table.name.length * CW_13 + H_PAD * 2 + 20;
  let maxColW = 0;
  for (const col of table.columns) {
    const w = ICON_W + H_PAD + col.name.length * CW_12 + 14 + col.type.length * CW_12 + H_PAD * 2;
    if (w > maxColW) maxColW = w;
  }
  return {
    width:  Math.min(MAX_W, Math.max(MIN_W, nameW, maxColW)),
    height: HEADER_H + table.columns.length * ROW_H + 4,
  };
}

// ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeRanks() {
  // Build: table -> tables it references (via FK)
  const refs = {};
  tables.forEach(t => refs[t.name] = []);
  foreignKeys.forEach(fk => {
    if (refs[fk.fromTable] && fk.fromTable !== fk.toTable)
      refs[fk.fromTable].push(fk.toTable);
  });

  // rank = max(rank of referenced tables) + 1
  const ranks = {};
  tables.forEach(t => ranks[t.name] = 0);
  for (let iter = 0; iter < tables.length + 1; iter++) {
    let changed = false;
    tables.forEach(t => {
      refs[t.name].forEach(ref => {
        const nr = (ranks[ref] ?? 0) + 1;
        if (nr > ranks[t.name]) { ranks[t.name] = nr; changed = true; }
      });
    });
    if (!changed) break;
  }
  return ranks;
}

function doAutoLayout() {
  if (!tables.length) return;

  const ranks   = computeRanks();
  const maxRank = Math.max(0, ...Object.values(ranks));
  const byRank  = {};
  for (let r = 0; r <= maxRank; r++) byRank[r] = [];
  tables.forEach(t => byRank[ranks[t.name] || 0].push(t));

  let y = 0;
  for (let r = 0; r <= maxRank; r++) {
    const row = byRank[r];
    if (!row.length) continue;
    const rowW = row.reduce((s, t) => s + t.width, 0) + XGAP * (row.length - 1);
    let x = -(rowW / 2);
    row.forEach(t => { t.x = x; t.y = y; x += t.width + XGAP; });
    y += Math.max(...row.map(t => t.height)) + YGAP;
  }

  pan = { x: 0, y: 0 };
  zoom = 1;
  renderAll();
  fitView();
}

// ‚îÄ‚îÄ‚îÄ Edge Path ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function edgePath(fk) {
  const from = tables.find(t => t.name === fk.fromTable);
  const to   = tables.find(t => t.name === fk.toTable);
  if (!from || !to) return null;

  // Self-reference loop
  if (fk.fromTable === fk.toTable) {
    const lx = from.x + from.width, ly = from.y + HEADER_H / 2;
    return `M ${lx} ${ly} C ${lx+60} ${ly-30} ${lx+60} ${ly+30} ${lx} ${ly + 10}`;
  }

  const fi = from.columns.findIndex(c => c.name === fk.fromCol);
  const ti = to.columns.findIndex(c => c.name === fk.toCol);
  const fy = from.y + HEADER_H + Math.max(0, fi) * ROW_H + ROW_H / 2;
  const ty = to.y   + HEADER_H + Math.max(0, ti) * ROW_H + ROW_H / 2;

  const fromCx = from.x + from.width / 2;
  const toCx   = to.x   + to.width   / 2;
  const goRight = fromCx <= toCx;

  const x1   = goRight ? from.x + from.width : from.x;
  const x2   = goRight ? to.x                : to.x + to.width;
  const dist = Math.max(40, Math.abs(x2 - x1) * 0.42);
  const cp1x = goRight ? x1 + dist : x1 - dist;
  const cp2x = goRight ? x2 - dist : x2 + dist;

  return `M ${x1} ${fy} C ${cp1x} ${fy} ${cp2x} ${ty} ${x2} ${ty}`;
}

// ‚îÄ‚îÄ‚îÄ SVG Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function trunc(s, maxChars) {
  return s.length > maxChars ? s.slice(0, maxChars - 1) + '‚Ä¶' : s;
}

function buildTableSVG(table) {
  const { name, columns, x, y, width, height } = table;
  const p = [];

  p.push(`<g class="erd-table" data-table="${esc(name)}" transform="translate(${x.toFixed(1)},${y.toFixed(1)})">`);

  // Shadow
  p.push(`<rect class="tbl-shadow" x="3" y="4" width="${width}" height="${height}" rx="7"/>`);

  // Body
  p.push(`<rect class="tbl-body" width="${width}" height="${height}" rx="7"/>`);

  // Header bg (top-rounded only: full rect + square bottom fill)
  p.push(`<rect class="tbl-hdr-bg" width="${width}" height="${HEADER_H}" rx="7"/>`);
  p.push(`<rect class="tbl-hdr-bg" x="0" y="${HEADER_H - 7}" width="${width}" height="7"/>`);

  // Table name
  const maxNameC = Math.floor((width - H_PAD * 2 - 4) / CW_13);
  p.push(`<text class="tbl-name" x="${(width/2).toFixed(1)}" y="${HEADER_H/2 + 5}" text-anchor="middle">${esc(trunc(name, maxNameC))}</text>`);

  // Header divider
  p.push(`<line class="tbl-divider" x1="0" y1="${HEADER_H}" x2="${width}" y2="${HEADER_H}"/>`);

  // Columns
  columns.forEach((col, i) => {
    const cy  = HEADER_H + i * ROW_H;
    const ty  = cy + ROW_H / 2 + 4;

    // Alternating stripe
    if (i % 2 === 0)
      p.push(`<rect class="col-stripe" x="1" y="${cy}" width="${width - 2}" height="${ROW_H}"/>`);

    // Key icon
    let icon, iconFill;
    if      (col.isPK && col.fkRef) { icon = '‚óà'; iconFill = '#f0c050'; }
    else if (col.isPK)              { icon = '‚óÜ'; iconFill = '#f0c050'; }
    else if (col.fkRef)             { icon = '‚óÜ'; iconFill = '#9c8cff'; }
    else                            { icon = '¬∑'; iconFill = '#606080'; }
    p.push(`<text x="${H_PAD}" y="${ty}" font-family="JetBrains Mono,monospace" font-size="12" fill="${iconFill}">${icon}</text>`);

    // Column name
    const nameCls  = col.isPK ? 'col-label-pk' : col.fkRef ? 'col-label-fk' : 'col-label';
    const nameArea = width - ICON_W - H_PAD * 2 - 10 - Math.floor(width * 0.38);
    p.push(`<text class="${nameCls}" x="${H_PAD + ICON_W}" y="${ty}">${esc(trunc(col.name, Math.floor(nameArea / CW_12)))}</text>`);

    // Type (right-aligned)
    const typeArea = Math.floor(width * 0.38);
    p.push(`<text class="col-type" x="${width - H_PAD}" y="${ty}" text-anchor="end">${esc(trunc(col.type, Math.floor(typeArea / CW_12)))}</text>`);

    // Row divider
    if (i < columns.length - 1)
      p.push(`<line class="col-divider" x1="${H_PAD}" y1="${cy + ROW_H}" x2="${width - H_PAD}" y2="${cy + ROW_H}"/>`);
  });

  // Table border on top
  p.push(`<rect class="tbl-border" width="${width}" height="${height}" rx="7" fill="none"/>`);

  p.push(`</g>`);
  return p.join('');
}

function renderAll() {
  document.getElementById('edgeLayer').innerHTML = foreignKeys
    .map((fk, i) => {
      const d = edgePath(fk);
      return d
        ? `<path class="fk-edge" data-edge="${i}" d="${esc(d)}" marker-end="url(#arr-end)" marker-start="url(#arr-start)"/>`
        : '';
    }).join('');

  document.getElementById('nodeLayer').innerHTML = tables.map(buildTableSVG).join('');

  updateTransform();
}

// Partial update during drag (avoids full re-render)
function updateTableDOM(tableName) {
  const table = tables.find(t => t.name === tableName);
  if (!table) return;

  const g = findTableGroup(tableName);
  if (g) g.setAttribute('transform', `translate(${table.x.toFixed(1)},${table.y.toFixed(1)})`);

  const edgeLayer = document.getElementById('edgeLayer');
  foreignKeys.forEach((fk, i) => {
    if (fk.fromTable !== tableName && fk.toTable !== tableName) return;
    const path = edgeLayer.querySelector(`[data-edge="${i}"]`);
    const d    = edgePath(fk);
    if (path && d) path.setAttribute('d', d);
  });
}

function findTableGroup(name) {
  const all = document.querySelectorAll('[data-table]');
  for (const el of all) if (el.getAttribute('data-table') === name) return el;
  return null;
}

// ‚îÄ‚îÄ‚îÄ Zoom / Pan / Fit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateTransform() {
  document.getElementById('mainGroup').setAttribute(
    'transform',
    `translate(${pan.x.toFixed(1)},${pan.y.toFixed(1)}) scale(${zoom.toFixed(4)})`
  );
  document.getElementById('zoomDisplay').textContent = Math.round(zoom * 100) + '%';
}

function zoomStep(factor) {
  zoom = Math.min(4, Math.max(0.12, zoom * factor));
  updateTransform();
}

function fitView() {
  if (!tables.length) return;
  const canvas = document.getElementById('erdCanvas');
  const cw = canvas.clientWidth, ch = canvas.clientHeight;
  const minX = Math.min(...tables.map(t => t.x)) - 24;
  const minY = Math.min(...tables.map(t => t.y)) - 24;
  const maxX = Math.max(...tables.map(t => t.x + t.width))  + 24;
  const maxY = Math.max(...tables.map(t => t.y + t.height)) + 24;
  const contentW = maxX - minX, contentH = maxY - minY;
  if (!contentW || !contentH) return;
  zoom  = Math.min(4, Math.max(0.1, Math.min(cw / contentW, ch / contentH) * 0.9));
  pan.x = (cw - contentW * zoom) / 2 - minX * zoom;
  pan.y = (ch - contentH * zoom) / 2 - minY * zoom;
  updateTransform();
}

// Wheel zoom (zooms towards cursor)
document.getElementById('erdCanvas').addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY < 0 ? 1.12 : 1 / 1.12;
  const rect   = e.currentTarget.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const nz = Math.min(4, Math.max(0.12, zoom * factor));
  pan.x = mx - (mx - pan.x) * (nz / zoom);
  pan.y = my - (my - pan.y) * (nz / zoom);
  zoom  = nz;
  updateTransform();
}, { passive: false });

// ‚îÄ‚îÄ‚îÄ Drag & Pan via Pointer Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const erdSvg = document.getElementById('erdSvg');

erdSvg.addEventListener('pointerdown', e => {
  const tg = e.target.closest('[data-table]');
  if (tg) {
    e.preventDefault();
    try { tg.setPointerCapture(e.pointerId); } catch (_) {}
    const tname = tg.getAttribute('data-table');
    const table = tables.find(t => t.name === tname);
    dragState = { tableName: tname, startX: e.clientX, startY: e.clientY, origX: table.x, origY: table.y };
    tg.style.cursor = 'grabbing';
  } else {
    panState = { startX: e.clientX, startY: e.clientY, origX: pan.x, origY: pan.y };
    document.getElementById('erdCanvas').classList.add('panning');
  }
});

erdSvg.addEventListener('pointermove', e => {
  if (dragState) {
    e.preventDefault();
    const dx = (e.clientX - dragState.startX) / zoom;
    const dy = (e.clientY - dragState.startY) / zoom;
    const t  = tables.find(t => t.name === dragState.tableName);
    t.x = dragState.origX + dx;
    t.y = dragState.origY + dy;
    updateTableDOM(dragState.tableName);
  } else if (panState) {
    pan.x = panState.origX + (e.clientX - panState.startX);
    pan.y = panState.origY + (e.clientY - panState.startY);
    updateTransform();
  }
});

erdSvg.addEventListener('pointerup', e => {
  if (dragState) {
    const tg = findTableGroup(dragState.tableName);
    if (tg) { tg.style.cursor = 'grab'; try { tg.releasePointerCapture(e.pointerId); } catch (_) {} }
    dragState = null;
  }
  if (panState) {
    document.getElementById('erdCanvas').classList.remove('panning');
    panState = null;
  }
});

erdSvg.addEventListener('pointercancel', () => {
  dragState = panState = null;
  document.getElementById('erdCanvas').classList.remove('panning');
});

// ‚îÄ‚îÄ‚îÄ Export SVG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportSVG() {
  if (!tables.length) return;

  const minX = Math.min(...tables.map(t => t.x)) - 32;
  const minY = Math.min(...tables.map(t => t.y)) - 32;
  const maxX = Math.max(...tables.map(t => t.x + t.width))  + 32;
  const maxY = Math.max(...tables.map(t => t.y + t.height)) + 32;
  const vw   = maxX - minX, vh = maxY - minY;

  const origTfm = document.getElementById('mainGroup').getAttribute('transform');
  document.getElementById('mainGroup').setAttribute('transform', `translate(${(-minX).toFixed(1)},${(-minY).toFixed(1)})`);

  const inlineStyles = `<style>
    .tbl-shadow{fill:rgba(0,0,0,0.22)}.tbl-body{fill:#1a1a2e;stroke:#2d2d4e;stroke-width:1.5}
    .tbl-hdr-bg{fill:#7c6aff}.tbl-name{fill:#fff;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700}
    .tbl-divider{stroke:#2d2d4e;stroke-width:1}.tbl-border{fill:none;stroke:#5a4aaa;stroke-width:1.5}
    .col-stripe{fill:rgba(124,106,255,0.04)}.col-label{fill:#c0c0d8;font-family:'JetBrains Mono',monospace;font-size:11.5px}
    .col-label-pk{fill:#f0c050;font-family:'JetBrains Mono',monospace;font-size:11.5px;font-weight:600}
    .col-label-fk{fill:#9c8cff;font-family:'JetBrains Mono',monospace;font-size:11.5px}
    .col-type{fill:#888;font-family:'JetBrains Mono',monospace;font-size:10.5px}
    .col-divider{stroke:#2d2d4e;stroke-width:0.5;opacity:0.45}.fk-edge{fill:none;stroke:#7c6aff;stroke-width:1.6;opacity:0.72}
  </style>`;

  const svgContent = document.getElementById('erdSvg').innerHTML.replace(/<defs>[\s\S]*?<\/defs>/, '');
  const out = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${vw} ${vh}" width="${vw}" height="${vh}">
  <defs>
    <marker id="arr-end" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 1 1 L 9 5 L 1 9 z" fill="#7c6aff"/>
    </marker>
    <marker id="arr-start" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6">
      <circle cx="5" cy="5" r="3.5" fill="#7c6aff"/>
    </marker>
  </defs>
  ${inlineStyles}
  <rect width="${vw}" height="${vh}" fill="#13131f"/>
  ${svgContent}
</svg>`;

  document.getElementById('mainGroup').setAttribute('transform', origTfm);

  const blob = new Blob([out], { type: 'image/svg+xml' });
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement('a'), { href: url, download: 'erd.svg' });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ Main Generate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateERD() {
  const sql    = sqlInput.value.trim();
  const btn    = document.getElementById('erdBtn');
  const errDiv = document.getElementById('erdError');
  errDiv.classList.add('hidden');

  if (!sql) { errDiv.innerHTML = `<div class="error-msg">‚ö† SQL DDLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</div>`; errDiv.classList.remove('hidden'); return; }

  btn.textContent = '‚è≥ ÏÉùÏÑ± Ï§ë...';
  btn.classList.add('loading');

  setTimeout(() => {
    try {
      const result = parseDDL(sql);
      if (!result.tables.length) throw new Error('CREATE TABLE Íµ¨Î¨∏ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. DDL ÌòïÏãùÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');

      result.tables.forEach(t => {
        const { width, height } = computeDims(t);
        t.width = width; t.height = height; t.x = 0; t.y = 0;
      });

      tables      = result.tables;
      foreignKeys = result.foreignKeys;

      document.getElementById('erdSection').classList.remove('hidden');
      document.getElementById('statTables').textContent     = tables.length;
      document.getElementById('statCols').textContent       = tables.reduce((s, t) => s + t.columns.length, 0);
      document.getElementById('statFKs').textContent        = foreignKeys.length;

      doAutoLayout();

    } catch (e) {
      errDiv.innerHTML     = `<div class="error-msg">‚ùå ${esc(e.message)}</div>`;
      errDiv.classList.remove('hidden');
      document.getElementById('erdSection').classList.add('hidden');
    }
    btn.textContent = '‚ö° ÏÉùÏÑ±';
    btn.classList.remove('loading');
  }, 50);
}

// Ctrl/Cmd + Enter
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generateERD();
});
</script>
</body>
</html>
