<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cron Builder | Dev Tools</title>
<script src="../tools.js"></script>
<script src="../nav.js"></script>
<script src="../ui-utils.js"></script>
<link rel="stylesheet" href="../styles.css">
<style>
.form-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
  padding: 12px 20px 2px;
}
.form-item label {
  display: block;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
}
.form-item select,
.form-item input {
  width: 100%;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  padding: 8px 10px;
}
.result-box {
  margin: 12px 20px 16px;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  font-family: 'JetBrains Mono', monospace;
}
.cron-line {
  font-size: 14px;
  color: var(--accent);
  margin-bottom: 8px;
  word-break: break-all;
}
.human-line {
  font-size: 11px;
  color: var(--text);
  line-height: 1.6;
}
</style>
</head>
<body>
<script>renderNav();</script>

<div class="container">
  <div class="tool-header">
    <h1>Cron <span>Builder</span></h1>
    <p>// cron 식 생성 + 자연어 해석 (Linux 5-field 기준)</p>
  </div>

  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title"><div class="dot"></div>BUILDER</div>
        </div>

        <div class="form-grid">
          <div class="form-item">
            <label>Preset</label>
            <select id="preset" onchange="applyPreset()">
              <option value="custom">Custom</option>
              <option value="every5">Every 5 minutes</option>
              <option value="hourly">Every hour</option>
              <option value="daily9">Daily 09:00</option>
              <option value="weekday9">Weekdays 09:00</option>
              <option value="weeklyMon9">Every Monday 09:00</option>
              <option value="monthly1">1st of month 09:00</option>
            </select>
          </div>
          <div class="form-item">
            <label>Minute</label>
            <input id="min" value="*" placeholder="0-59, *, */5">
          </div>
          <div class="form-item">
            <label>Hour</label>
            <input id="hour" value="*" placeholder="0-23, *">
          </div>
          <div class="form-item">
            <label>Day of Month</label>
            <input id="dom" value="*" placeholder="1-31, *">
          </div>
          <div class="form-item">
            <label>Month</label>
            <input id="mon" value="*" placeholder="1-12, *">
          </div>
          <div class="form-item">
            <label>Day of Week</label>
            <input id="dow" value="*" placeholder="0-6 (0=Sun), *">
          </div>
        </div>

        <div class="options-bar" style="border-top:none;padding-top:0;">
          <button class="generate-btn" onclick="buildCron()">⚡ GENERATE</button>
        </div>
      </div>
    </div>

    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="empty-state">
          <div class="icon">⏰</div>
          <p>프리셋 선택 또는 값 입력 후 GENERATE</p>
        </div>
      </div>
    </div>
  </div>

  <footer>// Cron Builder — generate and humanize schedules</footer>
</div>

<script>
const DOW_NAME = ['일', '월', '화', '수', '목', '금', '토'];

const escHtml = UIUtils.escHtml;

function setFields(min, hour, dom, mon, dow) {
  document.getElementById('min').value = min;
  document.getElementById('hour').value = hour;
  document.getElementById('dom').value = dom;
  document.getElementById('mon').value = mon;
  document.getElementById('dow').value = dow;
}

function applyPreset() {
  const p = document.getElementById('preset').value;
  if (p === 'every5') setFields('*/5', '*', '*', '*', '*');
  else if (p === 'hourly') setFields('0', '*', '*', '*', '*');
  else if (p === 'daily9') setFields('0', '9', '*', '*', '*');
  else if (p === 'weekday9') setFields('0', '9', '*', '*', '1-5');
  else if (p === 'weeklyMon9') setFields('0', '9', '*', '*', '1');
  else if (p === 'monthly1') setFields('0', '9', '1', '*', '*');
}

function validPart(v, re) { return re.test(v); }

function validateCron(min, hour, dom, mon, dow) {
  const atom = '(\\*|\\d+|\\*/\\d+|\\d+-\\d+|\\d+(,\\d+)+)';
  const re = new RegExp('^' + atom + '$');
  if (![min, hour, dom, mon, dow].every(v => validPart(v, re))) {
    throw new Error('형식 오류: *, 숫자, */n, a-b, a,b 형식만 지원합니다.');
  }
}

function humanize(min, hour, dom, mon, dow) {
  if (min.startsWith('*/') && hour === '*' && dom === '*' && mon === '*' && dow === '*') {
    return `${min.slice(2)}분마다 실행`;
  }
  if (min === '0' && hour === '*' && dom === '*' && mon === '*' && dow === '*') {
    return '매시 정각 실행';
  }
  if (dom === '*' && mon === '*' && dow === '*' && /^\d+$/.test(hour) && /^\d+$/.test(min)) {
    return `매일 ${hour.padStart(2, '0')}:${min.padStart(2, '0')} 실행`;
  }
  if (dow === '1-5' && /^\d+$/.test(hour) && /^\d+$/.test(min)) {
    return `평일 ${hour.padStart(2, '0')}:${min.padStart(2, '0')} 실행`;
  }
  if (/^\d+$/.test(dow) && /^\d+$/.test(hour) && /^\d+$/.test(min)) {
    const d = DOW_NAME[Number(dow)] || dow;
    return `매주 ${d}요일 ${hour.padStart(2, '0')}:${min.padStart(2, '0')} 실행`;
  }
  if (/^\d+$/.test(dom) && mon === '*' && /^\d+$/.test(hour) && /^\d+$/.test(min)) {
    return `매월 ${dom}일 ${hour.padStart(2, '0')}:${min.padStart(2, '0')} 실행`;
  }
  return '사용자 지정 스케줄';
}

function buildCron() {
  const min = document.getElementById('min').value.trim();
  const hour = document.getElementById('hour').value.trim();
  const dom = document.getElementById('dom').value.trim();
  const mon = document.getElementById('mon').value.trim();
  const dow = document.getElementById('dow').value.trim();
  const output = document.getElementById('outputPanel');

  try {
    validateCron(min, hour, dom, mon, dow);
    const expr = `${min} ${hour} ${dom} ${mon} ${dow}`;
    const human = humanize(min, hour, dom, mon, dow);

    output.innerHTML = `
      <div class="panel">
        <div class="result-box">
          <div class="cron-line">${escHtml(expr)}</div>
          <div class="human-line">${escHtml(human)}</div>
          <div style="margin-top:10px;">
            <button class="copy-btn" onclick="copyExpr('${escHtml(expr)}')">COPY</button>
          </div>
        </div>
      </div>`;
  } catch (e) {
    output.innerHTML = `<div class="error-msg">❌ ${escHtml(e.message)}</div>`;
  }
}

function copyExpr(expr) {
  navigator.clipboard.writeText(expr).then(() => {
    // no-op
  });
}

document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') buildCron();
});
</script>
</body>
</html>
