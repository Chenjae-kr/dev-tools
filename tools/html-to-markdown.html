<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTML → Markdown | Dev Tools</title>
<script src="../tools.js"></script>
<script src="../nav.js"></script>
<script src="../ui-utils.js"></script>
<link rel="stylesheet" href="../styles.css">
<style>
.txt{width:100%;min-height:220px;background:transparent;border:1px solid var(--border);outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;padding:12px;border-radius:8px;resize:vertical}
.setting-group{margin:10px 14px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface2)}
.setting-title{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:10px;text-transform:uppercase}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header"><h1>HTML <span>→</span> Markdown</h1><p>// HTML 코드를 Markdown으로 변환</p></div>
  <div class="main-grid">
    <div>
      <div class="panel"><div class="panel-header"><div class="panel-title"><div class="dot"></div>INPUT</div></div>
        <div class="setting-group">
          <div class="setting-title">Source</div>
          <div class="options-bar" style="border-top:none;padding-top:0;gap:8px;flex-wrap:wrap;">
            <input id="htmlFile" type="file" accept=".html,.htm,text/html">
            <button class="toggle-btn" onclick="loadSample()">샘플 불러오기</button>
          </div>
          <textarea id="htmlInput" class="txt" placeholder="<h1>Hello</h1><p><strong>World</strong></p>"></textarea>
        </div>
        <div class="setting-group">
          <div class="setting-title">Convert</div>
          <div class="options-bar" style="border-top:none;padding-top:0;gap:8px;flex-wrap:wrap;">
            <button class="generate-btn" onclick="convertNow()">⚡ 변환</button>
            <button class="toggle-btn" onclick="copyOut()">COPY</button>
            <button class="toggle-btn" onclick="downloadOut()">⬇ .md 다운로드</button>
          </div>
        </div>
      </div>
    </div>
    <div class="output-panel" id="outPanel">
      <div class="panel"><div class="empty-state"><div class="icon">MD</div><p>HTML 입력 후 변환</p></div></div>
    </div>
  </div>
  <footer>// HTML to Markdown Converter</footer>
</div>
<script>
let lastMd='';
const esc=UIUtils.escHtml;

document.getElementById('htmlFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ document.getElementById('htmlInput').value = ev.target.result || ''; };
  r.readAsText(f, 'utf-8');
});

function loadSample(){
  document.getElementById('htmlInput').value = `<h1>제목</h1>\n<p>이것은 <strong>굵게</strong> 와 <em>기울임</em>이 있는 문장입니다.</p>\n<ul><li>첫째</li><li>둘째</li></ul>\n<pre><code>console.log('hello')</code></pre>`;
}

function textOf(node){ return (node.textContent||'').replace(/\s+/g,' ').trim(); }

function inlineToMd(el){
  if(el.nodeType===3) return el.nodeValue || '';
  if(el.nodeType!==1) return '';
  const tag=el.tagName.toLowerCase();
  const inner=[...el.childNodes].map(inlineToMd).join('');
  if(tag==='strong' || tag==='b') return `**${inner}**`;
  if(tag==='em' || tag==='i') return `*${inner}*`;
  if(tag==='code') return `\`${textOf(el)}\``;
  if(tag==='a') return `[${inner||textOf(el)}](${el.getAttribute('href')||''})`;
  if(tag==='br') return '  \n';
  if(tag==='img') return `![${el.getAttribute('alt')||''}](${el.getAttribute('src')||''})`;
  return inner;
}

function blockToMd(el, depth=0){
  if(el.nodeType===3){
    const t=(el.nodeValue||'').trim();
    return t?`${t}\n\n`:'';
  }
  if(el.nodeType!==1) return '';
  const tag=el.tagName.toLowerCase();
  if(tag==='h1') return `# ${textOf(el)}\n\n`;
  if(tag==='h2') return `## ${textOf(el)}\n\n`;
  if(tag==='h3') return `### ${textOf(el)}\n\n`;
  if(tag==='h4') return `#### ${textOf(el)}\n\n`;
  if(tag==='h5') return `##### ${textOf(el)}\n\n`;
  if(tag==='h6') return `###### ${textOf(el)}\n\n`;
  if(tag==='p') return `${[...el.childNodes].map(inlineToMd).join('').trim()}\n\n`;
  if(tag==='blockquote') return `${textOf(el).split('\n').map(l=>`> ${l}`).join('\n')}\n\n`;
  if(tag==='pre'){
    const code=el.querySelector('code');
    const lang=(code&&code.className||'').replace(/^language-/,'');
    const txt=code?code.textContent:el.textContent;
    return `\`\`\`${lang}\n${(txt||'').replace(/^\n+|\n+$/g,'')}\n\`\`\`\n\n`;
  }
  if(tag==='ul'){
    const items=[...el.children].filter(x=>x.tagName.toLowerCase()==='li').map(li=>`${'  '.repeat(depth)}- ${[...li.childNodes].map(inlineToMd).join('').trim()}`);
    return items.join('\n')+'\n\n';
  }
  if(tag==='ol'){
    const items=[...el.children].filter(x=>x.tagName.toLowerCase()==='li').map((li,i)=>`${'  '.repeat(depth)}${i+1}. ${[...li.childNodes].map(inlineToMd).join('').trim()}`);
    return items.join('\n')+'\n\n';
  }
  if(tag==='table'){
    const rows=[...el.querySelectorAll('tr')].map(tr=>[...tr.children].map(c=>textOf(c)));
    if(!rows.length) return '';
    const head=rows[0];
    const sep=head.map(()=> '---');
    const body=rows.slice(1);
    let out=`| ${head.join(' | ')} |\n| ${sep.join(' | ')} |\n`;
    body.forEach(r=>{ out += `| ${head.map((_,i)=>r[i]||'').join(' | ')} |\n`; });
    return out+'\n';
  }
  if(tag==='hr') return `---\n\n`;
  if(tag==='div' || tag==='section' || tag==='article' || tag==='main' || tag==='body'){
    return [...el.childNodes].map(n=>blockToMd(n, depth)).join('');
  }
  return `${[...el.childNodes].map(inlineToMd).join('').trim()}\n\n`;
}

function htmlToMarkdown(html){
  const parser=new DOMParser();
  const doc=parser.parseFromString(html, 'text/html');
  const root=doc.body;
  let md=[...root.childNodes].map(n=>blockToMd(n)).join('');
  md=md.replace(/\n{3,}/g,'\n\n').trim()+"\n";
  return md;
}

function convertNow(){
  const html=document.getElementById('htmlInput').value.trim();
  if(!html){ UIUtils.showError('outPanel','HTML 입력이 비어 있습니다.'); return; }
  try{
    const md=htmlToMarkdown(html);
    lastMd=md;
    const id='md_'+Date.now();
    document.getElementById('outPanel').innerHTML = UIUtils.renderSqlBlock({
      badge:'MARKDOWN',
      tag:'Converted',
      copyBtnId:`copy_${id}`,
      copyLabel:'COPY',
      copyHandler:`UIUtils.copyElementText('${id}','copy_${id}','COPY')`,
      bodyHtml:`<pre class="sql-code" id="${id}">${esc(md)}</pre>`
    });
  }catch(e){ UIUtils.showError('outPanel', e.message||String(e)); }
}

function copyOut(){ if(!lastMd) return; navigator.clipboard.writeText(lastMd); }
function downloadOut(){
  if(!lastMd) return;
  const blob=new Blob([lastMd],{type:'text/markdown;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`converted_${Date.now()}.md`; a.click(); URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>