<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instagram Card News Maker | Dev Tools</title>
<script src="../tools.js"></script>
<script src="../nav.js"></script>
<script src="../ui-utils.js"></script>
<script src="../image-tools-utils.js"></script>
<link rel="stylesheet" href="../styles.css">
<style>
.canvas-wrap{display:flex;justify-content:center;align-items:center;padding:14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border)}
#cardCanvas{max-width:100%;height:auto;border-radius:8px;background:#fff}
.input-area{width:100%;background:transparent;border:1px solid var(--border);outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;padding:10px 12px;resize:vertical;min-height:72px;border-radius:8px}
.small{max-width:90px}
.hidden{display:none}
.main-grid > .output-panel{position:sticky;top:84px;align-self:start}
.main-grid > .output-panel .panel{max-height:calc(100vh - 110px);overflow:auto}
@media (max-width: 980px){.main-grid > .output-panel{position:static}.main-grid > .output-panel .panel{max-height:none;overflow:visible}}
.setting-group{margin:10px 14px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface2)}
.setting-title{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:10px;text-transform:uppercase;letter-spacing:.4px}
.setting-group .options-bar{border-top:none !important;padding:6px 0 !important;gap:8px;flex-wrap:wrap;align-items:center}
.setting-group .options-label{min-width:88px}
.control-grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;width:100%}
.control-grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;width:100%}
.quick-actions{display:flex;gap:8px;flex-wrap:wrap}
.quick-actions .toggle-btn{padding:8px 10px}
.table-dual{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 980px){.table-dual{grid-template-columns:1fr}.control-grid-4{grid-template-columns:1fr 1fr}}
@media (max-width: 640px){.control-grid-4,.control-grid-2{grid-template-columns:1fr}}
.export-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.export-btn{border:1px solid var(--border);border-radius:10px;padding:12px 14px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.export-btn.save{background:linear-gradient(135deg,#1d7a4c,#1fbf75);color:#fff;border-color:rgba(31,191,117,.45)}
.export-btn.single{background:linear-gradient(135deg,#0f4db8,#2a77ff);color:#fff;border-color:rgba(66,135,255,.45)}
.export-btn.all{background:linear-gradient(135deg,#5a3bb2,#7a5cff);color:#fff;border-color:rgba(122,92,255,.45)}
.export-btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
.export-btn:active{transform:translateY(0)}
@media (max-width: 768px){.export-actions{grid-template-columns:1fr}}
</style>
</head>
<body>
<script>renderNav();</script>
<div class="container">
  <div class="tool-header">
    <h1>Instagram <span>Card News Maker</span></h1>
    <p>// ì œëª©/ì†Œì œëª© + ë³¸ë¬¸(í…ìŠ¤íŠ¸Â·í‘œÂ·ì´ë¯¸ì§€) ì¹´ë“œë‰´ìŠ¤ ì œì‘</p>
  </div>

  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="dot"></div>SETTINGS</div></div>

        <div class="setting-group">
          <div class="setting-title">Canvas & Background</div>
          <div class="options-bar">
            <span class="options-label">Size</span>
            <div class="toggle-group">
              <button class="toggle-btn size-btn active" data-size="1:1">1:1</button>
              <button class="toggle-btn size-btn" data-size="4:5">4:5</button>
              <button class="toggle-btn size-btn" data-size="9:16">9:16</button>
            </div>
            <span class="options-label">Theme</span>
            <div class="toggle-group">
              <button class="toggle-btn theme-btn active" data-theme="navy">Navy</button>
              <button class="toggle-btn theme-btn" data-theme="blue">Blue</button>
              <button class="toggle-btn theme-btn" data-theme="green">Green</button>
            </div>
          </div>

        <div class="options-bar" style="border-top:none;padding-top:0;">
          <span class="options-label">Background</span>
          <div class="toggle-group">
            <button class="toggle-btn bgmode-btn active" data-bgmode="color">ë‹¨ìƒ‰</button>
            <button class="toggle-btn bgmode-btn" data-bgmode="image">ì´ë¯¸ì§€</button>
          </div>
          <input id="bgColor" type="color" value="#0b122b" class="table-name-input small" style="padding:4px 6px;">
          <input id="bgImageInput" type="file" accept="image/*" style="display:none">
        </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Headline & Subtitle</div>

        <div class="options-bar" style="border-top:none;padding-top:0;"><span class="options-label">Headline Line 1</span></div>
        <textarea id="titleText" class="input-area" placeholder="ì¹´ë“œë‰´ìŠ¤ ì œëª© 1ì¤„"></textarea>

        <div class="options-bar" style="border-top:none;padding-top:0;"><span class="options-label">Headline Line 2</span></div>
        <textarea id="titleText2" class="input-area" placeholder="ì¹´ë“œë‰´ìŠ¤ ì œëª© 2ì¤„"></textarea>

        <div class="options-bar" style="border-top:none;padding-top:0;">
          <span class="options-label">Headline Color</span>
          <span class="options-label">L1</span><input id="titleColor1" type="color" value="#111111" class="table-name-input small" style="padding:4px 6px;">
          <span class="options-label">L2</span><input id="titleColor2" type="color" value="#d41414" class="table-name-input small" style="padding:4px 6px;">
        </div>

        <div class="options-bar" style="border-top:none;padding-top:0;"><span class="options-label">Subtitle</span></div>
        <textarea id="subTitleText" class="input-area" placeholder="ì†Œì œëª©/ìš”ì•½"></textarea>

        <div class="options-bar" style="border-top:none;padding-top:0;">
          <span class="options-label">Label Banner</span>
          <input id="labelText" class="table-name-input" placeholder="2026ë…„ IPO ì˜ˆìƒ ì£¼ìš” ê¸°ì—…" value="2026ë…„ IPO ì˜ˆìƒ ì£¼ìš” ê¸°ì—…">
        </div>

        <div class="control-grid-4">
          <input id="h1Scale" type="number" value="100" min="60" max="180" class="table-name-input" placeholder="H1 Size%">
          <input id="h2Scale" type="number" value="100" min="60" max="180" class="table-name-input" placeholder="H2 Size%">
          <input id="subScale" type="number" value="100" min="60" max="180" class="table-name-input" placeholder="Sub Size%">
          <input id="titleY" type="number" value="8" min="2" max="30" class="table-name-input" placeholder="Top Y%">
        </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Body</div>
          <div class="options-bar" style="border-top:none;padding-top:0;">
          <span class="options-label">Body Type</span>
          <div class="toggle-group">
            <button class="toggle-btn bodytype-btn active" data-body="text">Text</button>
            <button class="toggle-btn bodytype-btn" data-body="table">Table</button>
            <button class="toggle-btn bodytype-btn" data-body="image">Image</button>
          </div>
        </div>

        <div id="bodyTextWrap">
          <div class="options-bar" style="border-top:none;padding-top:0;"><span class="options-label">Body Text</span></div>
          <textarea id="bodyText" class="input-area" placeholder="ë³¸ë¬¸ í…ìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ ì§€ì›)"></textarea>
        </div>

        <div id="bodyTableWrap" class="hidden">
          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">Input Mode</span>
            <div class="toggle-group">
              <button class="toggle-btn tblmode-btn active" data-mode="text">í…ìŠ¤íŠ¸ ì…ë ¥</button>
              <button class="toggle-btn tblmode-btn" data-mode="grid">í…Œì´ë¸” ì…ë ¥</button>
            </div>
            <span class="options-label" id="tblSepLabel">êµ¬ë¶„ì</span>
            <div class="toggle-group" id="tblSepGroup">
              <button class="toggle-btn tblsep-btn active" data-sep="auto">AUTO</button>
              <button class="toggle-btn tblsep-btn" data-sep="tab">TAB</button>
              <button class="toggle-btn tblsep-btn" data-sep="comma">CSV</button>
              <button class="toggle-btn tblsep-btn" data-sep="pipe">|</button>
            </div>
          </div>

          <div class="table-dual" id="tableDual">
            <div id="tableTextWrap">
              <textarea id="tableText" class="input-area" placeholder="ê¸°ì—…ëª…	ì˜ˆìƒê°€ì¹˜	ì£¼ìš”ì‚¬ì—…\nì¼€ì´ë±…í¬	3ì¡° 3,673ì–µ	ì¸í„°ë„·ì „ë¬¸ì€í–‰\n\në˜ëŠ” Markdown í‘œ:\n| ê¸°ì—…ëª… | ì˜ˆìƒê°€ì¹˜ | ì£¼ìš”ì‚¬ì—… |\n|---|---|---|\n| ì¼€ì´ë±…í¬ | 3ì¡° 3,673ì–µ | ì¸í„°ë„·ì „ë¬¸ì€í–‰ |"></textarea>
            </div>

            <div id="tableGridWrap" style="overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:var(--surface)"></div>
          </div>

          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">Quick Edit</span>
            <div class="quick-actions">
              <button class="toggle-btn" onclick="buildTableTemplate()">í…œí”Œë¦¿</button>
              <button class="toggle-btn" onclick="addTableRow()">í–‰ +</button>
              <button class="toggle-btn" onclick="removeTableRow()">í–‰ -</button>
              <button class="toggle-btn" onclick="addTableCol()">ì—´ +</button>
              <button class="toggle-btn" onclick="removeTableCol()">ì—´ -</button>
            </div>
          </div>
          <div class="control-grid-2">
            <input id="tblRows" type="number" value="4" min="1" max="30" class="table-name-input" placeholder="Rows">
            <input id="tblCols" type="number" value="3" min="1" max="10" class="table-name-input" placeholder="Cols">
          </div>
        </div>

        <div id="bodyImageWrap" class="hidden">
          <div class="options-bar" style="border-top:none;padding-top:0;"><span class="options-label">Body Image</span>
            <input id="bodyImageInput" type="file" accept="image/*"></div>
          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">Fit</span>
            <div class="toggle-group">
              <button class="toggle-btn imgfit-btn active" data-fit="cover">Cover</button>
              <button class="toggle-btn imgfit-btn" data-fit="contain">Contain</button>
            </div>
            <span class="options-label">Zoom%</span><input id="imgZoom" type="number" value="100" min="50" max="250" class="table-name-input small">
          </div>
          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">X%</span><input id="imgPosX" type="number" value="50" min="0" max="100" class="table-name-input small">
            <span class="options-label">Y%</span><input id="imgPosY" type="number" value="50" min="0" max="100" class="table-name-input small">
          </div>
        </div>

        <div class="options-bar" style="border-top:none;padding-top:0;">
          <span class="options-label">Body Size%</span><input id="bodyScale" type="number" value="100" min="60" max="180" class="table-name-input small">
        </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Footer & Paging</div>
          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">Footer Source</span>
            <input id="sourceText" class="table-name-input" value="ì¶œì²˜: ê´€ë ¨ ìë£Œ" placeholder="ì¶œì²˜: ...">
          </div>
          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">Watermark</span>
            <input id="brandText" class="table-name-input" value="@instagram" placeholder="@your_brand">
            <span class="options-label">Paging</span>
            <div class="toggle-group">
              <button class="toggle-btn pagewm-btn active" data-pagewm="on">ON</button>
              <button class="toggle-btn pagewm-btn" data-pagewm="off">OFF</button>
            </div>
          </div>

        <div class="options-bar" style="border-top:none;padding-top:0;">
          <span class="options-label">Pages</span>
          <input id="pageCount" type="number" value="1" min="1" max="20" class="table-name-input small">
          <button class="toggle-btn" onclick="prevPage()">â—€</button>
          <span id="pageLabel" class="options-label">1 / 1</span>
          <button class="toggle-btn" onclick="nextPage()">â–¶</button>
        </div>
        </div>

        <div class="setting-group">
          <div class="setting-title">Export</div>
          <div class="options-bar" style="border-top:none;padding-top:0;">
            <span class="options-label">Format</span>
            <div class="toggle-group">
              <button class="toggle-btn exfmt-btn active" data-fmt="png">PNG</button>
              <button class="toggle-btn exfmt-btn" data-fmt="jpeg">JPG</button>
              <button class="toggle-btn exfmt-btn" data-fmt="webp">WEBP</button>
            </div>
            <span class="options-label">Quality</span>
            <input id="imgQuality" type="number" value="92" min="1" max="100" class="table-name-input small">
          </div>
          <div class="export-actions">
            <button class="export-btn save" onclick="savePage()">ğŸ’¾ í˜ì´ì§€ ì €ì¥</button>
            <button class="export-btn single" onclick="downloadCurrent()">â¬‡ í˜„ì¬ ë‹¤ìš´ë¡œë“œ</button>
            <button class="export-btn all" onclick="downloadAll()">â¬‡ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="output-panel">
      <div class="panel">
        <div class="canvas-wrap"><canvas id="cardCanvas" width="1080" height="1080"></canvas></div>
      </div>
    </div>
  </div>
  <footer>// Instagram Card News Maker</footer>
</div>

<script>
const sizes = { '1:1':[1080,1080], '4:5':[1080,1350], '9:16':[1080,1920] };
const themes = {
  navy:{bg:'#0b122b',box:'#ffffff',accent:'#d41414',text:'#0b122b',sub:'#1a2b5f'},
  blue:{bg:'#102c6d',box:'#ffffff',accent:'#0a52cc',text:'#111',sub:'#1f376e'},
  green:{bg:'#0f2f24',box:'#ffffff',accent:'#0a7a4f',text:'#111',sub:'#24443a'}
};
let sizeKey='1:1', themeKey='navy', bgMode='color', bgImage=null;
let page=1, pages=[{}], bodyType='text';
let exportFormat='png';
let tableSepMode='auto';
let tableInputMode='text';

function newPage(){ return {title:'',title2:'',subtitle:'',label:'',source:'ì¶œì²˜: ê´€ë ¨ ìë£Œ',brand:'@instagram',showPage:true,h1Scale:100,h2Scale:100,subScale:100,titleY:8,bodyScale:100,bodyType:'text',bodyText:'',tableText:'',bodyImageData:'',imgFit:'cover',imgZoom:100,imgPosX:50,imgPosY:50}; }
function getCanvas(){return document.getElementById('cardCanvas');}
function current(){return pages[page-1] || newPage();}
function setPageLabel(){document.getElementById('pageLabel').textContent=`${page} / ${pages.length}`;document.getElementById('pageCount').value=pages.length;}

function setBodyUI(){
  document.getElementById('bodyTextWrap').classList.toggle('hidden', bodyType!=='text');
  document.getElementById('bodyTableWrap').classList.toggle('hidden', bodyType!=='table');
  document.getElementById('bodyImageWrap').classList.toggle('hidden', bodyType!=='image');
}

function fillInputsFromPage(){
  const p=current();
  document.getElementById('titleText').value=p.title||'';
  document.getElementById('titleText2').value=p.title2||'';
  document.getElementById('subTitleText').value=p.subtitle||'';
  document.getElementById('labelText').value=p.label||'';
  document.getElementById('bodyText').value=p.bodyText||'';
  document.getElementById('tableText').value=p.tableText||'';
  document.getElementById('h1Scale').value=p.h1Scale ?? 100;
  document.getElementById('h2Scale').value=p.h2Scale ?? 100;
  document.getElementById('subScale').value=p.subScale ?? 100;
  document.getElementById('titleY').value=p.titleY ?? 8;
  document.getElementById('bodyScale').value=p.bodyScale ?? 100;
  document.getElementById('sourceText').value=p.source||'ì¶œì²˜: ê´€ë ¨ ìë£Œ';
  document.getElementById('brandText').value=p.brand||'@instagram';
  const pagewm = p.showPage === false ? 'off' : 'on';
  document.querySelectorAll('.pagewm-btn').forEach(b=>b.classList.toggle('active', b.dataset.pagewm===pagewm));
  document.getElementById('imgZoom').value=p.imgZoom ?? 100;
  document.getElementById('imgPosX').value=p.imgPosX ?? 50;
  document.getElementById('imgPosY').value=p.imgPosY ?? 50;
  const fit = p.imgFit || 'cover';
  document.querySelectorAll('.imgfit-btn').forEach(b=>b.classList.toggle('active', b.dataset.fit===fit));
  bodyType=p.bodyType||'text';
  document.querySelectorAll('.bodytype-btn').forEach(b=>b.classList.toggle('active', b.dataset.body===bodyType));
  setBodyUI();
}

function savePage(){
  pages[page-1]={
    ...(pages[page-1]||newPage()),
    title:document.getElementById('titleText').value,
    title2:document.getElementById('titleText2').value,
    subtitle:document.getElementById('subTitleText').value,
    label:document.getElementById('labelText').value,
    bodyType,
    source:document.getElementById('sourceText').value,
    brand:document.getElementById('brandText').value,
    showPage:(document.querySelector('.pagewm-btn.active')?.dataset.pagewm || 'on') === 'on',
    h1Scale:parseInt(document.getElementById('h1Scale').value || '100',10),
    h2Scale:parseInt(document.getElementById('h2Scale').value || '100',10),
    subScale:parseInt(document.getElementById('subScale').value || '100',10),
    titleY:parseInt(document.getElementById('titleY').value || '8',10),
    bodyScale:parseInt(document.getElementById('bodyScale').value || '100',10),
    imgFit:(document.querySelector('.imgfit-btn.active')?.dataset.fit || 'cover'),
    imgZoom:parseInt(document.getElementById('imgZoom').value || '100',10),
    imgPosX:parseInt(document.getElementById('imgPosX').value || '50',10),
    imgPosY:parseInt(document.getElementById('imgPosY').value || '50',10),
    bodyText:document.getElementById('bodyText').value,
    tableText:document.getElementById('tableText').value,
  };
}

function syncPages(){
  const n=Math.max(1,Math.min(20,parseInt(document.getElementById('pageCount').value||'1',10)));
  while(pages.length<n) pages.push(newPage());
  while(pages.length>n) pages.pop();
  if(page>pages.length) page=pages.length;
  setPageLabel();
}

function prevPage(){savePage();if(page>1) page--;fillInputsFromPage();setPageLabel();renderCard();}
function nextPage(){savePage();if(page<pages.length) page++;fillInputsFromPage();setPageLabel();renderCard();}

const fit = (ctx,text,maxW,start) => ImageToolUtils.fitTextSize(ctx, text, maxW, start, 18, 800);

function parseDelimitedLine(line, sep=','){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(q && line[i+1]==='"'){ cur+='"'; i++; }
      else q=!q;
      continue;
    }
    if(ch===sep && !q){ out.push(cur.trim()); cur=''; continue; }
    cur+=ch;
  }
  out.push(cur.trim());
  return out;
}

function parseMarkdownTable(text){
  const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const only=lines.filter(l=>l.includes('|'));
  if(only.length<2) return null;
  const isSep = l => /^[\s|:\-]+$/.test(l);
  const row = l => l.replace(/^\s*\||\|\s*$/g,'').split('|').map(c=>c.trim());
  let hi=only.findIndex(l=>!isSep(l));
  if(hi<0) return null;
  const head=row(only[hi]).filter(Boolean);
  const body=only.slice(hi+1).filter(l=>!isSep(l)).map(l=>row(l));
  if(!head.length || !body.length) return null;
  return {head, body};
}

function parseCsvTable(text){
  const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length<2) return null;

  if (tableSepMode === 'auto') {
    const md = parseMarkdownTable(text);
    if (md) return md;
  }

  let sep = ',';
  if (tableSepMode === 'tab') sep='\t';
  else if (tableSepMode === 'pipe') sep='|';
  else if (tableSepMode === 'comma') sep=',';
  else {
    const first = lines[0] || '';
    const cTab=(first.match(/\t/g)||[]).length;
    const cPipe=(first.match(/\|/g)||[]).length;
    const cComma=(first.match(/,/g)||[]).length;
    if (cTab>=cPipe && cTab>=cComma) sep='\t';
    else if (cPipe>=cComma) sep='|';
    else sep=',';
  }

  const rows=lines.map(l=>parseDelimitedLine(l, sep));
  const cols=rows[0].length;
  const normalized=rows.map(r=>{
    const x=r.slice(0,cols);
    while(x.length<cols) x.push('');
    return x;
  });
  return {head:normalized[0], body:normalized.slice(1)};
}

function setTableInputUI(){
  const textWrap = document.getElementById('tableTextWrap');
  const gridWrap = document.getElementById('tableGridWrap');
  const dual = document.getElementById('tableDual');
  const sepLabel = document.getElementById('tblSepLabel');
  const sepGroup = document.getElementById('tblSepGroup');
  dual.style.gridTemplateColumns = '1fr';

  if (tableInputMode === 'grid') {
    textWrap.classList.add('hidden');
    gridWrap.classList.remove('hidden');
    if (sepLabel) sepLabel.classList.add('hidden');
    if (sepGroup) sepGroup.classList.add('hidden');
  } else {
    textWrap.classList.remove('hidden');
    gridWrap.classList.add('hidden');
    if (sepLabel) sepLabel.classList.remove('hidden');
    if (sepGroup) sepGroup.classList.remove('hidden');
  }
}

function renderTableGrid(head, body){
  const wrap = document.getElementById('tableGridWrap');
  const cols = head.length;

  const th = `<tr>${head.map((h,i)=>`<th><input data-r="0" data-c="${i}" value="${String(h||'').replace(/"/g,'&quot;')}" class="table-name-input" style="min-width:140px"></th>`).join('')}</tr>`;
  const tr = body.map((r,ri)=>`<tr>${Array.from({length:cols},(_,ci)=>`<td><input data-r="${ri+1}" data-c="${ci}" value="${String((r&&r[ci])||'').replace(/"/g,'&quot;')}" class="table-name-input" style="min-width:140px"></td>`).join('')}</tr>`).join('');

  wrap.innerHTML = `<table style="border-collapse:collapse;min-width:100%;width:max-content"><thead>${th}</thead><tbody>${tr}</tbody></table>`;

  wrap.querySelectorAll('input').forEach(inp=>inp.addEventListener('input', ()=>syncTextFromGrid(false)));
  document.getElementById('tblCols').value = cols;
  document.getElementById('tblRows').value = body.length;
}

function syncGridFromText(doRender=true){
  const t = parseCsvTable(document.getElementById('tableText').value || '');
  if(!t) return;
  renderTableGrid(t.head, t.body);
  if (doRender) renderCard();
}

function syncTextFromGrid(doRender=true){
  const wrap = document.getElementById('tableGridWrap');
  const inputs = [...wrap.querySelectorAll('input[data-r]')];
  if(!inputs.length) return;

  const head = [];
  const bodyMap = new Map();
  for(const el of inputs){
    const r = parseInt(el.dataset.r,10);
    const c = parseInt(el.dataset.c,10);
    if(r===0) head[c]=el.value;
    else {
      if(!bodyMap.has(r)) bodyMap.set(r, []);
      bodyMap.get(r)[c]=el.value;
    }
  }
  const body = [...bodyMap.keys()].sort((a,b)=>a-b).map(k=>{
    const row = bodyMap.get(k);
    while(row.length<head.length) row.push('');
    return row;
  });

  document.getElementById('tableText').value = serializeTableData(head, body);
  if (doRender) renderCard();
}

function serializeTableData(head, body){
  const mode = tableSepMode === 'auto' ? 'tab' : tableSepMode;
  if (mode === 'pipe') {
    const sep = '|';
    const h = `| ${head.join(' | ')} |`;
    const s = `| ${head.map(()=> '---').join(' | ')} |`;
    const b = body.map(r => `| ${r.map(v=>String(v||'')).join(' | ')} |`);
    return [h, s, ...b].join('\n');
  }
  const sep = mode === 'comma' ? ',' : '\t';
  const line = arr => arr.map(v => {
    const t = String(v ?? '');
    if (sep === ',' && /[",\n]/.test(t)) return `"${t.replace(/"/g, '""')}"`;
    return t;
  }).join(sep);
  return [line(head), ...body.map(line)].join('\n');
}

function getGridMatrix(){
  const wrap = document.getElementById('tableGridWrap');
  const inputs = [...wrap.querySelectorAll('input[data-r]')];
  if(!inputs.length) return null;
  const head=[];
  const bodyMap=new Map();
  for(const el of inputs){
    const r=parseInt(el.dataset.r,10), c=parseInt(el.dataset.c,10);
    if(r===0) head[c]=el.value;
    else {
      if(!bodyMap.has(r)) bodyMap.set(r,[]);
      bodyMap.get(r)[c]=el.value;
    }
  }
  const body=[...bodyMap.keys()].sort((a,b)=>a-b).map(k=>{
    const row=bodyMap.get(k);
    while(row.length<head.length) row.push('');
    return row;
  });
  return {head, body};
}

function tableToMatrix(){
  const m = tableInputMode === 'grid' ? getGridMatrix() : null;
  if (m) {
    document.getElementById('tableText').value = serializeTableData(m.head, m.body);
    return m;
  }
  const t = parseCsvTable(document.getElementById('tableText').value || '');
  if (!t) return null;
  return { head:[...t.head], body:t.body.map(r=>[...r]) };
}

function buildTableTemplate(){
  const cols = Math.max(1, Math.min(10, parseInt(document.getElementById('tblCols').value || '3', 10)));
  const rows = Math.max(1, Math.min(30, parseInt(document.getElementById('tblRows').value || '4', 10)));
  const head = Array.from({length: cols}, (_,i)=>`ì»¬ëŸ¼${i+1}`);
  const body = Array.from({length: rows}, (_,r)=>Array.from({length: cols}, (_,c)=>`${r+1}-${c+1}`));
  document.getElementById('tableText').value = serializeTableData(head, body);
  if (tableInputMode === 'grid') syncGridFromText();
  renderCard();
}

function addTableRow(){
  const m = tableToMatrix();
  if (!m) return buildTableTemplate();
  m.body.push(Array.from({length:m.head.length}, ()=>''));
  document.getElementById('tableText').value = serializeTableData(m.head, m.body);
  if (tableInputMode === 'grid') syncGridFromText();
  renderCard();
}

function addTableCol(){
  const m = tableToMatrix();
  if (!m) return buildTableTemplate();
  m.head.push(`ì»¬ëŸ¼${m.head.length+1}`);
  m.body = m.body.map(r => [...r, '']);
  document.getElementById('tableText').value = serializeTableData(m.head, m.body);
  if (tableInputMode === 'grid') syncGridFromText();
  renderCard();
}

function removeTableRow(){
  const m = tableToMatrix();
  if (!m || m.body.length <= 1) return;
  m.body.pop();
  document.getElementById('tableText').value = serializeTableData(m.head, m.body);
  if (tableInputMode === 'grid') syncGridFromText();
  renderCard();
}

function removeTableCol(){
  const m = tableToMatrix();
  if (!m || m.head.length <= 1) return;
  m.head.pop();
  m.body = m.body.map(r => r.slice(0, m.head.length));
  document.getElementById('tableText').value = serializeTableData(m.head, m.body);
  if (tableInputMode === 'grid') syncGridFromText();
  renderCard();
}

function drawCoverImage(ctx,w,h,img){
  ImageToolUtils.drawImageCover(ctx, img, 0, 0, w, h);
}

function drawBodyImage(ctx, img, x, y, w, h, fit='cover', zoom=100, posX=50, posY=50){
  const ir = img.width / img.height;
  const cr = w / h;
  let baseW, baseH;
  if (fit === 'contain') {
    if (ir > cr) { baseW = w; baseH = w / ir; }
    else { baseH = h; baseW = h * ir; }
  } else {
    if (ir > cr) { baseH = h; baseW = h * ir; }
    else { baseW = w; baseH = w / ir; }
  }

  const z = Math.max(50, Math.min(250, zoom)) / 100;
  const dw = baseW * z;
  const dh = baseH * z;

  const px = Math.max(0, Math.min(100, posX)) / 100;
  const py = Math.max(0, Math.min(100, posY)) / 100;
  const dx = x + (w - dw) * px;
  const dy = y + (h - dh) * py;

  ctx.save();
  ctx.beginPath();
  ctx.rect(x, y, w, h);
  ctx.clip();
  ctx.drawImage(img, dx, dy, dw, dh);
  ctx.restore();
}

function drawBg(ctx,w,h){
  const th=themes[themeKey];
  if(bgMode==='image' && bgImage){
    drawCoverImage(ctx,w,h,bgImage);
    ctx.fillStyle='rgba(0,0,0,0.28)'; ctx.fillRect(0,0,w,h);
  } else {
    ctx.fillStyle=document.getElementById('bgColor').value||th.bg; ctx.fillRect(0,0,w,h);
  }
}

function renderCard(){
  savePage();
  const cv=getCanvas(); const [w,h]=sizes[sizeKey]; cv.width=w; cv.height=h; const ctx=cv.getContext('2d');
  const th=themes[themeKey]; const p=current();

  drawBg(ctx,w,h);

  // white board panel
  const margin=Math.floor(w*0.04); const panelX=margin, panelY=Math.floor(h*0.06), panelW=w-margin*2, panelH=h-panelY-Math.floor(h*0.06);
  ctx.fillStyle=th.box; ctx.fillRect(panelX,panelY,panelW,panelH);
  ctx.strokeStyle='rgba(0,0,0,0.16)'; ctx.lineWidth=2; ctx.strokeRect(panelX,panelY,panelW,panelH);

  // title lines + subtitle + label banner
  const t1=(p.title||'').trim();
  const t2=(p.title2||'').trim();
  const subLines=(p.subtitle||'').split('\n').filter(Boolean);
  const titleColor1=document.getElementById('titleColor1').value;
  const titleColor2=document.getElementById('titleColor2').value;

  const h1Scale=Math.max(60,Math.min(180,p.h1Scale||100))/100;
  const h2Scale=Math.max(60,Math.min(180,p.h2Scale||100))/100;
  const subScale=Math.max(60,Math.min(180,p.subScale||100))/100;
  const titleY=Math.max(2,Math.min(30,p.titleY||8))/100;
  const bodyScale=Math.max(60,Math.min(180,p.bodyScale||100))/100;

  let y=panelY+Math.floor(panelH*titleY);
  if (t1) {
    const fs1=fit(ctx,t1,panelW-60,Math.floor(h*0.055*h1Scale));
    ctx.font=`900 ${fs1}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
    ctx.fillStyle=titleColor1;
    ctx.textAlign='center';
    ctx.fillText(t1,panelX+panelW/2,y);
    y += Math.floor(fs1*1.08);
  }
  if (t2) {
    const fs2=fit(ctx,t2,panelW-60,Math.floor(h*0.06*h2Scale));
    ctx.font=`900 ${fs2}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
    ctx.fillStyle=titleColor2;
    ctx.fillText(t2,panelX+panelW/2,y);
    y += Math.floor(fs2*1.1);
  }

  subLines.slice(0,2).forEach(line=>{
    const fs=fit(ctx,line,panelW-100,Math.floor(h*0.03*subScale));
    ctx.font=`700 ${fs}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
    ctx.fillStyle=th.sub;
    ctx.fillText(line,panelX+panelW/2,y);
    y += Math.floor(fs*1.2);
  });

  const label=(p.label||'').trim();
  if (label) {
    const lw=Math.min(panelW*0.72, Math.max(panelW*0.34, ctx.measureText(label).width + 40));
    const lh=Math.floor(h*0.05);
    const lx=panelX + (panelW-lw)/2;
    const ly=y;
    ctx.fillStyle='#ffffff';
    ctx.fillRect(lx,ly,lw,lh);
    ctx.strokeStyle='rgba(0,0,0,0.35)';
    ctx.setLineDash([6,4]);
    ctx.strokeRect(lx,ly,lw,lh);
    ctx.setLineDash([]);
    ctx.fillStyle='#222';
    ctx.font=`700 ${Math.floor(lh*0.44)}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
    ctx.textAlign='center';
    ctx.fillText(label, lx+lw/2, ly+Math.floor(lh*0.67));
    y += lh + Math.floor(h*0.016);
  } else {
    y += Math.floor(h*0.02);
  }
  const fh = 34; // footer height reserved
  const contentX=panelX+24, contentY=y;
  const contentBottom = panelY + panelH - fh - 10;
  const rawContentW = panelW-48;
  const contentH = Math.max(120, contentBottom - contentY);


  const contentW = rawContentW;

  // body by type
  if(p.bodyType==='text'){
    ctx.fillStyle='rgba(16,38,90,0.07)'; ctx.fillRect(contentX,contentY,contentW,contentH);
    const lines=(p.bodyText||'').split('\n').filter(Boolean);
    let ty=contentY+36;
    lines.forEach(line=>{
      const fs=fit(ctx,line,contentW-30,Math.floor(h*0.03*bodyScale));
      ctx.font=`700 ${fs}px Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif`;
      ctx.fillStyle='#1b1f2a';
      ctx.textAlign='left';
      ctx.fillText(line,contentX+14,ty);
      ty += Math.floor(fs*1.45);
    });
  } else if(p.bodyType==='table'){
    const t=parseCsvTable(p.tableText||'');
    if(!t){
      ctx.fillStyle='#777'; ctx.font=`600 ${Math.floor(h*0.024)}px sans-serif`; ctx.fillText('í‘œ ë°ì´í„°(CSV)ë¥¼ ì…ë ¥í•˜ì„¸ìš”', contentX+8, contentY+40);
    } else {
      const cols=t.head.length;
      const maxRowsByHeight = Math.max(1, Math.floor(contentH / 46) - 1);
      const rows=Math.min(t.body.length, maxRowsByHeight, 12);
      const tableW = cols <= 3 ? Math.min(contentW, cols * 280) : contentW;
      const tableX = contentX + Math.floor((contentW - tableW) / 2);
      const rh=Math.floor(contentH/(rows+1)); const cw=Math.floor(tableW/cols);
      // header
      for(let c=0;c<cols;c++){
        ctx.fillStyle='#0f2f7d'; ctx.fillRect(tableX+c*cw,contentY,cw,rh);
        ctx.fillStyle='#fff'; ctx.font=`700 ${Math.floor(rh*0.34*bodyScale)}px sans-serif`; ctx.textAlign='center';
        ctx.fillText((t.head[c]||'').slice(0,14), tableX+c*cw+cw/2, contentY+Math.floor(rh*0.62));
      }
      // rows
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const y0=contentY+rh*(r+1), x0=tableX+c*cw;
          ctx.fillStyle=(r%2===0)?'#f6f8ff':'#ffffff'; ctx.fillRect(x0,y0,cw,rh);
          ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.strokeRect(x0,y0,cw,rh);
          ctx.fillStyle='#111'; ctx.font=`600 ${Math.floor(rh*0.33*bodyScale)}px sans-serif`; ctx.textAlign='center';
          const v=((t.body[r]&&t.body[r][c])||'').slice(0,16);
          ctx.fillText(v, x0+cw/2, y0+Math.floor(rh*0.6));
        }
      }
    }
  } else if(p.bodyType==='image'){
    if(p.bodyImageData){
      const img=new Image();
      img.onload=()=>{
        drawBodyImage(
          ctx, img,
          contentX, contentY, contentW, contentH,
          p.imgFit || 'cover',
          p.imgZoom ?? 100,
          p.imgPosX ?? 50,
          p.imgPosY ?? 50
        );
        ctx.strokeStyle='rgba(0,0,0,0.3)';
        ctx.strokeRect(contentX,contentY,contentW,contentH);
      };
      img.src=p.bodyImageData;
    } else {
      ctx.fillStyle='rgba(0,0,0,0.06)'; ctx.fillRect(contentX,contentY,contentW,contentH);
      ctx.fillStyle='#666'; ctx.font=`600 ${Math.floor(h*0.024)}px sans-serif`; ctx.textAlign='center';
      ctx.fillText('ë³¸ë¬¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”',contentX+contentW/2,contentY+contentH/2);
    }
  }

  // footer
  const source = (p.source || 'ì¶œì²˜: ê´€ë ¨ ìë£Œ').trim();
  const brand = (p.brand || '@instagram').trim();
  ctx.fillStyle='rgba(5,10,25,0.9)'; ctx.fillRect(panelX,panelY+panelH-fh,panelW,fh);
  ctx.fillStyle='#fff'; ctx.textAlign='left'; ctx.font='600 16px Pretendard, sans-serif'; ctx.fillText(source, panelX+12,panelY+panelH-11);
  const wmText = p.showPage === false ? `${brand}` : `${brand}  ${page}/${pages.length}`;
  ctx.textAlign='right'; ctx.font='700 18px JetBrains Mono, sans-serif'; ctx.fillText(wmText, panelX+panelW-12,panelY+panelH-11);
}

function getExportOptions(){
  const q = Math.max(1, Math.min(100, parseInt(document.getElementById('imgQuality').value || '92', 10))) / 100;
  const ext = exportFormat === 'jpeg' ? 'jpg' : exportFormat;
  return { q, ext };
}

function downloadCurrent(){
  savePage(); renderCard();
  const { q, ext } = getExportOptions();
  ImageToolUtils.downloadCanvas(getCanvas(), {
    format: ext === 'jpg' ? 'jpeg' : ext,
    quality: q,
    filename: `card_${page}_${sizeKey.replace(':','x')}`
  });
}

async function downloadAll(){
  savePage();
  const cur=page;
  const { q, ext } = getExportOptions();
  for(let i=1;i<=pages.length;i++){
    page=i; fillInputsFromPage(); renderCard();
    ImageToolUtils.downloadCanvas(getCanvas(), {
      format: ext === 'jpg' ? 'jpeg' : ext,
      quality: q,
      filename: `card_${i}_${sizeKey.replace(':','x')}`
    });
    await new Promise(r=>setTimeout(r,120));
  }
  page=cur; fillInputsFromPage(); renderCard(); setPageLabel();
}

// UI bindings
document.querySelectorAll('.size-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.size-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');sizeKey=b.dataset.size;renderCard();});
document.querySelectorAll('.theme-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.theme-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');themeKey=b.dataset.theme;document.getElementById('bgColor').value=themes[themeKey].bg;renderCard();});
document.querySelectorAll('.bgmode-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.bgmode-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');bgMode=b.dataset.bgmode;document.getElementById('bgImageInput').style.display=bgMode==='image'?'':'none';renderCard();});
document.querySelectorAll('.bodytype-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.bodytype-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');bodyType=b.dataset.body;setBodyUI();savePage();renderCard();});
document.querySelectorAll('.tblsep-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tblsep-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');tableSepMode=b.dataset.sep;if(tableInputMode==='grid') syncGridFromText();renderCard();});
document.querySelectorAll('.tblmode-btn').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.tblmode-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  tableInputMode=b.dataset.mode;
  setTableInputUI();
  if(tableInputMode==='grid') syncGridFromText();
  else syncTextFromGrid(false);
});
document.querySelectorAll('.imgfit-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.imgfit-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');savePage();renderCard();});
document.querySelectorAll('.pagewm-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.pagewm-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');savePage();renderCard();});
document.querySelectorAll('.exfmt-btn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.exfmt-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');exportFormat=b.dataset.fmt;});

['bgColor','titleText','titleText2','titleColor1','titleColor2','subTitleText','labelText','h1Scale','h2Scale','subScale','titleY','bodyScale','imgZoom','imgPosX','imgPosY','sourceText','brandText','bodyText','tableText','pageCount','imgQuality'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{
  if(id==='pageCount') syncPages();
  
  renderCard();
}));

document.getElementById('bgImageInput').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const i=new Image();i.onload=()=>{bgImage=i;renderCard();};i.src=ev.target.result;};r.readAsDataURL(f);});
document.getElementById('bodyImageInput').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{pages[page-1].bodyImageData=ev.target.result;renderCard();};r.readAsDataURL(f);});

// init
pages[0]={
  title:'ğŸ“ˆ ìƒˆí•´ ì½”ìŠ¤í”¼ëŠ” ë‚´ê°€ ì´ëˆë‹¤!',
  title2:'ì¼€ì´ë±…í¬ ìƒì¥, ê³µëª¨ê°€ í™•ì •',
  subtitle:'ì‹ ê·œ ìƒì¥ ì‹œì¥ ì „ë§ 2026',
  label:'2026ë…„ IPO ì˜ˆìƒ ì£¼ìš” ê¸°ì—…',
  source:'ì¶œì²˜: ê´€ë ¨ ì–¸ë¡ ë³´ë„',
  brand:'@instagram',
  showPage:true,
  h1Scale:100,
  h2Scale:100,
  subScale:100,
  titleY:8,
  bodyScale:100,
  bodyType:'table',
  bodyText:'',
  tableText:'ê¸°ì—…ëª…,ì˜ˆìƒê¸°ì—…ê°€ì¹˜,ì£¼ìš” ì‚¬ì—…\në¬´ì‹ ì‚¬,8ì¡°ì› ì´ìƒ,íŒ¨ì…˜ í”Œë«í¼\ní•œí™”ì—ë„ˆì§€,5ì¡°ì› ì´ìƒ,ì—ë„ˆì§€ ë°œì „Â·ê³µê¸‰\nì¼€ì´ë±…í¬,3ì¡° 3,673ì–µ,ì¸í„°ë„·ì „ë¬¸ì€í–‰',
  bodyImageData:''
};
fillInputsFromPage(); setBodyUI(); setTableInputUI(); setPageLabel(); syncGridFromText(false); renderCard();
</script>
</body>
</html>