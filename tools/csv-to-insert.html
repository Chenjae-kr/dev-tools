<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Table Data â†’ INSERT/UPSERT SQL | Dev Tools</title>
<script src="../vendor/xlsx.full.min.js"></script>
<script src="../tools.js"></script>
<script src="../nav.js"></script>
<script src="../ui-utils.js"></script>
<link rel="stylesheet" href="../styles.css">
<style>
.csv-drop-zone {
  margin: 16px 20px 0;
  border: 2px dashed var(--border);
  border-radius: 10px;
  padding: 22px 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  background: var(--bg);
}
.csv-drop-zone:hover,
.csv-drop-zone.dragover {
  border-color: var(--accent);
  background: rgba(79,255,176,0.04);
}
[data-theme="light"] .csv-drop-zone:hover,
[data-theme="light"] .csv-drop-zone.dragover {
  background: rgba(0,184,122,0.04);
}
.drop-icon { font-size: 26px; margin-bottom: 8px; opacity: 0.45; }
.drop-text {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11.5px;
  color: var(--text-muted);
  line-height: 1.7;
  margin-bottom: 12px;
}
.file-select-btn {
  padding: 5px 16px;
  border-radius: 6px;
  border: 1px solid var(--accent);
  background: transparent;
  color: var(--accent);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 0.5px;
  transition: all 0.15s;
}
.file-select-btn:hover { background: rgba(79,255,176,0.1); }
[data-theme="light"] .file-select-btn:hover { background: rgba(0,184,122,0.08); }

.csv-file-badge {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 8px 20px;
  background: rgba(79,255,176,0.06);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text);
  margin-top: 10px;
}
[data-theme="light"] .csv-file-badge { background: rgba(0,184,122,0.05); }
.csv-file-badge.visible { display: flex; }
.csv-file-badge .badge-label { color: var(--text-muted); }
.file-clear-btn {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  padding: 0 2px;
  transition: color 0.15s;
}
.file-clear-btn:hover { color: var(--accent3); }

.csv-textarea {
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.7;
  padding: 14px 20px;
  resize: none;
  tab-size: 4;
  min-height: 160px;
}
.csv-textarea::placeholder { color: var(--text-muted); }
.csv-divider {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 0 20px 8px;
}
.mapping-wrap {
  padding: 0 20px 10px;
}
.mapping-row {
  display: grid;
  grid-template-columns: 22px 1fr 1fr;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}
.mapping-input {
  width: 100%;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 6px;
  padding: 5px 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
}

.preview-wrap { overflow:auto; max-height:220px; margin:10px 0 14px; border:1px solid var(--border); border-radius:8px; }
.preview-table { width:100%; border-collapse:collapse; font-size:11px; font-family:'JetBrains Mono', monospace; }
.preview-table th { text-align:left; padding:6px; border-bottom:1px solid var(--border); }
.preview-table td { padding:6px; border-bottom:1px solid var(--border); }
.preview-table .empty { padding:8px; }
.info-gap { margin-left:8px; }
</style>
</head>
<body>

<script>renderNav();</script>

<div class="container">
  <div class="tool-header">
    <h1>Table Data <span>â†’</span> INSERT/UPSERT SQL</h1>
    <p>// convert CSV/Excel/Markdown table data into INSERT/UPSERT queries instantly</p>
  </div>

  <div class="main-grid">
    <!-- LEFT: Input Panel -->
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot"></div>
            CSV INPUT
          </div>
        </div>

        <div class="options-bar row-tight">
          <span class="options-label">Input</span>
          <div class="toggle-group">
            <button class="toggle-btn inputmode-btn active" data-input="csv">CSV</button>
            <button class="toggle-btn inputmode-btn" data-input="md">Markdown</button>
          </div>
        </div>

        <!-- Drop Zone -->
        <div class="csv-drop-zone" id="dropZone">
          <div class="drop-icon">ğŸ“„</div>
          <p class="drop-text">CSV/Excel íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜<br>ì•„ë˜ì— ì§ì ‘ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
          <button class="file-select-btn" onclick="document.getElementById('csvFileInput').click()">íŒŒì¼ ì„ íƒ</button>
          <input type="file" id="csvFileInput" accept=".csv,.tsv,.txt,.xlsx,.xls,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="hidden">
        </div>

        <!-- File Badge -->
        <div class="csv-file-badge" id="csvFileBadge">
          <span class="badge-label">FILE</span>
          <span id="csvFileName"></span>
          <span id="csvFileSize" class="text-muted"></span>
          <button class="file-clear-btn" onclick="clearFile()" title="íŒŒì¼ ì œê±°">âœ•</button>
        </div>

        <p class="csv-divider" class="mt-10">ë˜ëŠ” ì§ì ‘ ì…ë ¥</p>

        <!-- CSV Textarea -->
        <textarea class="csv-textarea" id="csvInput" placeholder="id,name,age,email
1,Alice,30,alice@example.com
2,Bob,25,bob@example.com
3,Charlie,,charlie@example.com"></textarea>

        <!-- Markdown Textarea -->
        <textarea class="csv-textarea" id="mdInput" placeholder="| user_id | username | age | email |
|---|---|---|---|
| 1 | alice | 30 | alice@example.com |
| 2 | bob | 25 | bob@example.com |"></textarea>

        <p class="csv-divider">ì»¬ëŸ¼ ë§¤í•‘ (ìƒì„± ì‹œ ìë™ ì¸ì‹)</p>
        <div class="mapping-wrap" id="mappingWrap">
          <div class="drop-text" >ì•„ì§ ë§¤í•‘ì´ ì—†ìŠµë‹ˆë‹¤. INSERT ìƒì„±ì„ ëˆ„ë¥´ë©´ ì»¬ëŸ¼ ë§¤í•‘ UIê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
        </div>

        <!-- Table Name -->
        <div class="options-bar">
          <span class="options-label">Table</span>
          <input type="text" id="tableName" class="table-name-input" placeholder="table_name">
        </div>

        <!-- Delimiter -->
        <div class="options-bar row-tight">
          <span class="options-label">Delimiter</span>
          <div class="toggle-group">
            <button class="toggle-btn delim-btn active" data-delim=",">ì½¤ë§ˆ (,)</button>
            <button class="toggle-btn delim-btn" data-delim=";">ì„¸ë¯¸ì½œë¡  (;)</button>
            <button class="toggle-btn delim-btn" data-delim="tab">íƒ­ (â†¹)</button>
          </div>
        </div>

        <!-- Dialect -->
        <div class="options-bar row-tight">
          <span class="options-label">Dialect</span>
          <div class="dialect-group">
            <button class="dialect-btn active" data-dialect="mysql">MySQL</button>
            <button class="dialect-btn" data-dialect="oracle">Oracle</button>
            <button class="dialect-btn" data-dialect="postgresql">PostgreSQL</button>
          </div>
        </div>

        <!-- Mode + NULL -->
        <div class="options-bar row-tight">
          <span class="options-label">Mode</span>
          <div class="toggle-group">
            <button class="toggle-btn mode-btn active" data-mode="individual">Individual</button>
            <button class="toggle-btn mode-btn" data-mode="bulk">Bulk</button>
          </div>
          <span class="options-label">Upsert</span>
          <div class="toggle-group">
            <button class="toggle-btn upsert-btn active" data-upsert="off">OFF</button>
            <button class="toggle-btn upsert-btn" data-upsert="on">ON</button>
          </div>
          <span class="options-label">Emptyê°’</span>
          <div class="toggle-group">
            <button class="toggle-btn null-btn active" data-null="null">NULL</button>
            <button class="toggle-btn null-btn" data-null="empty">''</button>
          </div>
        </div>

        <div class="options-bar row-tight hidden" id="upsertKeysBar">
          <span class="options-label">Conflict Keys</span>
          <input type="text" id="conflictKeys" class="table-name-input" placeholder="id ë˜ëŠ” id,email">
        </div>

        <div class="options-bar row-tight">
          <span class="options-label">Preview</span>
          <input type="number" id="previewRows" class="table-name-input input-xs" value="10" min="1" max="100">
          <span class="options-label">Chunk</span>
          <input type="number" id="chunkSize" class="table-name-input input-sm" value="1000" min="1">
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generate()">
          âš¡ INSERT ìƒì„±
        </button>
      </div>
    </div>

    <!-- RIGHT: Output Panel -->
    <div class="output-panel" id="outputPanel">
      <div class="panel">
        <div class="empty-state">
          <div class="icon">â¬…</div>
          <p>CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜<br>í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³ <br>INSERT ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</p>
        </div>
      </div>
    </div>
  </div>

  <footer>// CSV/Excel â†’ INSERT Generator â€” supports MySQL Â· Oracle Â· PostgreSQL Â· drag & drop Â· auto-detect delimiter</footer>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedDialect = 'mysql';
let insertMode = 'individual';
let nullMode = 'null';
let selectedDelim = ',';
let upsertMode = 'off';
let inputMode = 'csv';
let columnMappings = [];
let lastHeaderSignature = '';

// â”€â”€â”€ Toggle handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshUpsertUI() {
  const bar = document.getElementById('upsertKeysBar');
  const show = upsertMode === 'on';
  bar.classList.toggle('hidden', !show);
}

function refreshInputModeUI() {
  const isCSV = inputMode === 'csv';
  document.getElementById('dropZone').style.display = isCSV ? 'block' : 'none';
  document.getElementById('csvFileBadge').style.display = isCSV ? '' : 'none';
  document.querySelector('.csv-divider').textContent = isCSV ? 'ë˜ëŠ” ì§ì ‘ ì…ë ¥' : 'Markdown í…Œì´ë¸” ì…ë ¥';
  document.getElementById('csvInput').style.display = isCSV ? 'block' : 'none';
  document.getElementById('mdInput').style.display = isCSV ? 'none' : 'block';
}

function renderMappingUI() {
  const wrap = document.getElementById('mappingWrap');
  if (!columnMappings.length) {
    wrap.innerHTML = `<div class="drop-text" >ì•„ì§ ë§¤í•‘ì´ ì—†ìŠµë‹ˆë‹¤. INSERT ìƒì„±ì„ ëˆ„ë¥´ë©´ ì»¬ëŸ¼ ë§¤í•‘ UIê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>`;
    return;
  }

  wrap.innerHTML = columnMappings.map((m, idx) => `
    <div class="mapping-row">
      <input type="checkbox" ${m.include ? 'checked' : ''} onchange="toggleMappingInclude(${idx}, this.checked)">
      <input class="mapping-input" value="${escHtml(m.source)}" disabled>
      <input class="mapping-input" value="${escHtml(m.target)}" onchange="setMappingTarget(${idx}, this.value)">
    </div>
  `).join('');
}

function initMappings(headers) {
  columnMappings = headers.map(h => ({ source: h, target: h, include: true }));
  lastHeaderSignature = headers.join('\u0001');
  renderMappingUI();
}

function ensureMappings(headers) {
  const sig = headers.join('\u0001');
  if (!columnMappings.length || sig !== lastHeaderSignature || columnMappings.length !== headers.length) {
    initMappings(headers);
  }
}

function toggleMappingInclude(idx, checked) {
  if (!columnMappings[idx]) return;
  columnMappings[idx].include = checked;
}

function setMappingTarget(idx, value) {
  if (!columnMappings[idx]) return;
  columnMappings[idx].target = value.trim() || columnMappings[idx].source;
}

document.querySelectorAll('.dialect-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.dialect-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedDialect = btn.dataset.dialect;

    refreshUpsertUI();
  });
});

document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    insertMode = btn.dataset.mode;
  });
});

document.querySelectorAll('.null-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.null-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    nullMode = btn.dataset.null;
  });
});

document.querySelectorAll('.upsert-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.upsert-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    upsertMode = btn.dataset.upsert;
    refreshUpsertUI();
  });
});

document.querySelectorAll('.delim-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.delim-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedDelim = btn.dataset.delim === 'tab' ? '\t' : btn.dataset.delim;
  });
});

document.querySelectorAll('.inputmode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.inputmode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    inputMode = btn.dataset.input;
    refreshInputModeUI();
  });
});

const qMode = new URLSearchParams(location.search).get('mode');
if (qMode === 'md') {
  inputMode = 'md';
  document.querySelectorAll('.inputmode-btn').forEach(b => b.classList.remove('active'));
  const mdBtn = document.querySelector('.inputmode-btn[data-input="md"]');
  if (mdBtn) mdBtn.classList.add('active');
}

refreshUpsertUI();
renderMappingUI();
refreshInputModeUI();

// â”€â”€â”€ File Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone = document.getElementById('dropZone');
const csvFileInput = document.getElementById('csvFileInput');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) loadFile(file);
});
csvFileInput.addEventListener('change', () => {
  if (csvFileInput.files[0]) loadFile(csvFileInput.files[0]);
  csvFileInput.value = '';
});

function showLoadError(message) {
  document.getElementById('outputPanel').innerHTML = `<div class="error-msg">âŒ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜\n${escHtml(message)}</div>`;
}

function processLoadedText(file, rawText) {
  // Strip UTF-8 BOM if present
  const text = String(rawText || '').replace(/^\uFEFF/, '');
  document.getElementById('csvInput').value = text;

  // Show file badge
  const badge = document.getElementById('csvFileBadge');
  badge.classList.add('visible');
  document.getElementById('csvFileName').textContent = file.name;
  document.getElementById('csvFileSize').textContent = `(${(file.size / 1024).toFixed(1)} KB)`;

  // Auto-detect delimiter from first line
  const firstLine = text.split(/\r?\n/)[0] || '';
  const counts = {
    ',':  (firstLine.match(/,/g)  || []).length,
    ';':  (firstLine.match(/;/g)  || []).length,
    'tab':(firstLine.match(/\t/g) || []).length,
  };
  const bestKey = Object.keys(counts).reduce((a, b) => counts[a] >= counts[b] ? a : b);
  selectedDelim = bestKey === 'tab' ? '\t' : bestKey;
  document.querySelectorAll('.delim-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector(`.delim-btn[data-delim="${bestKey}"]`);
  if (activeBtn) activeBtn.classList.add('active');

  // Auto-fill table name from filename
  if (!document.getElementById('tableName').value) {
    document.getElementById('tableName').value = file.name
      .replace(/\.[^.]+$/, '')
      .replace(/[^a-zA-Z0-9_]/g, '_')
      .replace(/^_+|_+$/g, '')
      .toLowerCase();
  }
}

function loadFile(file) {
  const ext = (file.name.split('.').pop() || '').toLowerCase();
  const isExcel = ext === 'xlsx' || ext === 'xls';
  const reader = new FileReader();

  reader.onerror = () => showLoadError('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

  if (isExcel) {
    reader.onload = e => {
      try {
        const workbook = XLSX.read(e.target.result, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        if (!firstSheetName) throw new Error('ì—‘ì…€ ì‹œíŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');

        const sheet = workbook.Sheets[firstSheetName];
        const csvText = XLSX.utils.sheet_to_csv(sheet, { FS: selectedDelim || ',' });
        processLoadedText(file, csvText);
      } catch (err) {
        showLoadError(`ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${err?.message || err}`);
      }
    };
    reader.readAsArrayBuffer(file);
    return;
  }

  reader.onload = e => {
    processLoadedText(file, e.target.result || '');
  };
  reader.readAsText(file, 'UTF-8');
}

function clearFile() {
  document.getElementById('csvFileBadge').classList.remove('visible');
  document.getElementById('csvFileName').textContent = '';
  document.getElementById('csvFileSize').textContent = '';
  document.getElementById('csvInput').value = '';
  document.getElementById('tableName').value = '';
  columnMappings = [];
  lastHeaderSignature = '';
  renderMappingUI();
}

// â”€â”€â”€ Markdown Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isSeparatorRow(line) {
  return /^[\s|:\-]+$/.test(line);
}

function parseMdRow(line) {
  return line.replace(/^\s*\||\|\s*$/g, '').split('|').map(c => c.trim());
}

function parseMarkdownTable(md) {
  const lines = md.split('\n').map(l => l.trim()).filter(l => l.includes('|'));
  if (lines.length < 2) throw new Error('ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');

  let headerIdx = -1;
  for (let i = 0; i < lines.length; i++) {
    if (!isSeparatorRow(lines[i])) { headerIdx = i; break; }
  }
  if (headerIdx === -1) throw new Error('í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  const headers = parseMdRow(lines[headerIdx]).filter(Boolean);
  const dataLines = lines.slice(headerIdx + 1).filter(l => !isSeparatorRow(l));
  if (!headers.length || !dataLines.length) throw new Error('í—¤ë”/ë°ì´í„° í–‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');

  const rows = dataLines.map(line => {
    const cells = parseMdRow(line);
    const r = [];
    for (let i = 0; i < headers.length; i++) r.push(cells[i] !== undefined ? cells[i] : '');
    return r;
  });
  return { headers, rows };
}

// â”€â”€â”€ CSV Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text, delim) {
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();

  const rows = [];
  let row = [];
  let field = '';
  let inQuotes = false;
  let i = 0;

  while (i < text.length) {
    const ch = text[i];
    if (inQuotes) {
      if (ch === '"' && text[i + 1] === '"') { field += '"'; i += 2; }
      else if (ch === '"')                   { inQuotes = false; i++; }
      else                                   { field += ch; i++; }
    } else {
      if (ch === '"') {
        inQuotes = true; i++;
      } else if (text.slice(i, i + delim.length) === delim) {
        row.push(field.trim());
        field = '';
        i += delim.length;
      } else if (ch === '\n') {
        row.push(field.trim());
        field = '';
        if (row.some(f => f !== '')) rows.push(row);
        row = [];
        i++;
      } else {
        field += ch; i++;
      }
    }
  }
  // Last field / row
  row.push(field.trim());
  if (row.some(f => f !== '')) rows.push(row);

  if (rows.length < 2) throw new Error('í—¤ë” í–‰ê³¼ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');

  const headers = rows[0].map(h => h.replace(/^["']|["']$/g, ''));
  if (headers.length === 0 || headers.every(h => h === '')) throw new Error('ìœ íš¨í•œ í—¤ë” ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.');

  const dataRows = rows.slice(1).map(r => {
    const out = [];
    for (let i = 0; i < headers.length; i++) out.push(r[i] !== undefined ? r[i] : '');
    return out;
  });

  return { headers, rows: dataRows };
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const escHtml = UIUtils.escHtml;

function quoteIdent(name, dialect) {
  const n = escHtml(name);
  if (dialect === 'mysql')      return `\`${n}\``;
  if (dialect === 'oracle')     return escHtml(name.toUpperCase());
  return `"${n}"`;  // postgresql
}

function formatValue(val, dialect, useNull) {
  if (/^(null|NULL|Null|\\N)$/.test(val))
    return `<span class="kw">NULL</span>`;
  if (val === '')
    return useNull ? `<span class="kw">NULL</span>` : `<span class="ph">''</span>`;
  if (/^-?\d+$/.test(val))
    return `<span class="val">${escHtml(val)}</span>`;
  if (/^-?\d+\.\d+([eE][+-]?\d+)?$/.test(val))
    return `<span class="val">${escHtml(val)}</span>`;
  if (/^true$/i.test(val))
    return dialect === 'postgresql' ? `<span class="kw">TRUE</span>` : `<span class="val">1</span>`;
  if (/^false$/i.test(val))
    return dialect === 'postgresql' ? `<span class="kw">FALSE</span>` : `<span class="val">0</span>`;
  // String â€” SQL-escape single quotes, then HTML-escape for display
  const sql = val.replace(/'/g, "''");
  return `<span class="ph">'${escHtml(sql)}'</span>`;
}

function parseConflictKeys(headers, keyInput) {
  const keys = (keyInput || '')
    .split(',')
    .map(k => k.trim())
    .filter(Boolean);

  if (upsertMode !== 'on') return [];
  if (!keys.length) throw new Error('UPSERT ì‚¬ìš© ì‹œ Conflict Keysë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: id ë˜ëŠ” id,email)');

  const validMap = new Map(headers.map(h => [h.toLowerCase(), h]));
  return keys.map(k => {
    const hit = validMap.get(k.toLowerCase());
    if (!hit) throw new Error(`Conflict Key '${k}'ê°€ í—¤ë”ì— ì—†ìŠµë‹ˆë‹¤.`);
    return hit;
  });
}

function buildUpsertClause(headers, dialect, keyHeaders) {
  if (upsertMode !== 'on') return '';

  const nonKeyHeaders = headers.filter(h => !keyHeaders.includes(h));
  const updateHeaders = nonKeyHeaders.length ? nonKeyHeaders : headers;

  if (dialect === 'mysql') {
    const assigns = updateHeaders
      .map(h => `${quoteIdent(h, dialect)} = <span class="kw">VALUES</span>(${quoteIdent(h, dialect)})`)
      .join(', ');
    return `\n<span class="kw">ON DUPLICATE KEY UPDATE</span> ${assigns}`;
  }

  if (dialect === 'postgresql') {
    const conflictCols = keyHeaders.map(h => quoteIdent(h, dialect)).join(', ');
    const assigns = updateHeaders
      .map(h => `${quoteIdent(h, dialect)} = <span class="kw">EXCLUDED</span>.${quoteIdent(h, dialect)}`)
      .join(', ');
    return `\n<span class="kw">ON CONFLICT</span> (${conflictCols}) <span class="kw">DO UPDATE SET</span> ${assigns}`;
  }

  return '';
}

function buildOracleMergeStatement(tbl, headers, row, keyHeaders, useNull) {
  const quotedHeaders = headers.map(h => quoteIdent(h, 'oracle'));
  const sourceSelect = headers.map((h, idx) => `${formatValue(row[idx], 'oracle', useNull)} <span class="kw">AS</span> ${quoteIdent(h, 'oracle')}`).join(', ');
  const onCond = keyHeaders.map(h => `t.${quoteIdent(h, 'oracle')} = s.${quoteIdent(h, 'oracle')}`).join(' <span class="kw">AND</span> ');
  const nonKeyHeaders = headers.filter(h => !keyHeaders.includes(h));
  const updateHeaders = nonKeyHeaders.length ? nonKeyHeaders : headers;
  const updateSet = updateHeaders.map(h => `t.${quoteIdent(h, 'oracle')} = s.${quoteIdent(h, 'oracle')}`).join(', ');
  const insertVals = headers.map(h => `s.${quoteIdent(h, 'oracle')}`).join(', ');

  return `<span class="kw">MERGE INTO</span> <span class="tbl">${tbl}</span> t\n`
    + `<span class="kw">USING</span> (<span class="kw">SELECT</span> ${sourceSelect} <span class="kw">FROM</span> <span class="tbl">DUAL</span>) s\n`
    + `<span class="kw">ON</span> (${onCond})\n`
    + `<span class="kw">WHEN MATCHED THEN UPDATE SET</span> ${updateSet}\n`
    + `<span class="kw">WHEN NOT MATCHED THEN INSERT</span> (${quotedHeaders.join(', ')})\n`
    + `<span class="kw">VALUES</span> (${insertVals});`;
}

// â”€â”€â”€ Main Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generate() {
  const sourceText = (inputMode === 'csv'
    ? document.getElementById('csvInput').value
    : document.getElementById('mdInput').value).trim();
  const tableName = document.getElementById('tableName').value.trim() || 'my_table';
  const output = document.getElementById('outputPanel');
  const btn = document.getElementById('generateBtn');

  if (!sourceText) {
    output.innerHTML = `<div class="error-msg">âš  ${inputMode === 'csv' ? 'CSV ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.' : 'ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'}</div>`;
    return;
  }

  btn.textContent = 'â³ ìƒì„± ì¤‘...';
  btn.classList.add('loading');

  setTimeout(() => {
    try {
      const parsed = inputMode === 'csv'
        ? parseCSV(sourceText, selectedDelim)
        : parseMarkdownTable(sourceText);
      const { headers, rows } = parsed;
      ensureMappings(headers);

      const activeMappings = columnMappings.filter(m => m.include);
      if (!activeMappings.length) throw new Error('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì»¬ëŸ¼ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.');

      const activeIndexes = activeMappings.map(m => headers.findIndex(h => h === m.source));
      const mappedHeaders = activeMappings.map(m => m.target || m.source);
      const mappedRows = rows.map(r => activeIndexes.map(i => r[i] !== undefined ? r[i] : ''));

      const useNull = nullMode === 'null';
      const tbl = quoteIdent(tableName, selectedDialect);
      const colsHtml = mappedHeaders.map(h => `<span class="col">${quoteIdent(h, selectedDialect)}</span>`);
      const dialectLabel = { mysql: 'MySQL', oracle: 'Oracle', postgresql: 'PostgreSQL' };
      const keyHeaders = upsertMode === 'on' ? parseConflictKeys(mappedHeaders, document.getElementById('conflictKeys').value) : [];
      const upsertClause = buildUpsertClause(mappedHeaders, selectedDialect, keyHeaders);
      const previewCount = Math.max(1, Math.min(100, parseInt(document.getElementById('previewRows').value || '10', 10)));
      const chunkSize = Math.max(1, parseInt(document.getElementById('chunkSize').value || '1000', 10));

      let sqlHtml = '';

      if (upsertMode === 'on' && selectedDialect === 'oracle') {
        mappedRows.forEach((row, i) => {
          if (i > 0) sqlHtml += '\n\n';
          sqlHtml += `<span class="cmt">-- Row ${i + 1}</span>\n`;
          sqlHtml += buildOracleMergeStatement(tbl, mappedHeaders, row, keyHeaders, useNull);
        });
      } else if (insertMode === 'bulk') {
        const totalChunks = Math.ceil(mappedRows.length / chunkSize);
        for (let c = 0; c < totalChunks; c++) {
          const start = c * chunkSize;
          const end = Math.min(start + chunkSize, mappedRows.length);
          const chunkRows = mappedRows.slice(start, end);

          if (c > 0) sqlHtml += '\n\n';
          sqlHtml += `<span class="cmt">-- Bulk INSERT: ${escHtml(tableName)} ${start + 1}-${end} / ${mappedRows.length}í–‰</span>\n`;
          sqlHtml += `<span class="kw">INSERT INTO</span> <span class="tbl">${tbl}</span> (\n`;
          sqlHtml += `    ${colsHtml.join(',\n    ')}\n)\n<span class="kw">VALUES</span>\n`;
          chunkRows.forEach((row, i) => {
            const vals = row.map(v => formatValue(v, selectedDialect, useNull));
            const isLast = i === chunkRows.length - 1;
            sqlHtml += `    (${vals.join(', ')})${isLast ? '' : ','}`;
            if (!isLast) sqlHtml += `  <span class="cmt">-- row ${start + i + 1}</span>`;
            sqlHtml += '\n';
          });
          if (upsertClause) sqlHtml += upsertClause;
          sqlHtml += ';';
        }
      } else {
        mappedRows.forEach((row, i) => {
          if (i > 0) sqlHtml += '\n\n';
          sqlHtml += `<span class="cmt">-- Row ${i + 1}</span>\n`;
          sqlHtml += `<span class="kw">INSERT INTO</span> <span class="tbl">${tbl}</span> (\n`;
          sqlHtml += `    ${colsHtml.join(',\n    ')}\n)\n<span class="kw">VALUES</span> (\n`;
          const vals = row.map((v, j) =>
            `    ${formatValue(v, selectedDialect, useNull)} <span class="cmt">-- ${escHtml(mappedHeaders[j])}</span>`
          );
          sqlHtml += vals.join(',\n') + `\n)${upsertClause};`;
        });
      }

      const blockId = `block_csv_${Date.now()}`;
      const previewRows = mappedRows.slice(0, previewCount);
      const previewHead = mappedHeaders.map(h => `<th>${escHtml(h)}</th>`).join('');
      const previewBody = previewRows.map(r => `<tr>${r.map(v => `<td>${escHtml(v)}</td>`).join('')}</tr>`).join('');

      output.innerHTML = `
        <div class="panel sql-block">
          <div class="sql-block-header">
            <span class="sql-type-badge badge-insert">${upsertMode === 'on' ? 'UPSERT' : 'INSERT'}</span>
            <span class="sql-dialect-tag">${dialectLabel[selectedDialect]} Â· ${insertMode} Â· ${mappedRows.length} rows${upsertMode === 'on' ? ' Â· upsert' : ''}</span>
            <button class="copy-btn" id="copy_${blockId}" onclick="copySQL('${blockId}')">COPY ALL</button>
            <button class="copy-btn" onclick="downloadSQL('${blockId}')">DOWNLOAD .SQL</button>
          </div>
          <div class="table-info">
            <span>TABLE</span> ${escHtml(tableName)}
            <span class="info-gap">COLUMNS</span> ${mappedHeaders.length}
            <span class="info-gap">ROWS</span> ${mappedRows.length}
            <span class="info-gap">CHUNK</span> ${chunkSize}
          </div>
          <div class="preview-wrap">
            <table class="preview-table">
              <thead><tr>${previewHead}</tr></thead>
              <tbody>${previewBody || '<tr><td class="empty" colspan="99">(ë°ì´í„° ì—†ìŒ)</td></tr>'}</tbody>
            </table>
          </div>
          <pre class="sql-code" id="${blockId}">${sqlHtml}</pre>
        </div>`;

    } catch (e) {
      output.innerHTML = `<div class="error-msg">âŒ íŒŒì‹± ì˜¤ë¥˜\n${e.message}</div>`;
    }

    btn.textContent = 'âš¡ INSERT ìƒì„±';
    btn.classList.remove('loading');
  }, 10);
}

function copySQL(id) {
  UIUtils.copyElementText(id, `copy_${id}`, 'COPY ALL');
}

function downloadSQL(id) {
  const el = document.getElementById(id);
  const sql = el.innerText || el.textContent || '';
  const blob = new Blob([sql], { type: 'text/sql;charset=utf-8' });
  const a = document.createElement('a');
  const tableName = document.getElementById('tableName').value || 'export';
  const safeName = String(tableName).replace(/[^a-zA-Z0-9_\-]/g, '_');
  a.href = URL.createObjectURL(blob);
  a.download = `${safeName}_${Date.now()}.sql`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

// Ctrl/Cmd + Enter to generate
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate();
});
</script>
</body>
</html>
